name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.5.0
        
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV
        
    - name: Complete clean build
      run: |
        echo "=== Completely cleaning build environment ==="
        rm -rf .buildozer
        rm -rf bin
        rm -rf ~/.buildozer
        rm -rf ~/.gradle
        rm -rf ~/.android
        
    - name: Verify buildozer.spec and main files
      run: |
        echo "=== Checking current files ==="
        ls -la
        
        echo "=== buildozer.spec content ==="
        if [ -f "buildozer.spec" ]; then
          cat buildozer.spec
        else
          echo "No buildozer.spec found!"
        fi
        
        echo "=== main.py content ==="
        if [ -f "main.py" ]; then
          echo "main.py exists:"
          head -20 main.py
        else
          echo "No main.py found!"
        fi
        
        echo "=== main_simple.py content ==="
        if [ -f "main_simple.py" ]; then
          echo "main_simple.py exists:"
          head -10 main_simple.py
        else
          echo "No main_simple.py found!"
        fi
    
    - name: Build APK (force rebuild with Java src)
      run: |
        echo "=== Forcing full rebuild ==="
        rm -rf .buildozer bin
        mkdir -p .buildozer
        touch buildozer.spec
        buildozer android debug --verbose
          
    - name: Check build results
      run: |
        echo "=== Build Results ==="
        ls -la
        
        if [ -d "bin" ]; then
          echo "=== APK files ==="
          ls -la bin/
          for apk in bin/*.apk; do
            if [ -f "$apk" ]; then
              echo "APK file: $apk"
              file "$apk"
              echo "APK size: $(du -h "$apk")"
            fi
          done
        else
          echo "No bin directory found - build may have failed"
        fi
        
    - name: Check build logs on failure
      if: failure()
      run: |
        echo "=== Checking build logs ==="
        find .buildozer -name "*.log" -type f -exec echo "=== {} ===" \; -exec head -50 {} \; || true
        
        echo "=== Last 100 lines of build output ==="
        find .buildozer -name "*.log" -type f -exec tail -100 {} \; || true
        
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: skku-timetable-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

# ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: Java íŒŒì¼ í™•ì¸ ë° ì¤€ë¹„
    - name: Check and prepare Java files
      run: |
        echo "=== Java íŒŒì¼ í™•ì¸ ì¤‘ ==="
        if ls *.java >/dev/null 2>&1; then
          echo "âœ… Java íŒŒì¼ë“¤ ë°œê²¬:"
          ls -la *.java
          
          # Java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p src/main/java/org/kivy/skkutimetable/
          cp *.java src/main/java/org/kivy/skkutimetable/
          
          echo "âœ… Java íŒŒì¼ë“¤ ë³µì‚¬ ì™„ë£Œ:"
          ls -la src/main/java/org/kivy/skkutimetable/
        else
          echo "âš ï¸ Java íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        echo "=== buildozer.spec Java ì„¤ì • í™•ì¸ ==="
        grep -n -i "java\|source.include_exts\|android.add_java" buildozer.spec || echo "Java ê´€ë ¨ ì„¤ì • ì—†ìŒ"
    
    # ğŸ”¥ ìˆ˜ì •: ë¹Œë“œ ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥
    - name: Build APK (force rebuild with Java src)
      run: |
        echo "=== Forcing full rebuild ==="
        rm -rf .buildozer bin
        mkdir -p .buildozer
        touch buildozer.spec
        
        echo "ğŸš€ ë¹Œë“œ ì‹œì‘ ì‹œê°„: $(date)"
        
        # ğŸ”¥ í•µì‹¬: ë¹Œë“œ ë¡œê·¸ë¥¼ íŒŒì¼ë¡œ ì €ì¥
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        
        echo "ğŸ“… ë¹Œë“œ ì™„ë£Œ ì‹œê°„: $(date)"
        
        # ë¹Œë“œ ê²°ê³¼ í™•ì¸
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë§ˆì§€ë§‰ 50ì¤„ ì—ëŸ¬ ë¡œê·¸ ==="
          tail -50 build_full.log
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: ë¡œê·¸ ë¶„ì„
    - name: Analyze build logs
      if: always()  # ë¹Œë“œ ì‹¤íŒ¨í•´ë„ ì‹¤í–‰
      run: |
        echo "ğŸ” ë¹Œë“œ ë¡œê·¸ ë¶„ì„ ì¤‘..."
        
        # Java íŒŒì¼ ê´€ë ¨ ë¡œê·¸ ì¶”ì¶œ
        echo "=== Java íŒŒì¼ ì²˜ë¦¬ ë¡œê·¸ ==="
        grep -i "java\|\.java\|including.*java\|copying.*java" build_full.log > java_analysis.log || echo "Java ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
        if [ -s java_analysis.log ]; then
          echo "Java íŒŒì¼ ì²˜ë¦¬ ë¡œê·¸ ë°œê²¬:"
          cat java_analysis.log
        else
          echo "âš ï¸ Java íŒŒì¼ ì²˜ë¦¬ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."
        fi
        
        # ì—ëŸ¬ ë©”ì‹œì§€ ì¶”ì¶œ
        echo "=== ì—ëŸ¬ ë©”ì‹œì§€ ë¶„ì„ ==="
        grep -i "error\|fail\|exception\|could not\|unable to" build_full.log > error_analysis.log || echo "ì—ëŸ¬ ë©”ì‹œì§€ ì—†ìŒ"
        if [ -s error_analysis.log ]; then
          echo "ë°œê²¬ëœ ì—ëŸ¬ë“¤ (ì²« 20ê°œ):"
          head -20 error_analysis.log
        fi
        
        # APK ê´€ë ¨ ë¡œê·¸ ì¶”ì¶œ
        echo "=== APK ìƒì„± ë¡œê·¸ ==="
        grep -i "apk\|packaging\|signing\|generated.*apk" build_full.log > apk_analysis.log || echo "APK ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
        if [ -s apk_analysis.log ]; then
          echo "APK ìƒì„± ë¡œê·¸:"
          tail -10 apk_analysis.log
        fi
          
    - name: Check build results
      run: |
        echo "=== Build Results ==="
        ls -la
        
        if [ -d "bin" ]; then
          echo "=== APK files ==="
          ls -la bin/
          for apk in bin/*.apk; do
            if [ -f "$apk" ]; then
              echo "APK file: $apk"
              file "$apk"
              echo "APK size: $(du -h "$apk")"
              
              # ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: APK ë‚´ìš© í™•ì¸ (Java í´ë˜ìŠ¤ í¬í•¨ ì—¬ë¶€)
              echo "=== APK ë‚´ Java í´ë˜ìŠ¤ í™•ì¸ ==="
              unzip -l "$apk" | grep -i "\.class\|\.dex\|alarm\|receiver\|service" > apk_contents.log || echo "í´ë˜ìŠ¤ íŒŒì¼ ì—†ìŒ"
              if [ -s apk_contents.log ]; then
                echo "APK ë‚´ ê´€ë ¨ íŒŒì¼ë“¤:"
                head -20 apk_contents.log
              fi
            fi
          done
        else
          echo "No bin directory found - build may have failed"
        fi
        
    - name: Check build logs on failure
      if: failure()
      run: |
        echo "=== Checking build logs ==="
        find .buildozer -name "*.log" -type f -exec echo "=== {} ===" \; -exec head -50 {} \; || true
        
        echo "=== Last 100 lines of build output ==="
        find .buildozer -name "*.log" -type f -exec tail -100 {} \; || true

    # ğŸ”¥ ìƒˆë¡œ ì¶”ê°€: ëª¨ë“  ë¡œê·¸ íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ê´€ê³„ì—†ì´ í•­ìƒ ì—…ë¡œë“œ
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          java_analysis.log
          error_analysis.log
          apk_analysis.log
          apk_contents.log
          .buildozer/**/*.log
        retention-days: 30
        if-no-files-found: warn
        
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: skku-timetable-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

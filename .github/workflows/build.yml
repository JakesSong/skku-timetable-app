name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # âœ… ì™„ì „í•œ í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== ğŸ§¹ Completely cleaning build environment ==="
        rm -rf .buildozer bin build android/build android/.gradle
        rm -rf ~/.buildozer ~/.gradle ~/.android
        echo "âœ… ëª¨ë“  ìºì‹œ ì œê±° ì™„ë£Œ"

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev aapt libxml2-utils

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.4.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜
    - name: Install APK modification tools
      run: |
        echo "=== ğŸ› ï¸ APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜ ==="
        
        # Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ì„¤ì¹˜
        echo "ğŸ“¥ Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
        mkdir -p ~/android-sdk
        cd ~/android-sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ANDROID_HOME ì¶”ê°€!)
        export ANDROID_SDK_ROOT=~/android-sdk
        export ANDROID_HOME=~/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/build-tools/34.0.0
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH
        
        # SDK ë¼ì´ì„¼ìŠ¤ ìë™ ë™ì˜
        yes | sdkmanager --licenses || true
        
        # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (platforms ì¶”ê°€!)
        echo "ğŸ”§ Android SDK íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
        sdkmanager "build-tools;34.0.0" "platform-tools" "platforms;android-33"
        
        # ì„¤ì¹˜ í™•ì¸
        echo "ğŸ“‹ ì„¤ì¹˜ í™•ì¸:"
        ls -la ~/android-sdk/platforms/ || echo "platforms ë””ë ‰í† ë¦¬ ì—†ìŒ"
        if [ -f "~/android-sdk/platforms/android-33/android.jar" ]; then
          echo "âœ… android.jar ë°œê²¬"
        else
          echo "âŒ android.jar ì—†ìŒ"
        fi
        
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    # âœ… ë¹Œë“œ ìˆ˜í–‰
    - name: Build APK with buildozer
      run: |
        echo "=== ğŸ”¨ Buildozer APK ë¹Œë“œ ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # âœ… APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦
    - name: Find and verify APK
      run: |
        echo "=== ğŸ” APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦ ==="
        
        # APK íŒŒì¼ ìë™ íƒì§€
        POSSIBLE_APKS=(
          "./bin/doublecheck-0.1-arm64-v8a-debug.apk"
          "./bin/*.apk"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/outputs/apk/debug/*.apk"
        )
        
        FOUND_APK=""
        for apk_pattern in "${POSSIBLE_APKS[@]}"; do
          for apk_file in $apk_pattern; do
            if [ -f "$apk_file" ]; then
              FOUND_APK="$apk_file"
              echo "âœ… APK ë°œê²¬: $FOUND_APK"
              break 2
            fi
          done
        done
        
        if [ -z "$FOUND_APK" ]; then
          FOUND_APK=$(find . -name "*debug*.apk" -type f | head -1)
          if [ -n "$FOUND_APK" ]; then
            echo "âœ… ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ APK ë°œê²¬: $FOUND_APK"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi
        fi
        
        echo "ORIGINAL_APK=$FOUND_APK" >> $GITHUB_ENV
        echo "ğŸ“Š APK í¬ê¸°: $(du -h "$FOUND_APK" | cut -f1)"
        
        # ì›ë³¸ APK ìœ íš¨ì„± ê²€ì‚¬
        if aapt dump badging "$FOUND_APK" >/dev/null 2>&1; then
          echo "âœ… ì›ë³¸ APK êµ¬ì¡° ìœ íš¨"
        else
          echo "âŒ ì›ë³¸ APK êµ¬ì¡° ì˜¤ë¥˜"
          exit 1
        fi

    # âœ… APK ìˆ˜ì • (ZIP ë°©ì‹ìœ¼ë¡œ ì§ì ‘ êµì²´ - ì™„ì „ ë””ë²„ê¹…!)
    - name: Modify APK with complete debugging
      run: |
        echo "=== ğŸ”§ APK ìˆ˜ì • (ZIP ì§ì ‘ ë°©ì‹ìœ¼ë¡œ AlarmReceiver ì¶”ê°€) ==="
        
        if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
          echo "âŒ ì›ë³¸ APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ¯ ëŒ€ìƒ APK: $ORIGINAL_APK"
        
        # ë°±ì—… ìƒì„±
        cp "$ORIGINAL_APK" original_backup.apk
        echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
        
        # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p zip_work
        cd zip_work
        
        # APKë¥¼ ZIPìœ¼ë¡œ ì²˜ë¦¬
        cp "../$ORIGINAL_APK" work.apk
        
        # 1. í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
        unzip -j work.apk AndroidManifest.xml
        echo "ğŸ“„ ì›ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ"
        
        # 2. aapt dumpë¥¼ ì‚¬ìš©í•´ì„œ XML í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        aapt dump xmltree work.apk AndroidManifest.xml > manifest_text.txt
        echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ë³€í™˜ ì™„ë£Œ"
        echo "í˜„ì¬ receiver ê°œìˆ˜: $(grep -c "receiver" manifest_text.txt || echo "0")"
        
        # 3. í…œí”Œë¦¿ íŒŒì¼ ë””ë²„ê¹… ë° ì²˜ë¦¬ (í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜ ì¶”ê°€!)
        if [ -f "../AndroidManifest.tmpl.xml" ]; then
          echo "âœ… í…œí”Œë¦¿ íŒŒì¼ ë°œê²¬"
          echo "ğŸ“„ í…œí”Œë¦¿ íŒŒì¼ ë‚´ìš© í™•ì¸:"
          echo "í¬ê¸°: $(wc -l < ../AndroidManifest.tmpl.xml) ì¤„"
          echo "receiver ê°œìˆ˜: $(grep -c "receiver" ../AndroidManifest.tmpl.xml || echo "0")"
          echo "AlarmReceiver ì¡´ì¬: $(grep -c "AlarmReceiver" ../AndroidManifest.tmpl.xml || echo "0")"
          echo "í…œí”Œë¦¿ ì²« 10ì¤„:"
          head -10 ../AndroidManifest.tmpl.xml
          
          # í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜!
          cp "../AndroidManifest.tmpl.xml" new_manifest_text.xml
          
          echo "ğŸ”§ í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜ ì¤‘..."
          sed -i 's/{{ args.package }}/org.kivy.skkutimetable.doublecheck/g' new_manifest_text.xml
          sed -i 's/{{ args.numeric_version }}/1/g' new_manifest_text.xml
          sed -i 's/{{ args.version }}/0.1/g' new_manifest_text.xml
          
          echo "âœ… í…œí”Œë¦¿ ë³€ìˆ˜ ì¹˜í™˜ ì™„ë£Œ"
          echo "ìˆ˜ì •ëœ ì²« 10ì¤„:"
          head -10 new_manifest_text.xml
          
        else
          echo "âŒ í…œí”Œë¦¿ ì—†ìŒ - ì›ë³¸ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬"
          echo "ğŸ“ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ íŒŒì¼ë“¤ í™•ì¸:"
          ls -la ../ | grep -i manifest || echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê´€ë ¨ íŒŒì¼ ì—†ìŒ"
          
          # ì›ë³¸ ê¸°ë°˜ìœ¼ë¡œ ë³µì‚¬
          cp AndroidManifest.xml new_manifest_text.xml
          
          # echoë¡œ ê¸°ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¬ìƒì„±
          echo '<?xml version="1.0" encoding="utf-8"?>' > new_manifest_text.xml
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="org.kivy.skkutimetable.doublecheck" android:versionCode="1" android:versionName="0.1">' >> new_manifest_text.xml
          echo '  <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />' >> new_manifest_text.xml
          echo '  <uses-permission android:name="android.permission.WAKE_LOCK" />' >> new_manifest_text.xml
          echo '  <uses-permission android:name="android.permission.VIBRATE" />' >> new_manifest_text.xml
          echo '  <uses-permission android:name="android.permission.INTERNET" />' >> new_manifest_text.xml
          echo '  <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />' >> new_manifest_text.xml
          echo '  <application android:label="DoubleCheck">' >> new_manifest_text.xml
          echo '    <activity android:name="org.kivy.android.PythonActivity" android:label="DoubleCheck" android:exported="true">' >> new_manifest_text.xml
          echo '      <intent-filter>' >> new_manifest_text.xml
          echo '        <action android:name="android.intent.action.MAIN" />' >> new_manifest_text.xml
          echo '        <category android:name="android.intent.category.LAUNCHER" />' >> new_manifest_text.xml
          echo '      </intent-filter>' >> new_manifest_text.xml
          echo '    </activity>' >> new_manifest_text.xml
          echo '    <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">' >> new_manifest_text.xml
          echo '      <intent-filter>' >> new_manifest_text.xml
          echo '        <action android:name="android.intent.action.BOOT_COMPLETED" />' >> new_manifest_text.xml
          echo '      </intent-filter>' >> new_manifest_text.xml
          echo '    </receiver>' >> new_manifest_text.xml
          echo '  </application>' >> new_manifest_text.xml
          echo '</manifest>' >> new_manifest_text.xml
          echo "ğŸ“„ ê¸°ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ"
        fi
        
        # 4. receiver ì¶”ê°€ (í…œí”Œë¦¿ì— ì—†ëŠ” ê²½ìš°ë§Œ)
        if ! grep -q "AlarmReceiver" new_manifest_text.xml; then
          echo "ğŸ“ AlarmReceiver ì¶”ê°€ ì¤‘..."
          sed -i 's|</application>|    <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true"><intent-filter><action android:name="android.intent.action.BOOT_COMPLETED" /></intent-filter></receiver></application>|' new_manifest_text.xml
        else
          echo "âœ… AlarmReceiver ì´ë¯¸ ì¡´ì¬"
        fi
        
        echo "ğŸ“„ ìˆ˜ì •ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ receiver ê°œìˆ˜: $(grep -c "AlarmReceiver" new_manifest_text.xml || echo "0")"
        
        # 5. ì™„ì „í•œ aapt ë””ë²„ê¹…!
        echo "ğŸ”„ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì¤‘..."
        
        # aapt ëª…ë ¹ì–´ ì™„ì „ ë””ë²„ê¹…
        echo "ğŸ”§ aapt ëª…ë ¹ì–´ ì‹¤í–‰ ì „ ìµœì¢… í™•ì¸..."
        echo "  ì‘ì—… ë””ë ‰í† ë¦¬: $(pwd)"
        echo "  ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì ˆëŒ€ê²½ë¡œ: $(realpath new_manifest_text.xml)"
        echo "  ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬: $([ -f new_manifest_text.xml ] && echo "âœ…" || echo "âŒ")"
        echo "  android.jar ì ˆëŒ€ê²½ë¡œ: $(realpath $ANDROID_HOME/platforms/android-33/android.jar)"
        echo "  android.jar ì¡´ì¬: $([ -f "$ANDROID_HOME/platforms/android-33/android.jar" ] && echo "âœ…" || echo "âŒ")"

        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML ë¬¸ë²• ê²€ì‚¬
        echo "ğŸ” XML ë¬¸ë²• ê²€ì‚¬..."
        if xmllint --noout new_manifest_text.xml 2>/dev/null; then
          echo "âœ… XML ë¬¸ë²• ì •ìƒ"
        else
          echo "âŒ XML ë¬¸ë²• ì˜¤ë¥˜ - xmllint ê²°ê³¼:"
          xmllint --noout new_manifest_text.xml 2>&1 || true
        fi

        # aapt ë²„ì „ í™•ì¸
        echo "ğŸ“‹ aapt ì •ë³´:"
        aapt version

        # ë‹¨ê³„ë³„ aapt ì‹¤í–‰
        echo "ğŸš€ aapt ì‹¤í–‰ ì‹œë„ 1: ê¸°ë³¸ ëª…ë ¹ì–´"
        
        # ì„ì‹œ APK ìƒì„± (ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë§Œ)
        mkdir -p temp_res/values
        echo '<?xml version="1.0" encoding="utf-8"?><resources><string name="app_name">DoubleCheck</string></resources>' > temp_res/values/strings.xml
        echo "  ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì ˆëŒ€ê²½ë¡œ: $(realpath temp_res)"
        
        aapt package -f \
          -M new_manifest_text.xml \
          -S temp_res \
          -I "$ANDROID_HOME/platforms/android-33/android.jar" \
          -F temp_with_manifest.apk 2>&1 | tee aapt_output.log

        RESULT1=$?
        echo "ê²°ê³¼ ì½”ë“œ: $RESULT1"

        if [ $RESULT1 -ne 0 ]; then
          echo "ğŸš€ aapt ì‹¤í–‰ ì‹œë„ 2: ì ˆëŒ€ê²½ë¡œ ì‚¬ìš©"
          aapt package -f \
            -M "$(pwd)/new_manifest_text.xml" \
            -S "$(pwd)/temp_res" \
            -I "$ANDROID_HOME/platforms/android-33/android.jar" \
            -F "$(pwd)/temp_with_manifest.apk" 2>&1 | tee aapt_output2.log
          
          RESULT2=$?
          echo "ê²°ê³¼ ì½”ë“œ: $RESULT2"
          
          if [ $RESULT2 -ne 0 ]; then
            echo "ğŸš€ aapt ì‹¤í–‰ ì‹œë„ 3: ìµœì†Œ ë¦¬ì†ŒìŠ¤ë¡œ"
            
            # ë” ê°„ë‹¨í•œ ë¦¬ì†ŒìŠ¤ êµ¬ì¡°
            rm -rf temp_res
            mkdir -p temp_res/values
            echo '<?xml version="1.0" encoding="utf-8"?>' > temp_res/values/strings.xml
            echo '<resources>' >> temp_res/values/strings.xml
            echo '    <string name="app_name">DoubleCheck</string>' >> temp_res/values/strings.xml
            echo '</resources>' >> temp_res/values/strings.xml
            
            aapt package -f \
              -M "$(pwd)/new_manifest_text.xml" \
              -S "$(pwd)/temp_res" \
              -I "$ANDROID_HOME/platforms/android-33/android.jar" \
              -F "$(pwd)/temp_with_manifest.apk" \
              --debug-mode \
              -v 2>&1 | tee aapt_output3.log
            
            RESULT3=$?
            echo "ê²°ê³¼ ì½”ë“œ: $RESULT3"
          fi
        fi

        echo "ğŸ“„ aapt ì¶œë ¥ ë¡œê·¸ë“¤:"
        echo "=== aapt_output.log ==="
        cat aapt_output.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
        echo "=== aapt_output2.log ==="  
        cat aapt_output2.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"
        echo "=== aapt_output3.log ==="
        cat aapt_output3.log 2>/dev/null || echo "ë¡œê·¸ ì—†ìŒ"

        echo "ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ ìµœì¢… ìƒíƒœ:"
        ls -la
        
        # ì„±ê³µí•œ ê²½ìš° ê³„ì† ì§„í–‰
        if [ -f "temp_with_manifest.apk" ]; then
          echo "âœ… ì„ì‹œ APK ìƒì„± ì„±ê³µ"
          
          # ìƒˆ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
          mkdir -p new_manifest
          unzip -j temp_with_manifest.apk AndroidManifest.xml -d new_manifest
          
          if [ -f "new_manifest/AndroidManifest.xml" ]; then
            echo "âœ… ìƒˆ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì„±ê³µ"
            
            # ì›ë³¸ APKì— ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚½ì…
            cp work.apk final.apk
            cd new_manifest
            zip -u ../final.apk AndroidManifest.xml
            cd ..
            
            echo "ğŸ“¦ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµì²´ ì™„ë£Œ"
            
            # ê²€ì¦
            if aapt dump badging final.apk >/dev/null 2>&1; then
              echo "âœ… ìˆ˜ì •ëœ APK ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼"
              
              # receiver ê°œìˆ˜ í™•ì¸
              RECEIVER_COUNT=$(aapt dump xmltree final.apk AndroidManifest.xml | grep -c "receiver" || echo "0")
              echo "ğŸ“± ìµœì¢… Receiver ê°œìˆ˜: $RECEIVER_COUNT"
              
              # íŒ¨í‚¤ì§€ ì •ë³´ ì¶œë ¥
              echo "ğŸ“¦ APK ì •ë³´:"
              aapt dump badging final.apk | head -3
              
              # ìµœì¢… APK ë³µì‚¬
              cp final.apk ../final_doublecheck_fixed.apk
              echo "ğŸ‰ ìµœì¢… APK ìƒì„± ì„±ê³µ: final_doublecheck_fixed.apk"
              
            else
              echo "âŒ ìˆ˜ì •ëœ APK ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨"
              aapt dump badging final.apk 2>&1 | head -5
              exit 1
            fi
          else
            echo "âŒ ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
            ls -la new_manifest/
            exit 1
          fi
        else
          echo "âŒ ëª¨ë“  aapt ì‹œë„ ì‹¤íŒ¨"
          exit 1
        fi
        
        cd ..

    # âœ… ìµœì¢… APK ê²€ì¦
    - name: Final APK validation
      run: |
        echo "=== ğŸ¯ ìµœì¢… APK ê²€ì¦ ==="
        
        APK_TO_TEST="final_doublecheck_fixed.apk"
        
        if [ ! -f "$APK_TO_TEST" ]; then
          echo "âŒ ìµœì¢… APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ“± ìµœì¢… APK ì •ë³´:"
        echo "íŒŒì¼ëª…: $APK_TO_TEST"
        echo "í¬ê¸°: $(du -h "$APK_TO_TEST" | cut -f1)"
        
        # APK êµ¬ì¡° ê²€ì¦
        echo "ğŸ” APK êµ¬ì¡° ê²€ì¦..."
        if aapt dump badging "$APK_TO_TEST" > apk_info.txt 2>&1; then
          echo "âœ… APK êµ¬ì¡° ìœ íš¨"
          
          # íŒ¨í‚¤ì§€ ì •ë³´ ì¶œë ¥
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì •ë³´:"
          grep "package:" apk_info.txt | head -3
          grep "application:" apk_info.txt | head -1
          grep "launchable-activity:" apk_info.txt | head -1
          
          # receiver í™•ì¸
          echo "ğŸ“¡ Receiver ì •ë³´:"
          aapt dump xmltree "$APK_TO_TEST" AndroidManifest.xml | grep -A5 -B5 "receiver" || echo "receiver íƒœê·¸ ì—†ìŒ"
          
        else
          echo "âŒ APK êµ¬ì¡° ì˜¤ë¥˜"
          cat apk_info.txt
          exit 1
        fi
        
        echo "ğŸ‰ ìµœì¢… ìˆ˜ì •ëœ APK ì¤€ë¹„ ì™„ë£Œ: $APK_TO_TEST"
        echo "ğŸ“± ì„¤ì¹˜ ê°€ëŠ¥í•œ APK ìƒì„±ë¨!"

    # âœ… ìµœì¢… APK ì—…ë¡œë“œ
    - name: Upload final APKs
      uses: actions/upload-artifact@v4
      with:
        name: doublecheck-apks-${{ github.run_number }}
        path: |
          final_doublecheck_fixed.apk
          original_backup.apk
        retention-days: 7

name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # âœ… ì™„ì „í•œ í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== ğŸ§¹ Completely cleaning build environment ==="
        rm -rf .buildozer bin build android/build android/.gradle
        rm -rf ~/.buildozer ~/.gradle ~/.android
        echo "âœ… ëª¨ë“  ìºì‹œ ì œê±° ì™„ë£Œ"

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev aapt

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.4.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜ (ê°œì„ ëœ ë²„ì „)
    - name: Install APK modification tools
      run: |
        echo "=== ğŸ› ï¸ APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜ ==="
        
        # Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ì„¤ì¹˜
        echo "ğŸ“¥ Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
        mkdir -p ~/android-sdk
        cd ~/android-sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        export ANDROID_SDK_ROOT=~/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/build-tools/34.0.0
        echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
        echo "~/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "~/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH
        
        # SDK ë¼ì´ì„¼ìŠ¤ ìë™ ë™ì˜
        yes | sdkmanager --licenses || true
        
        # build-tools ìµœì‹  ë²„ì „ ì„¤ì¹˜
        echo "ğŸ”§ Android Build Tools ì„¤ì¹˜..."
        sdkmanager "build-tools;34.0.0" "platform-tools"
        
        # apktool ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
        echo "ğŸ“¥ apktool ë‹¤ìš´ë¡œë“œ..."
        cd ~
        wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
        
        chmod +x apktool
        sudo mv apktool /usr/local/bin/
        sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar
        
        # ë„êµ¬ ë²„ì „ í™•ì¸
        echo "âœ… ì„¤ì¹˜ëœ ë„êµ¬ ë²„ì „:"
        apktool --version || echo "apktool ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
        ls -la ~/android-sdk/build-tools/34.0.0/
        
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    # âœ… ë¹Œë“œ ìˆ˜í–‰
    - name: Build APK with buildozer
      run: |
        echo "=== ğŸ”¨ Buildozer APK ë¹Œë“œ ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # âœ… APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦
    - name: Find and verify APK
      run: |
        echo "=== ğŸ” APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦ ==="
        
        # APK íŒŒì¼ ìë™ íƒì§€
        POSSIBLE_APKS=(
          "./bin/doublecheck-0.1-arm64-v8a-debug.apk"
          "./bin/*.apk"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/outputs/apk/debug/*.apk"
        )
        
        FOUND_APK=""
        for apk_pattern in "${POSSIBLE_APKS[@]}"; do
          for apk_file in $apk_pattern; do
            if [ -f "$apk_file" ]; then
              FOUND_APK="$apk_file"
              echo "âœ… APK ë°œê²¬: $FOUND_APK"
              break 2
            fi
          done
        done
        
        if [ -z "$FOUND_APK" ]; then
          FOUND_APK=$(find . -name "*debug*.apk" -type f | head -1)
          if [ -n "$FOUND_APK" ]; then
            echo "âœ… ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ APK ë°œê²¬: $FOUND_APK"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi
        fi
        
        echo "ORIGINAL_APK=$FOUND_APK" >> $GITHUB_ENV
        echo "ğŸ“Š APK í¬ê¸°: $(du -h "$FOUND_APK" | cut -f1)"
        
        # ì›ë³¸ APK ìœ íš¨ì„± ê²€ì‚¬
        if aapt dump badging "$FOUND_APK" >/dev/null 2>&1; then
          echo "âœ… ì›ë³¸ APK êµ¬ì¡° ìœ íš¨"
        else
          echo "âŒ ì›ë³¸ APK êµ¬ì¡° ì˜¤ë¥˜"
          exit 1
        fi

    # âœ… APK ìˆ˜ì • (AlarmReceiver ì¶”ê°€) - ê°œì„ ëœ ë²„ì „
    - name: Modify APK to add AlarmReceiver
      run: |
        echo "=== ğŸ”§ APK ìˆ˜ì • (AlarmReceiver ì¶”ê°€) ==="
        
        if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
          echo "âŒ ì›ë³¸ APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ¯ ëŒ€ìƒ APK: $ORIGINAL_APK"
        
        # ë°±ì—… ìƒì„±
        cp "$ORIGINAL_APK" original_backup.apk
        echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
        
        # ì‘ì—… ê³µê°„ ì •ë¦¬
        rm -rf decoded_apk_clean
        
        # APK ë””ì»´íŒŒì¼ (ë” ì•ˆì „í•œ ì˜µì…˜ ì‚¬ìš©)
        echo "ğŸ“¦ APK ë””ì»´íŒŒì¼..."
        if apktool d "$ORIGINAL_APK" -o decoded_apk_clean --force --no-debug-info; then
          echo "âœ… APK ë””ì»´íŒŒì¼ ì„±ê³µ"
        else
          echo "âŒ APK ë””ì»´íŒŒì¼ ì‹¤íŒ¨"
          exit 1
        fi
        
        # AndroidManifest.xml ìˆ˜ì • (ë” ì •êµí•œ ë°©ì‹)
        MANIFEST="decoded_apk_clean/AndroidManifest.xml"
        cp "$MANIFEST" "${MANIFEST}.backup"
        
        echo "ğŸ” í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒíƒœ:"
        echo "- activity: $(grep -c '<activity' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        echo "- receiver: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        echo "- service: $(grep -c '<service' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âš ï¸ AlarmReceiver ì´ë¯¸ ì¡´ì¬í•¨ - ìˆ˜ì •í•˜ì§€ ì•ŠìŒ"
        else
          echo "â• AlarmReceiver ì¶”ê°€ ì¤‘..."
          
          # ë” ì•ˆì „í•œ XML ìˆ˜ì • ë°©ì‹
          if grep -q "</application>" "$MANIFEST"; then
            # ë°±ìŠ¬ë˜ì‹œ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì œ í•´ê²°
            cat >> temp_receiver.xml << 'EOF'
        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
EOF
            
            # </application> ë°”ë¡œ ì•ì— receiver ì‚½ì…
            sed -i '/<\/application>/i\        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">\
            <intent-filter>\
                <action android:name="android.intent.action.BOOT_COMPLETED" />\
            </intent-filter>\
        </receiver>' "$MANIFEST"
            
            echo "âœ… AlarmReceiver ì¶”ê°€ ì™„ë£Œ"
          else
            echo "âŒ </application> íƒœê·¸ ì—†ìŒ"
            exit 1
          fi
        fi
        
        # ìˆ˜ì • ê²°ê³¼ ê²€ì¦
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âœ… AlarmReceiver í™•ì¸ë¨"
          echo "ğŸ“Š ìˆ˜ì • í›„ receiver ê°œìˆ˜: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")"
        else
          echo "âŒ AlarmReceiver ì¶”ê°€ ì‹¤íŒ¨"
          exit 1
        fi
        
        # XML ë¬¸ë²• ê²€ì¦
        if command -v xmllint >/dev/null 2>&1; then
          if xmllint --noout "$MANIFEST" 2>/dev/null; then
            echo "âœ… XML ë¬¸ë²• ìœ íš¨"
          else
            echo "âŒ XML ë¬¸ë²• ì˜¤ë¥˜ - ë°±ì—…ì—ì„œ ë³µì›"
            cp "${MANIFEST}.backup" "$MANIFEST"
            exit 1
          fi
        fi

    # âœ… ìˆ˜ì •ëœ APK ë¦¬ë¹Œë“œ ë° ì„œëª… (ëŒ€í­ ê°œì„ )
    - name: Rebuild and sign modified APK
      run: |
        echo "=== ğŸ”¨ ìˆ˜ì •ëœ APK ë¦¬ë¹Œë“œ ë° ì„œëª… ==="
        
        # APK ë¦¬ë¹Œë“œ (ìµœì í™”ëœ ì˜µì…˜)
        echo "ğŸ“¦ APK ë¦¬ë¹Œë“œ..."
        if apktool b decoded_apk_clean -o rebuilt_doublecheck_unsigned.apk --force-all --no-debug-info; then
          echo "âœ… APK ë¦¬ë¹Œë“œ ì„±ê³µ"
          echo "ğŸ“Š ë¦¬ë¹Œë“œ APK í¬ê¸°: $(du -h rebuilt_doublecheck_unsigned.apk | cut -f1)"
        else
          echo "âŒ APK ë¦¬ë¹Œë“œ ì‹¤íŒ¨"
          # ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥
          echo "=== ë¦¬ë¹Œë“œ ì˜¤ë¥˜ ë””ë²„ê¹… ==="
          apktool b decoded_apk_clean -o rebuilt_doublecheck_unsigned.apk --force-all --verbose || true
          exit 1
        fi
        
        # ë¦¬ë¹Œë“œëœ APK êµ¬ì¡° ê²€ì¦
        if aapt dump badging rebuilt_doublecheck_unsigned.apk >/dev/null 2>&1; then
          echo "âœ… ë¦¬ë¹Œë“œëœ APK êµ¬ì¡° ìœ íš¨"
        else
          echo "âŒ ë¦¬ë¹Œë“œëœ APK êµ¬ì¡° ì˜¤ë¥˜"
          aapt dump badging rebuilt_doublecheck_unsigned.apk || true
          exit 1
        fi
        
        # ë””ë²„ê·¸ í‚¤ìŠ¤í† ì–´ ìƒì„± (ê°œì„ ëœ íŒŒë¼ë¯¸í„°)
        if [ ! -f "debug.keystore" ]; then
          echo "ğŸ”‘ ë””ë²„ê·¸ í‚¤ìŠ¤í† ì–´ ìƒì„±..."
          keytool -genkey -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" \
            -storepass android \
            -keypass android \
            -noprompt
        fi
        
        # ê¸°ì¡´ ì„œëª… ì™„ì „ ì œê±°
        echo "ğŸ—‘ï¸ ê¸°ì¡´ ì„œëª… ì œê±°..."
        zip -d rebuilt_doublecheck_unsigned.apk 'META-INF/*' 2>/dev/null || echo "ê¸°ì¡´ ì„œëª… ì—†ìŒ"
        
        # APK ì„œëª… (ë” ì•ˆì „í•œ ë°©ì‹)
        echo "ğŸ” APK ì„œëª…..."
        cp rebuilt_doublecheck_unsigned.apk rebuilt_doublecheck_signed.apk
        
        jarsigner -verbose \
          -sigalg SHA256withRSA \
          -digestalg SHA-256 \
          -keystore debug.keystore \
          -storepass android \
          -keypass android \
          rebuilt_doublecheck_signed.apk \
          androiddebugkey
        
        # ì„œëª… ê²€ì¦
        if jarsigner -verify -verbose rebuilt_doublecheck_signed.apk 2>/dev/null; then
          echo "âœ… ì„œëª… ê²€ì¦ ì„±ê³µ"
        else
          echo "âŒ ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
          jarsigner -verify -verbose rebuilt_doublecheck_signed.apk || true
          exit 1
        fi
        
        # zipalign ì •ë ¬ (í•„ìˆ˜!)
        ZIPALIGN_PATH="$HOME/android-sdk/build-tools/34.0.0/zipalign"
        if [ -f "$ZIPALIGN_PATH" ]; then
          echo "ğŸ”§ APK ì •ë ¬..."
          $ZIPALIGN_PATH -f -v 4 rebuilt_doublecheck_signed.apk final_doublecheck_fixed.apk
          echo "âœ… APK ì •ë ¬ ì™„ë£Œ"
          
          # ì •ë ¬ ê²€ì¦
          if $ZIPALIGN_PATH -c -v 4 final_doublecheck_fixed.apk; then
            echo "âœ… APK ì •ë ¬ ê²€ì¦ ì„±ê³µ"
          else
            echo "âŒ APK ì •ë ¬ ê²€ì¦ ì‹¤íŒ¨"
            exit 1
          fi
        else
          echo "âš ï¸ zipalign ì—†ìŒ - ì„œëª…ëœ APK ì‚¬ìš©"
          cp rebuilt_doublecheck_signed.apk final_doublecheck_fixed.apk
        fi

    # âœ… ìµœì¢… APK ê²€ì¦ (ê°•í™”ëœ ë²„ì „)
    - name: Final APK validation
      run: |
        echo "=== ğŸ¯ ìµœì¢… APK ê²€ì¦ ==="
        
        APK_TO_TEST="final_doublecheck_fixed.apk"
        
        if [ ! -f "$APK_TO_TEST" ]; then
          echo "âŒ ìµœì¢… APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ“± ìµœì¢… APK ì •ë³´:"
        echo "íŒŒì¼ëª…: $APK_TO_TEST"
        echo "í¬ê¸°: $(du -h "$APK_TO_TEST" | cut -f1)"
        
        # 1. APK êµ¬ì¡° ê²€ì¦
        echo "ğŸ” APK êµ¬ì¡° ê²€ì¦..."
        if aapt dump badging "$APK_TO_TEST" > apk_info.txt 2>&1; then
          echo "âœ… APK êµ¬ì¡° ìœ íš¨"
          
          # íŒ¨í‚¤ì§€ ì •ë³´ ì¶œë ¥
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì •ë³´:"
          grep "package:" apk_info.txt | head -3
          grep "application:" apk_info.txt | head -1
          grep "launchable-activity:" apk_info.txt | head -1
          
        else
          echo "âŒ APK êµ¬ì¡° ì˜¤ë¥˜"
          cat apk_info.txt
          exit 1
        fi
        
        # 2. ì„œëª… ê²€ì¦
        echo "ğŸ” ì„œëª… ê²€ì¦..."
        if jarsigner -verify "$APK_TO_TEST" 2>/dev/null; then
          echo "âœ… ì„œëª… ìœ íš¨"
        else
          echo "âŒ ì„œëª… ë¬´íš¨"
          jarsigner -verify -verbose "$APK_TO_TEST" || true
        fi
        
        # 3. zipalign ê²€ì¦
        ZIPALIGN_PATH="$HOME/android-sdk/build-tools/34.0.0/zipalign"
        if [ -f "$ZIPALIGN_PATH" ]; then
          if $ZIPALIGN_PATH -c 4 "$APK_TO_TEST" >/dev/null 2>&1; then
            echo "âœ… APK ì •ë ¬ ìœ íš¨"
          else
            echo "âš ï¸ APK ì •ë ¬ ë¬¸ì œ"
          fi
        fi
        
        # 4. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦
        echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦..."
        rm -rf final_verification
        apktool d "$APK_TO_TEST" -o final_verification --force >/dev/null 2>&1
        
        if [ -f "final_verification/AndroidManifest.xml" ]; then
          FINAL_MANIFEST="final_verification/AndroidManifest.xml"
          
          echo "ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ë³´:"
          echo "- package: $(grep 'package=' "$FINAL_MANIFEST" | head -1 | sed 's/.*package="//;s/".*//')"
          echo "- activity: $(grep -c '<activity' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          echo "- receiver: $(grep -c '<receiver' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          echo "- service: $(grep -c '<service' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          
          if grep -q "AlarmReceiver" "$FINAL_MANIFEST"; then
            echo "âœ… AlarmReceiver ì •ìƒ í¬í•¨!"
          else
            echo "âŒ AlarmReceiver ì—†ìŒ"
          fi
          
          # MAIN ì•¡í‹°ë¹„í‹° í™•ì¸
          if grep -A 10 'android.intent.action.MAIN' "$FINAL_MANIFEST" | grep -q 'android:name'; then
            echo "âœ… MAIN ì•¡í‹°ë¹„í‹° ì¡´ì¬"
            MAIN_ACTIVITY=$(grep -B 5 -A 5 'android.intent.action.MAIN' "$FINAL_MANIFEST" | grep 'android:name=' | head -1 | sed 's/.*android:name="//;s/".*//')
            echo "- MAIN ì•¡í‹°ë¹„í‹°: $MAIN_ACTIVITY"
          else
            echo "âŒ MAIN ì•¡í‹°ë¹„í‹° ì—†ìŒ - ì•± ì‹¤í–‰ ë¶ˆê°€"
          fi
        fi
        
        # 5. íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
        echo "ğŸ” íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦..."
        unzip -t "$APK_TO_TEST" >/dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo "âœ… APK íŒŒì¼ ë¬´ê²°ì„± ì–‘í˜¸"
        else
          echo "âŒ APK íŒŒì¼ ì†ìƒ"
          exit 1
        fi
        
        echo "ğŸ‰ ìµœì¢… ìˆ˜ì •ëœ APK ì¤€ë¹„ ì™„ë£Œ: $APK_TO_TEST"
        echo "ğŸ“± ì„¤ì¹˜ ê°€ëŠ¥í•œ APK ìƒì„±ë¨!"

    # âœ… ì›ë³¸ê³¼ ìˆ˜ì •ë³¸ ë¹„êµ ë¶„ì„
    - name: Compare original and modified APK
      if: always()
      run: |
        echo "=== ğŸ” ì›ë³¸ê³¼ ìˆ˜ì •ë³¸ ë¹„êµ ë¶„ì„ ==="
        
        if [ -f "${ORIGINAL_APK:-}" ] && [ -f "final_doublecheck_fixed.apk" ]; then
          echo "ğŸ“Š í¬ê¸° ë¹„êµ:"
          echo "ì›ë³¸: $(du -h "$ORIGINAL_APK" | cut -f1)"
          echo "ìˆ˜ì •: $(du -h "final_doublecheck_fixed.apk" | cut -f1)"
          
          # ì›ë³¸ APK ë¶„ì„
          echo "ğŸ“¦ ì›ë³¸ APK ë¶„ì„..."
          rm -rf original_analysis
          apktool d "$ORIGINAL_APK" -o original_analysis --force >/dev/null 2>&1
          
          if [ -f "original_analysis/AndroidManifest.xml" ]; then
            ORIG_MANIFEST="original_analysis/AndroidManifest.xml"
            echo "ì›ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸:"
            echo "- activity: $(grep -c '<activity' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            echo "- receiver: $(grep -c '<receiver' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            echo "- service: $(grep -c '<service' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            
            if grep -q "AlarmReceiver" "$ORIG_MANIFEST"; then
              echo "âš ï¸ ì›ë³¸ì— ì´ë¯¸ AlarmReceiver ì¡´ì¬"
            else
              echo "âŒ ì›ë³¸ì— AlarmReceiver ì—†ìŒ"
            fi
          fi
          
          # ìˆ˜ì •ë³¸ê³¼ ì°¨ì´ì  ë¶„ì„
          if [ -f "final_verification/AndroidManifest.xml" ] && [ -f "original_analysis/AndroidManifest.xml" ]; then
            echo "ğŸ”„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì°¨ì´ì :"
            diff original_analysis/AndroidManifest.xml final_verification/AndroidManifest.xml | head -20 || echo "ì°¨ì´ì  ì—†ìŒ"
          fi
        fi

    # âœ… APK ì„¤ì¹˜ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸
    - name: APK installation simulation test
      run: |
        echo "=== ğŸ“± APK ì„¤ì¹˜ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ==="
        
        APK_FILE="final_doublecheck_fixed.apk"
        
        if [ -f "$APK_FILE" ]; then
          echo "ğŸ§ª APK ì„¤ì¹˜ ê°€ëŠ¥ì„± í…ŒìŠ¤íŠ¸..."
          
          # aaptë¥¼ ì‚¬ìš©í•œ ê¸°ë³¸ ê²€ì¦
          if aapt dump xmltree "$APK_FILE" AndroidManifest.xml >/dev/null 2>&1; then
            echo "âœ… AndroidManifest.xml íŒŒì‹± ê°€ëŠ¥"
          else
            echo "âŒ AndroidManifest.xml íŒŒì‹± ì‹¤íŒ¨"
            exit 1
          fi
          
          # ê¶Œí•œ í™•ì¸
          echo "ğŸ”‘ ì•± ê¶Œí•œ:"
          aapt dump permissions "$APK_FILE" | head -10
          
          # ì•¡í‹°ë¹„í‹° í™•ì¸
          echo "ğŸ¯ ì‹¤í–‰ ê°€ëŠ¥ ì•¡í‹°ë¹„í‹°:"
          aapt dump badging "$APK_FILE" | grep "launchable-activity" | head -3
          
          # íŒ¨í‚¤ì§€ ì„œëª… ìƒíƒœ
          echo "ğŸ” íŒ¨í‚¤ì§€ ì„œëª… ìƒíƒœ:"
          if jarsigner -verify -verbose "$APK_FILE" 2>&1 | grep "verified" >/dev/null; then
            echo "âœ… ì„œëª… ê²€ì¦ë¨"
          else
            echo "âŒ ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
          fi
          
          echo "ğŸ‰ APK ì„¤ì¹˜ ì‹œë®¬ë ˆì´ì…˜ í…ŒìŠ¤íŠ¸ ì™„ë£Œ!"
        else
          echo "âŒ í…ŒìŠ¤íŠ¸í•  APK íŒŒì¼ ì—†ìŒ"
        fi

    # âœ… ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          apk_info.txt
          .buildozer/**/*.log
          original_analysis/AndroidManifest.xml
          final_verification/AndroidManifest.xml
          decoded_apk_clean/AndroidManifest.xml.backup
        retention-days: 30
        if-no-files-found: warn

    # âœ… ìµœì¢… APK ì—…ë¡œë“œ
    - name: Upload final APKs
      uses: actions/upload-artifact@v4
      with:
        name: doublecheck-apks-${{ github.run_number }}
        path: |
          final_doublecheck_fixed.apk
          original_backup.apk
          rebuilt_doublecheck_unsigned.apk
          rebuilt_doublecheck_signed.apk
        retention-days: 7
        if-no-files-found: error

name: Build Android APK

on:
  workflow_dispatch:  # 수동 실행만 허용
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        
    - name: Set up Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip openjdk-8-jdk autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.5.0
        
    - name: Create simple buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = SKKU Timetable
        package.name = skkutimetable
        package.domain = org.kivy
        source.dir = .
        source.filename = main.py
        source.include_exts = py,png,jpg,kv,atlas,ttf
        
        # Requirements - 최소한으로 설정
        requirements = python3,kivy==2.1.0,plyer
        
        version = 0.1
        orientation = portrait
        fullscreen = 0
        
        # Android settings - 간소화
        android.permissions = INTERNET,WAKE_LOCK
        android.api = 30
        android.minapi = 21
        android.ndk = 23c
        android.ndk_api = 21
        android.accept_sdk_license = True
        android.archs = armeabi-v7a
        android.allow_backup = True
        android.skip_update = True
        
        [buildozer]
        log_level = 2
        warn_on_root = 1
        EOF
        
    - name: Show buildozer.spec
      run: |
        echo "=== buildozer.spec content ==="
        cat buildozer.spec
        
    - name: Clean build
      run: |
        rm -rf .buildozer
        rm -rf bin
        
    - name: Set Java 8 environment
      run: |
        export JAVA_HOME=$JAVA_HOME_8_X64
        echo "JAVA_HOME=$JAVA_HOME_8_X64" >> $GITHUB_ENV
        echo "Java version: $(java -version)"
        
    - name: Build APK with simplified settings
      run: |
        export P4A_NUM_PROCS=1
        export GRADLE_OPTS="-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx1536m'"
        
        echo "Starting build..."
        buildozer android debug --verbose
        
    - name: List build results
      run: |
        echo "=== Build directory contents ==="
        ls -la
        if [ -d "bin" ]; then
          echo "=== APK files ==="
          ls -la bin/
          file bin/*.apk || echo "No APK files found"
        else
          echo "No bin directory found"
        fi
        
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

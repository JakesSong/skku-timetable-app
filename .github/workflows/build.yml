name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # âœ… ì™„ì „í•œ í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== ğŸ§¹ Completely cleaning build environment ==="
        
        # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ê¸°ì¤€
        rm -rf .buildozer
        rm -rf bin
        rm -rf build
        rm -rf android/build
        rm -rf android/.gradle
    
        # ì‚¬ìš©ì ìºì‹œ ë””ë ‰í† ë¦¬ ê¸°ì¤€
        rm -rf ~/.buildozer
        rm -rf ~/.gradle
        rm -rf ~/.android
    
        echo "âœ… ëª¨ë“  ìºì‹œ ì œê±° ì™„ë£Œ"

    # âœ… .java íŒŒì¼ ê²½ë¡œ í™•ì¸
    - name: Check java file visibility
      run: |
        echo "=== ğŸ” java íŒŒì¼ ê²½ë¡œ í™•ì¸ ==="
        find android/src -type f -name "*.java" || echo "âŒ java íŒŒì¼ ì—†ìŒ"
        if [ -d "android/src/main/java/org/kivy/skkutimetable/doublecheck" ]; then
          echo "âœ… java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¡´ì¬í•¨"
          ls -R android/src/main/java/org/kivy/skkutimetable/doublecheck
        else
          echo "âŒ java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi

    # âœ… buildozer.spec manifest ì„¤ì • í™•ì¸
    - name: Check manifest configuration in buildozer.spec
      run: |
        echo "=== ğŸ”§ buildozer.spec manifest ì„¤ì • í™•ì¸ ==="
        if [ -f "buildozer.spec" ]; then
          echo "--- manifest ê´€ë ¨ ì„¤ì •ë“¤ ---"
          grep -n "manifest" buildozer.spec || echo "manifest ì„¤ì • ì—†ìŒ"
          echo "--- android.manifest_template ì„¤ì • ---"
          grep -n "android.manifest_template" buildozer.spec || echo "android.manifest_template ì„¤ì • ì—†ìŒ"
        else
          echo "âŒ buildozer.spec íŒŒì¼ ì—†ìŒ"
        fi

    # âœ… buildozer.spec manifest ì„¤ì • í™•ì¸ (í…œí”Œë¦¿ ë°©ì‹)
    - name: Check manifest configuration in buildozer.spec (template mode)
      run: |
        echo "=== ğŸ”§ buildozer.spec manifest ì„¤ì • í™•ì¸ (í…œí”Œë¦¿ ë°©ì‹) ==="
        if [ -f "buildozer.spec" ]; then
          echo "--- manifest ê´€ë ¨ ì„¤ì •ë“¤ ---"
          grep -n "manifest" buildozer.spec || echo "manifest ì„¤ì • ì—†ìŒ"
          echo "--- android.manifest_template ì„¤ì • ---"
          grep -n "android.manifest_template" buildozer.spec || echo "android.manifest_template ì„¤ì • ì—†ìŒ"
          echo "--- ì£¼ì„ ì²˜ë¦¬ëœ android.add_manifest_xml í™•ì¸ ---"
          grep -n "android.add_manifest_xml" buildozer.spec || echo "android.add_manifest_xml ì„¤ì • ì—†ìŒ"
          echo ""
          echo "--- AndroidManifest.tmpl.xml íŒŒì¼ ì¡´ì¬ í™•ì¸ ---"
          if [ -f "AndroidManifest.tmpl.xml" ]; then
            echo "âœ… AndroidManifest.tmpl.xml íŒŒì¼ ì¡´ì¬"
            echo "--- í…œí”Œë¦¿ íŒŒì¼ í¬ê¸° ---"
            ls -la AndroidManifest.tmpl.xml
            echo "--- í…œí”Œë¦¿ íŒŒì¼ ì²« 10ì¤„ ---"
            head -10 AndroidManifest.tmpl.xml
            echo "--- AlarmReceiver í¬í•¨ ì—¬ë¶€ ---"
            grep -n "AlarmReceiver" AndroidManifest.tmpl.xml || echo "âŒ AlarmReceiver ì—†ìŒ"
            echo "--- NonExistentReceiver ë””ë²„ê·¸ ì½”ë“œ í™•ì¸ ---"
            grep -n "NonExistentReceiver" AndroidManifest.tmpl.xml || echo "NonExistentReceiver ì—†ìŒ"
          else
            echo "âŒ AndroidManifest.tmpl.xml íŒŒì¼ ì—†ìŒ"
          fi
        else
          echo "âŒ buildozer.spec íŒŒì¼ ì—†ìŒ"
        fi

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev

    # âœ… íŒŒì´ì¬ ì˜ì—°ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.4.0

    # ğŸ¯ ì—¬ê¸°ì— ë””ë²„ê·¸ ì½”ë“œë“¤ ì¶”ê°€!
    - name: Check buildozer template processing
      run: |
        echo "=== ğŸ” buildozer í…œí”Œë¦¿ ì²˜ë¦¬ ê³¼ì • ì¶”ì  ==="
        buildozer android debug 2>&1 | grep -i "template\|manifest" || echo "í…œí”Œë¦¿ ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
    
    - name: Check template file location and processing  
      run: |
        echo "=== ğŸ” í…œí”Œë¦¿ íŒŒì¼ ìœ„ì¹˜ì™€ ì²˜ë¦¬ í™•ì¸ ==="
        echo "í˜„ì¬ ìœ„ì¹˜ì˜ AndroidManifest.tmpl.xml:"
        ls -la AndroidManifest.tmpl.xml || echo "ì—†ìŒ"
        echo ""
        echo "buildozerê°€ í…œí”Œë¦¿ì„ ì–´ë””ì„œ ì°¾ëŠ”ì§€ í™•ì¸:"
        find . -name "*.tmpl.xml" 2>/dev/null || echo "tmpl.xml íŒŒì¼ ì—†ìŒ"
        echo ""
        echo "buildozer ë‚´ë¶€ì—ì„œ í…œí”Œë¦¿ ë³µì‚¬ í”ì :"
        find .buildozer -name "*tmpl*" 2>/dev/null || echo "buildozer ë‚´ë¶€ì— tmpl í”ì  ì—†ìŒ"
    
    # ê¸°ì¡´ ë¹Œë“œ ë‹¨ê³„
    - name: Build APK with buildozer
      run: buildozer android debug

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… ë¹Œë“œ ìˆ˜í–‰ ë° ë¡œê·¸ ì €ì¥
    - name: Build APK
      run: |
        echo "=== Build start ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë¦¬ 100ì¤„ ==="
          tail -100 build_full.log
          echo "=== AndroidManifest ê´€ë ¨ ë¡œê·¸ ê²€ìƒ‰ ==="
          grep -i "manifest" build_full.log | tail -20 || echo "manifest ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    - name: Check Java compilation results
      run: |
        echo "=== ğŸ” .class íŒŒì¼ ìƒì„± ì—¬ë¶€ í™•ì¸ ==="
        
        # .class íŒŒì¼ ê²€ìƒ‰
        find .buildozer -type f -name "*.class" || echo "âŒ .class íŒŒì¼ ì—†ìŒ"
    
        echo ""
        echo "=== ğŸ” AlarmReceiver ê´€ë ¨ .class íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ ==="
        find .buildozer -type f -name "*AlarmReceiver*.class" || echo "âŒ AlarmReceiver .class íŒŒì¼ ì—†ìŒ"
    
        echo ""
        echo "=== ğŸ” Java ì»´íŒŒì¼ ë¡œê·¸ ì¶”ì  (javac í˜¸ì¶œ í™•ì¸) ==="
        grep -i "javac" build_full.log | tail -20 || echo "âŒ javac í˜¸ì¶œ ë¡œê·¸ ì—†ìŒ"
    
        echo ""
        echo "=== ğŸ” Java ì†ŒìŠ¤ê°€ í¬í•¨ëœ ì»´íŒŒì¼ ëŒ€ìƒ ëª©ë¡ (javaCompile)" 
        grep -i "javaCompile" build_full.log | tail -20 || echo "âŒ javaCompile ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
    

    # âœ… APK ë””ì¼œí´ ë° AlarmReceiver í™•ì¸
    - name: Decompile APK and check AlarmReceiver
      run: |
        echo "=== ğŸ” apktool ì„¤ì¹˜ ==="
        sudo apt-get install -y apktool

        echo "=== ğŸ“† apk ë””ì¼œí´ ì¤‘ ==="
        apktool d bin/*.apk -o decoded_apk || echo "âŒ apktool ì‹¤íŒ¨"

        echo ""
        echo "=== ğŸ” AndroidManifest.xml ë‚´ AlarmReceiver í™•ì¸ ==="
        if [ -f "decoded_apk/AndroidManifest.xml" ]; then
          grep -A 5 -B 2 "AlarmReceiver" decoded_apk/AndroidManifest.xml || echo "âŒ AlarmReceiver ì—†ìŒ"
        else
          echo "âŒ decoded_apk/AndroidManifest.xml ì—†ìŒ"
        fi

        echo ""
        echo "=== ğŸ” AlarmReceiver í´ë˜ìŠ¤(smali) ì¡´ì¬ í™•ì¸ ==="
        find decoded_apk/smali -type f -name "*AlarmReceiver*.smali" || echo "âŒ AlarmReceiver í´ë˜ìŠ¤ ì—†ìŒ"

    # âœ… ë¹Œë“œ í›„ ìƒì„±ëœ AndroidManifest.xml ì² ì € ë¶„ì„
    - name: Analyze generated AndroidManifest.xml (Enhanced)
      if: always()
      run: |
        echo "=== ğŸ” ìƒì„±ëœ AndroidManifest.xml ì² ì € ë¶„ì„ ==="
        echo "ëª¨ë“  AndroidManifest.xml íŒŒì¼ ì°¾ê¸°:"
        find .buildozer -name "AndroidManifest.xml" -type f 2>/dev/null | while read -r file; do
          echo "ğŸ“ $file ($(wc -c < "$file") bytes)"
        done || echo "AndroidManifest.xml ì—†ìŒ"
        
        echo ""
        echo "=== ğŸ” ì£¼ìš” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ ìƒì„¸ ë¶„ì„ ==="
        MAIN_MANIFESTS=(
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/src/main/AndroidManifest.xml"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/AndroidManifest.xml"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/intermediates/merged_manifests/debug/AndroidManifest.xml"
        )
        
        for manifest in "${MAIN_MANIFESTS[@]}"; do
          if [ -f "$manifest" ]; then
            echo ""
            echo "ğŸ¯ ================== ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¶„ì„: $manifest =================="
            echo "ğŸ“Š íŒŒì¼ ì •ë³´: $(wc -c < "$manifest") bytes, $(wc -l < "$manifest") ì¤„"
            
            echo ""
            echo "--- ğŸ“‹ ê¸°ë³¸ ì •ë³´ ---"
            grep "package=" "$manifest" | head -1 || echo "íŒ¨í‚¤ì§€ ì •ë³´ ì—†ìŒ"
            grep "android:versionCode=" "$manifest" | head -1 || echo "ë²„ì „ ì½”ë“œ ì—†ìŒ"
            grep "android:versionName=" "$manifest" | head -1 || echo "ë²„ì „ ì´ë¦„ ì—†ìŒ"
            
            echo ""
            echo "--- ğŸ” ì „ì²´ êµ¬ì¡° í†µê³„ ---"
            echo "uses-permission: $(grep -c '<uses-permission' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "activity: $(grep -c '<activity' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "receiver: $(grep -c '<receiver' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "service: $(grep -c '<service' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "intent-filter: $(grep -c '<intent-filter' "$manifest" 2>/dev/null || echo "0")ê°œ"
            
            echo ""
            echo "--- ğŸ¯ AlarmReceiver í•µì‹¬ ê²€ìƒ‰ ---"
            if grep -q "AlarmReceiver" "$manifest"; then
              echo "âœ… AlarmReceiver ë°œê²¬!"
              echo "ğŸ“ AlarmReceiver ì „ì²´ ë‚´ìš©:"
              grep -A 20 -B 2 "AlarmReceiver" "$manifest" | head -25
            else
              echo "âŒ AlarmReceiver ì—†ìŒ"
            fi
            
            echo ""
            echo "--- ğŸ” ëª¨ë“  receiver íƒœê·¸ ë¶„ì„ ---"
            receiver_count=$(grep -c "<receiver" "$manifest" 2>/dev/null || echo "0")
            echo "ì´ receiver ê°œìˆ˜: $receiver_count"
            if [ "$receiver_count" -gt 0 ]; then
              echo "ğŸ“‹ ëª¨ë“  receiver ëª©ë¡:"
              grep -o 'android:name="[^"]*"' "$manifest" | grep -A1 -B1 receiver || echo "receiver name ì¶”ì¶œ ì‹¤íŒ¨"
              echo ""
              echo "ğŸ“‹ receiver íƒœê·¸ë“¤ (ì²˜ìŒ 10ê°œ):"
              grep -A 5 "<receiver" "$manifest" | head -30
            fi
            
            echo ""
            echo "--- ğŸ” ë””ë²„ê·¸ ì½”ë“œ ê²€ì¦ ---"
            if grep -q "NonExistentReceiver" "$manifest"; then
              echo "ğŸ¯ NonExistentReceiver ë°œê²¬! (í…œí”Œë¦¿ ì ìš©ë¨)"
            else
              echo "âŒ NonExistentReceiver ì—†ìŒ (í…œí”Œë¦¿ ë¬´ì‹œë¨)"
            fi
            
            echo ""
            echo "--- ğŸ“‹ ê¶Œí•œ ëª©ë¡ (ì•ŒëŒ ê´€ë ¨) ---"
            echo "WAKE_LOCK: $(grep -c 'WAKE_LOCK' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "RECEIVE_BOOT_COMPLETED: $(grep -c 'RECEIVE_BOOT_COMPLETED' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "SCHEDULE_EXACT_ALARM: $(grep -c 'SCHEDULE_EXACT_ALARM' "$manifest" 2>/dev/null || echo "0")ê°œ"
            echo "SET_ALARM: $(grep -c 'SET_ALARM' "$manifest" 2>/dev/null || echo "0")ê°œ"
            
            echo ""
            echo "--- ğŸ“‹ ì „ì²´ ê¶Œí•œ ëª©ë¡ ---"
            grep '<uses-permission' "$manifest" | sed 's/.*android:name="//;s/".*//' | sort || echo "ê¶Œí•œ ëª©ë¡ ì¶”ì¶œ ì‹¤íŒ¨"
            
            echo ""
            echo "--- ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì „ì²´ ë‚´ìš© (ì²˜ìŒ 50ì¤„) ---"
            head -50 "$manifest"
            
            echo ""
            echo "--- ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì „ì²´ ë‚´ìš© (ë§ˆì§€ë§‰ 20ì¤„) ---"
            tail -20 "$manifest"
            
          else
            echo "âŒ íŒŒì¼ ì—†ìŒ: $manifest"
          fi
          echo ""
        done
        
        echo ""
        echo "=== ğŸ¯ ìµœì¢… ìš”ì•½ ==="
        echo "í…œí”Œë¦¿ ì ìš© ì—¬ë¶€ ìµœì¢… íŒë‹¨:"
        for manifest in "${MAIN_MANIFESTS[@]}"; do
          if [ -f "$manifest" ]; then
            if grep -q "NonExistentReceiver" "$manifest"; then
              echo "âœ… $manifest - í…œí”Œë¦¿ ì ìš©ë¨"
            else
              echo "âŒ $manifest - í…œí”Œë¦¿ ë¬´ì‹œë¨"
            fi
          fi
        done

    # âœ… ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          .buildozer/**/*.log
          .buildozer/**/AndroidManifest.xml
        retention-days: 30
        if-no-files-found: warn

    # âœ… APK ì—…ë¡œë“œ
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: skku-timetable-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

    # ê¸°ì¡´ ì›Œí¬í”Œë¡œìš°ì— ì¶”ê°€í•  ë‹¨ê³„ë“¤
    
    # APK ì„¤ì¹˜ ì˜¤ë¥˜ ì§„ë‹¨ ë° ìˆ˜ì •
    - name: Diagnose APK installation issues
      run: |
        echo "=== ğŸ” APK ì„¤ì¹˜ ì˜¤ë¥˜ ì§„ë‹¨ ==="
        
        # 1. APK íŒŒì¼ ì¡´ì¬ í™•ì¸
        echo "--- ğŸ“± APK íŒŒì¼ í™•ì¸ ---"
        if [ -f "final_doublecheck.apk" ]; then
          echo "âœ… final_doublecheck.apk ì¡´ì¬"
          echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h final_doublecheck.apk | cut -f1)"
          echo "ğŸ“Š íŒŒì¼ ê¶Œí•œ: $(ls -la final_doublecheck.apk)"
        else
          echo "âŒ final_doublecheck.apk ì—†ìŒ"
          echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬ APK íŒŒì¼ë“¤:"
          find . -name "*.apk" -type f
        fi
        
        # 2. APK ì„œëª… ìƒíƒœ í™•ì¸
        echo ""
        echo "--- ğŸ” APK ì„œëª… í™•ì¸ ---"
        if command -v jarsigner >/dev/null 2>&1; then
          echo "ğŸ” APK ì„œëª… ê²€ì¦:"
          jarsigner -verify -verbose final_doublecheck.apk 2>&1 || echo "âŒ ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
        else
          echo "âŒ jarsigner ì—†ìŒ"
        fi
        
        # 3. APK êµ¬ì¡° ê²€ì¦
        echo ""
        echo "--- ğŸ“¦ APK ë‚´ë¶€ êµ¬ì¡° í™•ì¸ ---"
        echo "ğŸ” APK ë‚´ë¶€ íŒŒì¼ ëª©ë¡ (ìƒìœ„ 20ê°œ):"
        unzip -l final_doublecheck.apk | head -25
        
        echo ""
        echo "ğŸ” í•„ìˆ˜ íŒŒì¼ ì¡´ì¬ í™•ì¸:"
        unzip -l final_doublecheck.apk | grep -E "(AndroidManifest.xml|classes.dex|META-INF)" || echo "âŒ í•„ìˆ˜ íŒŒì¼ ëˆ„ë½"
        
        # 4. AndroidManifest.xml ê²€ì¦
        echo ""
        echo "--- ğŸ“‹ AndroidManifest.xml ê²€ì¦ ---"
        if unzip -l final_doublecheck.apk | grep -q "AndroidManifest.xml"; then
          echo "âœ… AndroidManifest.xml ì¡´ì¬"
          
          # AndroidManifest.xml ì¶”ì¶œ ë° ê²€ì¦
          apktool d final_doublecheck.apk -o manifest_check --force >/dev/null 2>&1
          
          if [ -f "manifest_check/AndroidManifest.xml" ]; then
            echo "ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê¸°ë³¸ ì •ë³´:"
            echo "package: $(grep 'package=' manifest_check/AndroidManifest.xml | head -1)"
            echo "versionCode: $(grep 'android:versionCode=' manifest_check/AndroidManifest.xml | head -1)"
            echo "versionName: $(grep 'android:versionName=' manifest_check/AndroidManifest.xml | head -1)"
            echo "minSdkVersion: $(grep 'android:minSdkVersion=' manifest_check/AndroidManifest.xml | head -1)"
            echo "targetSdkVersion: $(grep 'android:targetSdkVersion=' manifest_check/AndroidManifest.xml | head -1)"
            
            echo ""
            echo "ğŸ” ì•¡í‹°ë¹„í‹° í™•ì¸:"
            activity_count=$(grep -c '<activity' manifest_check/AndroidManifest.xml 2>/dev/null || echo "0")
            echo "ì•¡í‹°ë¹„í‹° ê°œìˆ˜: $activity_count"
            
            if [ "$activity_count" -gt 0 ]; then
              echo "ë©”ì¸ ì•¡í‹°ë¹„í‹°:"
              grep -A 10 'android.intent.action.MAIN' manifest_check/AndroidManifest.xml | head -15 || echo "ë©”ì¸ ì•¡í‹°ë¹„í‹° ì—†ìŒ"
            fi
            
            echo ""
            echo "ğŸ” ê¶Œí•œ í™•ì¸:"
            echo "ê¶Œí•œ ê°œìˆ˜: $(grep -c '<uses-permission' manifest_check/AndroidManifest.xml 2>/dev/null || echo "0")"
            
          else
            echo "âŒ AndroidManifest.xml ì¶”ì¶œ ì‹¤íŒ¨"
          fi
        else
          echo "âŒ AndroidManifest.xml ì—†ìŒ - APK ì†ìƒ"
        fi
    
    # APK ìˆ˜ì • ë° ì¬ìƒì„±
    - name: Fix APK issues and regenerate
      run: |
        echo "=== ğŸ”§ APK ë¬¸ì œ ìˆ˜ì • ë° ì¬ìƒì„± ==="
        
        # 1. ì›ë³¸ buildozer APK í™•ì¸
        echo "--- ğŸ“± ì›ë³¸ buildozer APK í™•ì¸ ---"
        ORIGINAL_APK="$APK_FILE"
        if [ -f "$ORIGINAL_APK" ]; then
          echo "âœ… ì›ë³¸ APK: $ORIGINAL_APK"
          echo "ğŸ“Š ì›ë³¸ í¬ê¸°: $(du -h "$ORIGINAL_APK" | cut -f1)"
          
          # ì›ë³¸ APK ì„œëª… í™•ì¸
          echo "ğŸ” ì›ë³¸ APK ì„œëª… í™•ì¸:"
          jarsigner -verify "$ORIGINAL_APK" 2>&1 && echo "âœ… ì›ë³¸ ì„œëª…ë¨" || echo "âš ï¸ ì›ë³¸ ì„œëª… ì•ˆë¨"
          
          # ì›ë³¸ì„ ë°±ì—…ìš©ìœ¼ë¡œ ë³µì‚¬
          cp "$ORIGINAL_APK" original_backup.apk
          echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
        else
          echo "âŒ ì›ë³¸ APK ì—†ìŒ"
          exit 1
        fi
        
        # 2. ê¹¨ë—í•œ APK ìˆ˜ì • ê³¼ì •
        echo ""
        echo "--- ğŸ§¹ ê¹¨ë—í•œ APK ìˆ˜ì • ì‹œì‘ ---"
        
        # ê¸°ì¡´ ë””ì»´íŒŒì¼ ë””ë ‰í† ë¦¬ ì •ë¦¬
        rm -rf decoded_apk_clean manifest_check
        
        # ì›ë³¸ APK ë””ì»´íŒŒì¼
        echo "ğŸ“¦ ì›ë³¸ APK ë””ì»´íŒŒì¼..."
        apktool d "$ORIGINAL_APK" -o decoded_apk_clean --force
        
        if [ ! -d "decoded_apk_clean" ]; then
          echo "âŒ APK ë””ì»´íŒŒì¼ ì‹¤íŒ¨"
          exit 1
        fi
        
        # AndroidManifest.xml ë°±ì—…
        cp decoded_apk_clean/AndroidManifest.xml decoded_apk_clean/AndroidManifest.xml.backup
        
        # 3. AndroidManifest.xml ì‹ ì¤‘í•˜ê²Œ ìˆ˜ì •
        echo ""
        echo "--- ğŸ“ AndroidManifest.xml ì‹ ì¤‘í•œ ìˆ˜ì • ---"
        
        MANIFEST="decoded_apk_clean/AndroidManifest.xml"
        
        # í˜„ì¬ ìƒíƒœ í™•ì¸
        echo "ğŸ” ìˆ˜ì • ì „ ìƒíƒœ:"
        echo "receiver ê°œìˆ˜: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")"
        echo "AlarmReceiver ì¡´ì¬: $(grep -c 'AlarmReceiver' "$MANIFEST" 2>/dev/null || echo "0")"
        
        # AlarmReceiverê°€ ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âš ï¸ AlarmReceiver ì´ë¯¸ ì¡´ì¬í•¨ - ìˆ˜ì •í•˜ì§€ ì•ŠìŒ"
        else
          echo "â• AlarmReceiver ì¶”ê°€ ì¤‘..."
          
          # </application> íƒœê·¸ ë°”ë¡œ ì•ì— receiver ì¶”ê°€
          if grep -q "</application>" "$MANIFEST"; then
            # ì„ì‹œ íŒŒì¼ ì‚¬ìš©í•˜ì—¬ ì•ˆì „í•˜ê²Œ ìˆ˜ì •
            awk '
            /<\/application>/ {
              print "        <receiver android:name=\"org.kivy.skkutimetable.doublecheck.AlarmReceiver\" android:enabled=\"true\" android:exported=\"true\">"
              print "            <intent-filter>"
              print "                <action android:name=\"android.intent.action.BOOT_COMPLETED\" />"
              print "            </intent-filter>"
              print "        </receiver>"
            }
            { print }
            ' "$MANIFEST" > "${MANIFEST}.tmp" && mv "${MANIFEST}.tmp" "$MANIFEST"
            
            echo "âœ… AlarmReceiver ì¶”ê°€ ì™„ë£Œ"
          else
            echo "âŒ </application> íƒœê·¸ ì—†ìŒ - ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì¡° ì´ìƒ"
            exit 1
          fi
        fi
        
        # 4. ìˆ˜ì • ê²°ê³¼ ê²€ì¦
        echo ""
        echo "--- ğŸ” ìˆ˜ì • ê²°ê³¼ ê²€ì¦ ---"
        echo "ìˆ˜ì • í›„ receiver ê°œìˆ˜: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")"
        echo "AlarmReceiver ì¡´ì¬: $(grep -c 'AlarmReceiver' "$MANIFEST" 2>/dev/null || echo "0")"
        
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âœ… AlarmReceiver í™•ì¸ë¨"
        else
          echo "âŒ AlarmReceiver ì¶”ê°€ ì‹¤íŒ¨"
          exit 1
        fi
    
    # ì‹ ì¤‘í•œ APK ë¦¬ë¹Œë“œ ë° ì„œëª…
    - name: Careful APK rebuild and signing
      run: |
        echo "=== ğŸ”¨ ì‹ ì¤‘í•œ APK ë¦¬ë¹Œë“œ ë° ì„œëª… ==="
        
        # 1. APK ë¦¬ë¹Œë“œ
        echo "--- ğŸ“¦ APK ë¦¬ë¹Œë“œ ---"
        apktool b decoded_apk_clean -o rebuilt_doublecheck.apk
        
        if [ ! -f "rebuilt_doublecheck.apk" ]; then
          echo "âŒ APK ë¦¬ë¹Œë“œ ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "âœ… APK ë¦¬ë¹Œë“œ ì„±ê³µ"
        echo "ğŸ“Š ë¦¬ë¹Œë“œ APK í¬ê¸°: $(du -h rebuilt_doublecheck.apk | cut -f1)"
        
        # 2. ê¸°ì¡´ ì„œëª… ì œê±° (í•„ìš”ì‹œ)
        echo ""
        echo "--- ğŸ—‘ï¸ ê¸°ì¡´ ì„œëª… ì œê±° ---"
        zip -d rebuilt_doublecheck.apk META-INF/\* 2>/dev/null || echo "ê¸°ì¡´ ì„œëª… ì—†ìŒ"
        
        # 3. ìƒˆë¡œìš´ ì„œëª… ì ìš©
        echo ""
        echo "--- âœï¸ ìƒˆë¡œìš´ ì„œëª… ì ìš© ---"
        
        # ë””ë²„ê·¸ í‚¤ìŠ¤í† ì–´ê°€ ì—†ìœ¼ë©´ ìƒì„±
        if [ ! -f "debug.keystore" ]; then
          echo "ğŸ”‘ ë””ë²„ê·¸ í‚¤ìŠ¤í† ì–´ ìƒì„±..."
          keytool -genkey -v \
            -keystore debug.keystore \
            -alias androiddebugkey \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" \
            -storepass android \
            -keypass android
        fi
        
        # APK ì„œëª…
        echo "ğŸ” APK ì„œëª… ì¤‘..."
        jarsigner -verbose \
          -sigalg SHA256withRSA \
          -digestalg SHA-256 \
          -keystore debug.keystore \
          -storepass android \
          -keypass android \
          rebuilt_doublecheck.apk \
          androiddebugkey
        
        # ì„œëª… ê²€ì¦
        echo ""
        echo "ğŸ” ì„œëª… ê²€ì¦:"
        if jarsigner -verify rebuilt_doublecheck.apk 2>/dev/null; then
          echo "âœ… ì„œëª… ê²€ì¦ ì„±ê³µ"
        else
          echo "âŒ ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
          exit 1
        fi
        
        # 4. zipalign (ì„ íƒì )
        echo ""
        echo "--- ğŸ”§ APK ì •ë ¬ (zipalign) ---"
        
        ZIPALIGN_PATH="$HOME/android-sdk/build-tools/33.0.2/zipalign"
        if [ -f "$ZIPALIGN_PATH" ]; then
          echo "ğŸ¯ APK ì •ë ¬ ì¤‘..."
          $ZIPALIGN_PATH -f 4 rebuilt_doublecheck.apk final_doublecheck_fixed.apk
          
          if [ -f "final_doublecheck_fixed.apk" ]; then
            echo "âœ… APK ì •ë ¬ ì™„ë£Œ"
            echo "ğŸ“Š ìµœì¢… APK í¬ê¸°: $(du -h final_doublecheck_fixed.apk | cut -f1)"
          else
            echo "âš ï¸ zipalign ì‹¤íŒ¨ - ì„œëª…ëœ APK ì‚¬ìš©"
            cp rebuilt_doublecheck.apk final_doublecheck_fixed.apk
          fi
        else
          echo "âš ï¸ zipalign ì—†ìŒ - ì„œëª…ëœ APK ì‚¬ìš©"
          cp rebuilt_doublecheck.apk final_doublecheck_fixed.apk
        fi
    
    # ìµœì¢… APK ê²€ì¦
    - name: Final APK validation
      run: |
        echo "=== ğŸ¯ ìµœì¢… APK ê²€ì¦ ==="
        
        APK_TO_TEST="final_doublecheck_fixed.apk"
        
        if [ ! -f "$APK_TO_TEST" ]; then
          echo "âŒ ìµœì¢… APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ“± ìµœì¢… APK ì •ë³´:"
        echo "íŒŒì¼ëª…: $APK_TO_TEST"
        echo "í¬ê¸°: $(du -h "$APK_TO_TEST" | cut -f1)"
        echo "ê¶Œí•œ: $(ls -la "$APK_TO_TEST")"
        
        echo ""
        echo "--- ğŸ” ì„œëª… ê²€ì¦ ---"
        if jarsigner -verify "$APK_TO_TEST" 2>/dev/null; then
          echo "âœ… ì„œëª… ìœ íš¨"
        else
          echo "âŒ ì„œëª… ë¬´íš¨"
        fi
        
        echo ""
        echo "--- ğŸ“‹ ìµœì¢… AndroidManifest.xml í™•ì¸ ---"
        apktool d "$APK_TO_TEST" -o final_verification --force >/dev/null 2>&1
        
        if [ -f "final_verification/AndroidManifest.xml" ]; then
          FINAL_MANIFEST="final_verification/AndroidManifest.xml"
          
          echo "ğŸ” ê¸°ë³¸ ì •ë³´:"
          echo "package: $(grep 'package=' "$FINAL_MANIFEST" | head -1)"
          echo "versionCode: $(grep 'android:versionCode=' "$FINAL_MANIFEST" | head -1)"
          echo "minSdkVersion: $(grep 'android:minSdkVersion=' "$FINAL_MANIFEST" | head -1)"
          
          echo ""
          echo "ğŸ” ì»´í¬ë„ŒíŠ¸ ê°œìˆ˜:"
          echo "activity: $(grep -c '<activity' "$FINAL_MANIFEST" 2>/dev/null || echo "0")"
          echo "receiver: $(grep -c '<receiver' "$FINAL_MANIFEST" 2>/dev/null || echo "0")"
          echo "service: $(grep -c '<service' "$FINAL_MANIFEST" 2>/dev/null || echo "0")"
          
          echo ""
          echo "ğŸ¯ AlarmReceiver ìµœì¢… í™•ì¸:"
          if grep -q "AlarmReceiver" "$FINAL_MANIFEST"; then
            echo "âœ… AlarmReceiver ì •ìƒ í¬í•¨!"
            grep -A 6 -B 2 "AlarmReceiver" "$FINAL_MANIFEST"
          else
            echo "âŒ AlarmReceiver ì—†ìŒ"
          fi
          
          echo ""
          echo "ğŸ” MAIN ì•¡í‹°ë¹„í‹° í™•ì¸:"
          if grep -A 10 'android.intent.action.MAIN' "$FINAL_MANIFEST" | grep -q 'android:name'; then
            echo "âœ… MAIN ì•¡í‹°ë¹„í‹° ì¡´ì¬"
            grep -A 3 -B 1 'android.intent.action.MAIN' "$FINAL_MANIFEST" | head -10
          else
            echo "âŒ MAIN ì•¡í‹°ë¹„í‹° ì—†ìŒ - ì•± ì‹¤í–‰ ë¶ˆê°€"
          fi
          
        else
          echo "âŒ ìµœì¢… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
        fi
        
        echo ""
        echo "ğŸ‰ ìµœì¢… ìˆ˜ì •ëœ APK ì¤€ë¹„ ì™„ë£Œ: $APK_TO_TEST"
    
    # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (ìˆ˜ì •ë¨)
    - name: Upload fixed APK
      uses: actions/upload-artifact@v4
      with:
        name: fixed-signed-apk
        path: |
          final_doublecheck_fixed.apk
          original_backup.apk
          final_verification/AndroidManifest.xml
        retention-days: 7

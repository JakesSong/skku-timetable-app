name: ðŸ”§ Modify APK and Inject AlarmReceiver

on:
  workflow_dispatch:
    inputs:
      apk_url:
        description: 'APK ë‹¤ìš´ë¡œë“œ URL'
        required: true
        default: 'https://example.com/app.apk'

env:
  ORIGINAL_APK: original_backup.apk

jobs:
  modify-apk:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y unzip openjdk-11-jdk wget
        wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O apktool
        wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar -O apktool.jar
        chmod +x apktool
        sudo mv apktool apktool.jar /usr/local/bin/

    - name: Download original APK
      run: |
        wget "${{ github.event.inputs.apk_url }}" -O "$ORIGINAL_APK"

    - name: Decode APK using apktool
      run: |
        apktool d "$ORIGINAL_APK" -o decoded_apk --force

    - name: Inject AlarmReceiver into AndroidManifest.xml
      run: |
        sed -i '/<\/application>/i \
        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">\n            <intent-filter>\n                <action android:name="android.intent.action.BOOT_COMPLETED" />\n            </intent-filter>\n        </receiver>' decoded_apk/AndroidManifest.xml

    - name: Rebuild APK
      run: |
        apktool b decoded_apk -o rebuilt.apk --force-all

    - name: Remove existing signatures
      run: |
        zip -d rebuilt.apk META-INF/* || true

    - name: Generate debug keystore if needed
      run: |
        if [ ! -f debug.keystore ]; then
          keytool -genkey -v -keystore debug.keystore \
            -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US" \
            -storepass android -keypass android
        fi

    - name: Sign APK
      run: |
        jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
          -keystore debug.keystore -storepass android -keypass android \
          rebuilt.apk androiddebugkey

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: alarmreceiver-injected-apk
        path: rebuilt.apk

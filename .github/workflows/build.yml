name: Build Android APK

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # ðŸ” .jar ë° .java íŒŒì¼ë§Œ í™•ì¸
    - name: Check jar and java file visibility
      run: |
        echo "=== ðŸ” jar íŒŒì¼ í™•ì¸ ì‹œìž‘ ==="
        ls -la android
        ls -la android/libs
        if [ -f "android/libs/alarmreceiver.jar" ]; then
          echo "âœ… alarmreceiver.jar ë°œê²¬ë¨"
        else
          echo "âŒ alarmreceiver.jar ì—†ìŒ"
        fi

        echo "=== ðŸ” java íŒŒì¼ ê²½ë¡œ í™•ì¸ ==="
        find android/src -type f -name "*.java" || echo "âŒ java íŒŒì¼ ì—†ìŒ"
        if [ -d "android/src/main/java/org/kivy/skkutimetable/doublecheck" ]; then
          echo "âœ… java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¡´ìž¬í•¨"
          ls -R android/src/main/java/org/kivy/skkutimetable/doublecheck
        else
          echo "âŒ java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi

    # ðŸ“¦ ë¹Œë“œ ë¡œê·¸ ë° ìžë°” í™•ì¸ìš© íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: java-jar-check-${{ github.run_number }}
        path: |
          android/libs/alarmreceiver.jar
          android/src/main/java/org/kivy/skkutimetable/doublecheck/*.java
        retention-days: 7
        if-no-files-found: warn

    ##########################################
    ## â›” ì•„ëž˜ëŠ” ë¹Œë“œ ê´€ë ¨ Step - ì£¼ì„ì²˜ë¦¬ë¨ ##
    ##########################################

    # - name: Set up Java 17 for buildozer
    #   uses: actions/setup-java@v4
    #   with:
    #     distribution: 'temurin'
    #     java-version: '17'

    # - name: Install system dependencies
    #   run: |
    #     sudo apt-get update -qq
    #     sudo apt-get install -y \
    #       git zip unzip autoconf libtool pkg-config \
    #       zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
    #       libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
    #       bzip2 libbz2-dev libreadline-dev llvm \
    #       xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
    #       libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
    #       libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
    #       libfreetype6-dev libpng-dev libjpeg-dev

    # - name: Install Python dependencies
    #   run: |
    #     python -m pip install --upgrade pip
    #     pip install --upgrade setuptools wheel
    #     pip install Cython==0.29.33
    #     pip install buildozer==1.5.0

    # - name: Set environment variables
    #   run: |
    #     echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
    #     echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
    #     echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # - name: Complete clean build
    #   run: |
    #     echo "=== Completely cleaning build environment ==="
    #     rm -rf .buildozer
    #     rm -rf bin
    #     rm -rf ~/.buildozer
    #     rm -rf ~/.gradle
    #     rm -rf ~/.android

    # - name: Build APK (force rebuild)
    #   run: |
    #     buildozer android debug --verbose
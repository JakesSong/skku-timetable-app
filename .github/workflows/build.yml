name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    # âœ… .jar ë° .java íŒŒì¼ ê²½ë¡œ í™•ì¸
    - name: Check jar and java file visibility
      run: |
        echo "=== ğŸ” jar íŒŒì¼ í™•ì¸ ì‹œì‘ ==="
        ls -la android
        ls -la android/libs
        if [ -f "android/libs/alarmreceiver.jar" ]; then
          echo "âœ… alarmreceiver.jar ë°œê²¬ë¨"
        else
          echo "âŒ alarmreceiver.jar ì—†ìŒ"
        fi
        echo "=== ğŸ” java íŒŒì¼ ê²½ë¡œ í™•ì¸ ==="
        find android/src -type f -name "*.java" || echo "âŒ java íŒŒì¼ ì—†ìŒ"
        if [ -d "android/src/main/java/org/kivy/skkutimetable/doublecheck" ]; then
          echo "âœ… java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¡´ì¬í•¨"
          ls -R android/src/main/java/org/kivy/skkutimetable/doublecheck
        else
          echo "âŒ java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi

    # ğŸ”¥ NEW: AndroidManifest.tmpl.xml ì¡´ì¬ í™•ì¸
    - name: Check AndroidManifest.tmpl.xml
      run: |
        echo "=== ğŸ” AndroidManifest.tmpl.xml í™•ì¸ ==="
        if [ -f "AndroidManifest.tmpl.xml" ]; then
          echo "âœ… AndroidManifest.tmpl.xml ì¡´ì¬í•¨"
          echo "íŒŒì¼ í¬ê¸°: $(wc -c < AndroidManifest.tmpl.xml) bytes"
          echo "=== AndroidManifest.tmpl.xml ë‚´ìš© í™•ì¸ ==="
          grep -n "AlarmReceiver" AndroidManifest.tmpl.xml || echo "âŒ AlarmReceiver ì—†ìŒ"
          grep -n "android:name.*AlarmReceiver" AndroidManifest.tmpl.xml || echo "âŒ AlarmReceiver name ì—†ìŒ"
        else
          echo "âŒ AndroidManifest.tmpl.xml ì—†ìŒ"
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬ íŒŒì¼ë“¤:"
          ls -la
        fi
        
        echo "=== buildozer.spec manifest ì„¤ì • í™•ì¸ ==="
        grep -n "android.manifest_template" buildozer.spec || echo "âŒ manifest_template ì„¤ì • ì—†ìŒ"
        grep -n "android.add_manifest_xml" buildozer.spec || echo "add_manifest_xml ì„¤ì • ì—†ìŒ (ì •ìƒ)"

    # âœ… Java ë° jar íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload Java and jar files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: java-jar-check-${{ github.run_number }}
        path: |
          android/libs/alarmreceiver.jar
          android/src/main/java/org/kivy/skkutimetable/doublecheck/*.java
          AndroidManifest.tmpl.xml
        retention-days: 7
        if-no-files-found: warn

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.5.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== Completely cleaning build environment ==="
        rm -rf .buildozer
        rm -rf bin
        rm -rf ~/.buildozer
        rm -rf ~/.gradle
        rm -rf ~/.android

    # ğŸ”¥ NEW: ë¹Œë“œ ì „ ìµœì¢… íŒŒì¼ í™•ì¸
    - name: Final pre-build verification
      run: |
        echo "=== ğŸ” ë¹Œë“œ ì „ ìµœì¢… í™•ì¸ ==="
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬:"
        pwd
        echo "íŒŒì¼ ëª©ë¡:"
        ls -la
        echo "AndroidManifest.tmpl.xml ì¡´ì¬ ì—¬ë¶€:"
        [ -f "AndroidManifest.tmpl.xml" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ"
        echo "buildozer.spec ì„¤ì •:"
        grep "android.manifest_template" buildozer.spec

    # âœ… ë¹Œë“œ ìˆ˜í–‰ ë° ë¡œê·¸ ì €ì¥
    - name: Build APK
      run: |
        echo "=== Build start ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          echo "=== AndroidManifest ê´€ë ¨ ë¡œê·¸ ê²€ìƒ‰ ==="
          grep -i "manifest" build_full.log | tail -20 || echo "manifest ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # ğŸ”¥ NEW: ë¹Œë“œ í›„ ìƒì„±ëœ AndroidManifest.xml í™•ì¸
    - name: Check generated AndroidManifest.xml
      if: always()
      run: |
        echo "=== ğŸ” ìƒì„±ëœ AndroidManifest.xml í™•ì¸ ==="
        MANIFEST_PATH=$(find .buildozer -name "AndroidManifest.xml" 2>/dev/null | head -1)
        if [ -n "$MANIFEST_PATH" ] && [ -f "$MANIFEST_PATH" ]; then
          echo "âœ… ìƒì„±ëœ AndroidManifest.xml ë°œê²¬: $MANIFEST_PATH"
          echo "=== AlarmReceiver ë“±ë¡ í™•ì¸ ==="
          grep -A 5 -B 5 "AlarmReceiver" "$MANIFEST_PATH" || echo "âŒ AlarmReceiver ì—†ìŒ"
          echo "=== ì „ì²´ receiver ëª©ë¡ ==="
          grep -n "<receiver" "$MANIFEST_PATH" || echo "âŒ receiver ì—†ìŒ"
        else
          echo "âŒ ìƒì„±ëœ AndroidManifest.xml ì—†ìŒ"
          echo "buildozer ë””ë ‰í† ë¦¬ êµ¬ì¡°:"
          find .buildozer -name "*.xml" 2>/dev/null | head -10 || echo "xml íŒŒì¼ ì—†ìŒ"
        fi

    # âœ… ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          .buildozer/**/*.log
          .buildozer/**/AndroidManifest.xml
        retention-days: 30
        if-no-files-found: warn

    # âœ… APK ì—…ë¡œë“œ
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: skku-timetable-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

# âœ… APK ìˆ˜ì • (ZIP ë°©ì‹ìœ¼ë¡œ ì§ì ‘ êµì²´ - aapt í¬ê¸°!)
- name: Modify APK with direct ZIP method (bypass aapt)
  run: |
    echo "=== ğŸ”§ APK ìˆ˜ì • (ZIP ì§ì ‘ ë°©ì‹ìœ¼ë¡œ AlarmReceiver ì¶”ê°€) ==="
    
    if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
      echo "âŒ ì›ë³¸ APK ì—†ìŒ"
      exit 1
    fi
    
    echo "ğŸ¯ ëŒ€ìƒ APK: $ORIGINAL_APK"
    
    # ë°±ì—… ìƒì„±
    cp "$ORIGINAL_APK" original_backup.apk
    echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
    
    # ì‘ì—… ë””ë ‰í† ë¦¬ ìƒì„±
    mkdir -p zip_work
    cd zip_work
    
    # APKë¥¼ ZIPìœ¼ë¡œ ì²˜ë¦¬
    cp "../$ORIGINAL_APK" work.apk
    
    # 1. í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
    unzip -j work.apk AndroidManifest.xml
    echo "ğŸ“„ ì›ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ"
    
    # 2. aapt dumpë¥¼ ì‚¬ìš©í•´ì„œ XML í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
    aapt dump xmltree work.apk AndroidManifest.xml > manifest_text.txt
    echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ë³€í™˜ ì™„ë£Œ"
    
    # 3. í…œí”Œë¦¿ì´ ìˆë‹¤ë©´ ì‚¬ìš©, ì—†ë‹¤ë©´ ì›ë³¸ ê¸°ë°˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±
    if [ -f "../AndroidManifest.tmpl.xml" ]; then
      echo "âœ… í…œí”Œë¦¿ íŒŒì¼ ì‚¬ìš©"
      cp "../AndroidManifest.tmpl.xml" new_manifest_text.xml
    else
      echo "âŒ í…œí”Œë¦¿ ì—†ìŒ - ì›ë³¸ ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬"
      
      # ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± (ìµœì†Œí•œë§Œ)
      cat > new_manifest_text.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="org.kivy.skkutimetable.doublecheck"
    android:versionCode="1"
    android:versionName="0.1">
    
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    
    <application android:label="DoubleCheck">
        <activity android:name="org.kivy.android.PythonActivity"
                  android:label="DoubleCheck"
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        
        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" 
                  android:enabled="true" 
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
    </application>
</manifest>
EOF
      echo "ğŸ“„ ê¸°ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì™„ë£Œ"
    fi
    
    # 4. receiver ì¶”ê°€ (í…œí”Œë¦¿ì— ì—†ëŠ” ê²½ìš°ë§Œ)
    if ! grep -q "AlarmReceiver" new_manifest_text.xml; then
      echo "ğŸ“ AlarmReceiver ì¶”ê°€ ì¤‘..."
      sed -i 's|</application>|    <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true"><intent-filter><action android:name="android.intent.action.BOOT_COMPLETED" /></intent-filter></receiver></application>|' new_manifest_text.xml
    else
      echo "âœ… AlarmReceiver ì´ë¯¸ ì¡´ì¬"
    fi
    
    # 5. í…ìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜
    echo "ğŸ”„ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì¤‘..."
    
    # ì„ì‹œ APK ìƒì„± (ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë§Œ)
    mkdir -p temp_res/values
    echo '<?xml version="1.0" encoding="utf-8"?><resources><string name="app_name">DoubleCheck</string></resources>' > temp_res/values/strings.xml
    
    aapt package -f \
      -M new_manifest_text.xml \
      -S temp_res \
      -I "/home/runner/android-sdk/platforms/android-33/android.jar" \
      -F temp_with_manifest.apk
    
    if [ -f "temp_with_manifest.apk" ]; then
      echo "âœ… ì„ì‹œ APK ìƒì„± ì„±ê³µ"
      
      # ìƒˆ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
      unzip -j temp_with_manifest.apk AndroidManifest.xml -d new_manifest
      
      if [ -f "new_manifest/AndroidManifest.xml" ]; then
        echo "âœ… ìƒˆ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì„±ê³µ"
        
        # ì›ë³¸ APKì— ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚½ì…
        cp work.apk final.apk
        cd new_manifest
        zip -u ../final.apk AndroidManifest.xml
        cd ..
        
        echo "ğŸ“¦ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµì²´ ì™„ë£Œ"
        
        # ê²€ì¦
        if aapt dump badging final.apk >/dev/null 2>&1; then
          echo "âœ… ìˆ˜ì •ëœ APK ìœ íš¨ì„± ê²€ì‚¬ í†µê³¼"
          
          # receiver ê°œìˆ˜ í™•ì¸
          RECEIVER_COUNT=$(aapt dump xmltree final.apk AndroidManifest.xml | grep -c "receiver" || echo "0")
          echo "ğŸ“± Receiver ê°œìˆ˜: $RECEIVER_COUNT"
          
          # ìµœì¢… APK ë³µì‚¬
          cp final.apk ../final_doublecheck_fixed.apk
          echo "ğŸ‰ ìµœì¢… APK ìƒì„± ì„±ê³µ: final_doublecheck_fixed.apk"
          
        else
          echo "âŒ ìˆ˜ì •ëœ APK ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨"
          aapt dump badging final.apk 2>&1 | head -5
          exit 1
        fi
      else
        echo "âŒ ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
        exit 1
      fi
    else
      echo "âŒ ì„ì‹œ APK ìƒì„± ì‹¤íŒ¨"
      exit 1
    fi
    
    cd ..

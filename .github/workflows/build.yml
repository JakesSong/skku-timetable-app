name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    # âœ… .jar ë° .java íŒŒì¼ ê²½ë¡œ í™•ì¸
    - name: Check jar and java file visibility
      run: |
        echo "=== ğŸ” jar íŒŒì¼ í™•ì¸ ì‹œì‘ ==="
        ls -la android
        ls -la android/libs
        if [ -f "android/libs/alarmreceiver.jar" ]; then
          echo "âœ… alarmreceiver.jar ë°œê²¬ë¨"
        else
          echo "âŒ alarmreceiver.jar ì—†ìŒ"
        fi
        echo "=== ğŸ” java íŒŒì¼ ê²½ë¡œ í™•ì¸ ==="
        find android/src -type f -name "*.java" || echo "âŒ java íŒŒì¼ ì—†ìŒ"
        if [ -d "android/src/main/java/org/kivy/skkutimetable/doublecheck" ]; then
          echo "âœ… java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¡´ì¬í•¨"
          ls -R android/src/main/java/org/kivy/skkutimetable/doublecheck
        else
          echo "âŒ java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi

    # ğŸ”¥ NEW: AndroidManifest.tmpl.xml íŒŒì¼ ì¡´ì¬ ë° ë‚´ìš© í™•ì¸
    - name: Check AndroidManifest template file
      run: |
        echo "=== ğŸ” AndroidManifest.tmpl.xml íŒŒì¼ í™•ì¸ ==="
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo ""
        echo "--- ëª¨ë“  manifest ê´€ë ¨ íŒŒì¼ ì°¾ê¸° ---"
        find . -maxdepth 2 -name "*manifest*" -o -name "*Manifest*" | head -10
        echo ""
        echo "--- AndroidManifest.tmpl.xml ì¡´ì¬ ì—¬ë¶€ ---"
        if [ -f "AndroidManifest.tmpl.xml" ]; then
          echo "âœ… AndroidManifest.tmpl.xml ë°œê²¬!"
          echo "íŒŒì¼ í¬ê¸°: $(wc -c < AndroidManifest.tmpl.xml) bytes"
          echo "íŒŒì¼ ê¶Œí•œ: $(ls -la AndroidManifest.tmpl.xml)"
          echo ""
          echo "=== ğŸ“‹ íŒŒì¼ ë‚´ìš© ì „ì²´ ì¶œë ¥ ==="
          cat AndroidManifest.tmpl.xml
          echo ""
          echo "=== ğŸ” AlarmReceiver ê²€ìƒ‰ ==="
          if grep -q "AlarmReceiver" AndroidManifest.tmpl.xml; then
            echo "âœ… AlarmReceiver ë°œê²¬!"
            grep -A 5 -B 2 "AlarmReceiver" AndroidManifest.tmpl.xml
          else
            echo "âŒ AlarmReceiver ì—†ìŒ"
          fi
        else
          echo "âŒ AndroidManifest.tmpl.xml íŒŒì¼ ì—†ìŒ!"
          echo "ë£¨íŠ¸ ë””ë ‰í† ë¦¬ íŒŒì¼ ëª©ë¡:"
          ls -la
        fi
        
        echo ""
        echo "=== ğŸ”§ buildozer.spec manifest ì„¤ì • í™•ì¸ ==="
        if [ -f "buildozer.spec" ]; then
          echo "--- manifest ê´€ë ¨ ì„¤ì •ë“¤ ---"
          grep -n "manifest" buildozer.spec || echo "manifest ì„¤ì • ì—†ìŒ"
          echo ""
          echo "--- android.manifest_template ì„¤ì • ---"
          grep -n "android.manifest_template" buildozer.spec || echo "android.manifest_template ì„¤ì • ì—†ìŒ"
        else
          echo "âŒ buildozer.spec íŒŒì¼ ì—†ìŒ"
        fi

    # ğŸ”¥ NEW: buildozer ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…œí”Œë¦¿ ì²˜ë¦¬ í™•ì¸
    - name: Debug buildozer manifest template processing
      run: |
        echo "=== ğŸ” buildozer ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…œí”Œë¦¿ ì²˜ë¦¬ ë””ë²„ê¹… ==="
        
        # buildozer.specì—ì„œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê´€ë ¨ ì„¤ì • ìƒì„¸ í™•ì¸
        echo "--- buildozer.spec ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì • ìƒì„¸ ---"
        grep -A 3 -B 3 "manifest" buildozer.spec || echo "manifest ì„¤ì • ì—†ìŒ"

    # ğŸ”¥ NEW: AndroidManifest.tmpl.xml ê°•ì œ ì²˜ë¦¬
    - name: Force copy AndroidManifest template
      run: |
        echo "=== ğŸ”§ AndroidManifest.tmpl.xml ê°•ì œ ì²˜ë¦¬ ==="
        
        if [ -f "AndroidManifest.tmpl.xml" ]; then
          echo "âœ… í…œí”Œë¦¿ íŒŒì¼ ì¡´ì¬, ê°•ì œ ë³µì‚¬ ì‹œë„"
          
          # buildozer ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p .buildozer/android/platform/
          
          # ë‹¤ì–‘í•œ ìœ„ì¹˜ì— ë³µì‚¬ ì‹œë„
          echo "--- ë‹¤ì–‘í•œ ìœ„ì¹˜ì— í…œí”Œë¦¿ ë³µì‚¬ ---"
          cp AndroidManifest.tmpl.xml .buildozer/ || echo "buildozer ë£¨íŠ¸ ë³µì‚¬ ì‹¤íŒ¨"
          cp AndroidManifest.tmpl.xml .buildozer/android/ || echo "android ë””ë ‰í† ë¦¬ ë³µì‚¬ ì‹¤íŒ¨"
          cp AndroidManifest.tmpl.xml .buildozer/android/platform/ || echo "platform ë””ë ‰í† ë¦¬ ë³µì‚¬ ì‹¤íŒ¨"
          
          echo "ë³µì‚¬ ì™„ë£Œ"
        else
          echo "âŒ AndroidManifest.tmpl.xml ì—†ì–´ì„œ ë³µì‚¬ ë¶ˆê°€"
          
          # ì—†ìœ¼ë©´ ê°„ë‹¨í•œ í…œí”Œë¦¿ ìƒì„±
          echo "--- ê¸°ë³¸ í…œí”Œë¦¿ ìƒì„± ---"
          cat > AndroidManifest.tmpl.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="{{ args.package }}"
            android:versionCode="{{ args.numeric_version }}"
            android:versionName="{{ args.version }}"
            android:installLocation="auto">
        
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
            <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
            <uses-permission android:name="android.permission.WAKE_LOCK" />
        
            <application
                android:label="@string/app_name"
                android:icon="@mipmap/icon"
                android:allowBackup="true"
                android:theme="@android:style/Theme.NoTitleBar"
                android:hardwareAccelerated="true">
        
                <activity android:name=".MainActivity"
                          android:label="@string/app_name"
                          android:configChanges="keyboardHidden|orientation|screenSize|screenLayout|uiMode"
                          android:launchMode="singleTask"
                          android:exported="true">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
        
                <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" 
                          android:exported="false">
                    <intent-filter>
                        <action android:name="android.intent.action.BOOT_COMPLETED" />
                        <action android:name="android.intent.action.MY_PACKAGE_REPLACED" />
                        <action android:name="android.intent.action.PACKAGE_REPLACED" />
                        <data android:scheme="package" />
                    </intent-filter>
                </receiver>
        
                <service android:name="org.kivy.android.PythonService"
                         android:process=":python" />
            </application>
        </manifest>
        EOF
          echo "âœ… ê¸°ë³¸ AndroidManifest.tmpl.xml ìƒì„± ì™„ë£Œ"
        fi

    # ğŸ”¥ NEW: ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì²˜ë¦¬ ê³¼ì • ì™„ì „ ì¶”ì 
    - name: Deep manifest processing debug
      run: |
        echo "=== ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ ì¡´ì¬ í™•ì¸ ==="
        
        # 1. ì†ŒìŠ¤ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ í™•ì¸
        echo "--- ì†ŒìŠ¤ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ ---"
        if [ -f "AndroidManifest.tmpl.xml" ]; then
          echo "âœ… AndroidManifest.tmpl.xml ì¡´ì¬ ($(wc -c < AndroidManifest.tmpl.xml) bytes)"
          echo "AlarmReceiver í¬í•¨: $(grep -c "AlarmReceiver" AndroidManifest.tmpl.xml)"
        else
          echo "âŒ AndroidManifest.tmpl.xml ì—†ìŒ"
        fi
        
        if [ -f "android/manifest_additions.xml" ]; then
          echo "âœ… android/manifest_additions.xml ì¡´ì¬ ($(wc -c < android/manifest_additions.xml) bytes)"
          echo "AlarmReceiver í¬í•¨: $(grep -c "AlarmReceiver" android/manifest_additions.xml)"
        else
          echo "âŒ android/manifest_additions.xml ì—†ìŒ"
        fi
        
        # 2. buildozer.spec ì„¤ì • í™•ì¸
        echo ""
        echo "--- buildozer.spec ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì • ---"
        grep -n "android.manifest" buildozer.spec || echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì„¤ì • ì—†ìŒ"
        
        # 3. buildozer ë²„ì „ ë° p4a ë²„ì „ í™•ì¸
        echo ""
        echo "--- buildozer/p4a ë²„ì „ ì •ë³´ ---"
        buildozer --version || echo "buildozer ë²„ì „ í™•ì¸ ì‹¤íŒ¨"

    # âœ… Java ë° jar íŒŒì¼ ì—…ë¡œë“œ
    - name: Upload Java and jar files
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: java-jar-check-${{ github.run_number }}
        path: |
          android/libs/alarmreceiver.jar
          android/src/main/java/org/kivy/skkutimetable/doublecheck/*.java
          AndroidManifest.tmpl.xml
        retention-days: 7
        if-no-files-found: warn

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.5.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== Completely cleaning build environment ==="
        rm -rf .buildozer
        rm -rf bin
        rm -rf ~/.buildozer
        rm -rf ~/.gradle
        rm -rf ~/.android

    # ğŸ”¥ NEW: ë¹Œë“œ ì „ ìµœì¢… íŒŒì¼ í™•ì¸
    - name: Final pre-build verification
      run: |
        echo "=== ğŸ” ë¹Œë“œ ì „ ìµœì¢… í™•ì¸ ==="
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬:"
        pwd
        echo "íŒŒì¼ ëª©ë¡:"
        ls -la
        echo "AndroidManifest.tmpl.xml ì¡´ì¬ ì—¬ë¶€:"
        [ -f "AndroidManifest.tmpl.xml" ] && echo "âœ… ì¡´ì¬" || echo "âŒ ì—†ìŒ"
        echo "buildozer.spec ì„¤ì •:"
        grep "android.manifest_template" buildozer.spec || echo "android.manifest_template ì„¤ì • ì—†ìŒ"

    # âœ… ë¹Œë“œ ìˆ˜í–‰ ë° ë¡œê·¸ ì €ì¥
    - name: Build APK
      run: |
        echo "=== Build start ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          echo "=== AndroidManifest ê´€ë ¨ ë¡œê·¸ ê²€ìƒ‰ ==="
          grep -i "manifest" build_full.log | tail -20 || echo "manifest ê´€ë ¨ ë¡œê·¸ ì—†ìŒ"
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # ğŸ”¥ NEW: ë¹Œë“œ í›„ ìƒì„±ëœ AndroidManifest.xml í™•ì¸
    - name: Check generated AndroidManifest.xml
      if: always()
      run: |
        echo "=== ğŸ” ìƒì„±ëœ AndroidManifest.xml í™•ì¸ ==="
        echo "ëª¨ë“  AndroidManifest.xml íŒŒì¼ ì°¾ê¸°:"
        find .buildozer -name "AndroidManifest.xml" 2>/dev/null || echo "AndroidManifest.xml ì—†ìŒ"
        
        echo ""
        echo "=== ğŸ” ì£¼ìš” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ ì§ì ‘ í™•ì¸ ==="
        
        # ì£¼ìš” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ë“¤ ëª©ë¡
        MAIN_MANIFESTS=(
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/src/main/AndroidManifest.xml"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/AndroidManifest.xml"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/intermediates/merged_manifests/debug/AndroidManifest.xml"
        )
        
        for manifest in "${MAIN_MANIFESTS[@]}"; do
          if [ -f "$manifest" ]; then
            echo ""
            echo "ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼: $manifest"
            echo "íŒŒì¼ í¬ê¸°: $(wc -c < "$manifest") bytes"
            
            echo "--- íŒ¨í‚¤ì§€ ì •ë³´ ---"
            grep "package=" "$manifest" | head -1 || echo "íŒ¨í‚¤ì§€ ì •ë³´ ì—†ìŒ"
            
            echo "--- AlarmReceiver ê²€ìƒ‰ ---"
            if grep -q "AlarmReceiver" "$manifest"; then
              echo "âœ… AlarmReceiver ë°œê²¬!"
              grep -A 5 -B 2 "AlarmReceiver" "$manifest"
            else
              echo "âŒ AlarmReceiver ì—†ìŒ"
            fi
            
            echo "--- receiver íƒœê·¸ ê²€ìƒ‰ ---"
            receiver_count=$(grep -c "<receiver" "$manifest" 2>/dev/null || echo "0")
            echo "receiver ê°œìˆ˜: $receiver_count"
            if [ "$receiver_count" -gt 0 ]; then
              grep -A 2 "<receiver" "$manifest"
            fi
            
            echo "--- application êµ¬ì¡° ---"
            echo "application íƒœê·¸: $(grep -c '<application' "$manifest" 2>/dev/null || echo "0")"
            echo "activity íƒœê·¸: $(grep -c '<activity' "$manifest" 2>/dev/null || echo "0")"
          else
            echo "âŒ íŒŒì¼ ì—†ìŒ: $manifest"
          fi
        done
        
        echo ""
        echo "=== ğŸ” ë¹Œë“œ ê³¼ì • ì¤‘ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€í™” ì¶”ì  ==="
        
        # buildozerê°€ ìƒì„±í•˜ëŠ” ì´ˆê¸° ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
        INITIAL_MANIFEST=".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/templates/AndroidManifest.tmpl"
        if [ -f "$INITIAL_MANIFEST" ]; then
          echo "âœ… buildozer ìƒì„± ì´ˆê¸° í…œí”Œë¦¿: $INITIAL_MANIFEST"
          grep -q "AlarmReceiver" "$INITIAL_MANIFEST" && echo "  â†’ AlarmReceiver í¬í•¨ë¨" || echo "  â†’ AlarmReceiver ì—†ìŒ"
        else
          echo "âŒ buildozer ì´ˆê¸° í…œí”Œë¦¿ ì—†ìŒ"
        fi
        
        # ìµœì¢… ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
        APP_MANIFEST=".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/AndroidManifest.xml"
        if [ -f "$APP_MANIFEST" ]; then
          echo "âœ… ìµœì¢… ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸: $APP_MANIFEST"
          grep -q "AlarmReceiver" "$APP_MANIFEST" && echo "  â†’ AlarmReceiver í¬í•¨ë¨" || echo "  â†’ AlarmReceiver ì—†ìŒ"
        else
          echo "âŒ ìµœì¢… ì•± ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—†ìŒ"
        fi
        
        # gradleì´ ì²˜ë¦¬í•˜ëŠ” ìµœì¢… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
        FINAL_MANIFEST=".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/intermediates/merged_manifests/debug/AndroidManifest.xml" 
        if [ -f "$FINAL_MANIFEST" ]; then
          echo "âœ… gradle ìµœì¢… ë§¤ë‹ˆí˜ìŠ¤íŠ¸: $FINAL_MANIFEST"
          grep -q "AlarmReceiver" "$FINAL_MANIFEST" && echo "  â†’ AlarmReceiver í¬í•¨ë¨" || echo "  â†’ AlarmReceiver ì—†ìŒ"
          echo "  â†’ íŒ¨í‚¤ì§€ëª…: $(grep 'package=' "$FINAL_MANIFEST" | cut -d'"' -f2)"
        else
          echo "âŒ gradle ìµœì¢… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—†ìŒ"
        fi

    # âœ… ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          .buildozer/**/*.log
          .buildozer/**/AndroidManifest.xml
        retention-days: 30
        if-no-files-found: warn

    # âœ… APK ì—…ë¡œë“œ
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: skku-timetable-apk
        path: bin/*.apk
        retention-days: 7
        if-no-files-found: error

name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # âœ… ì™„ì „í•œ í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== ğŸ§¹ Completely cleaning build environment ==="
        rm -rf .buildozer bin build android/build android/.gradle
        rm -rf ~/.buildozer ~/.gradle ~/.android
        echo "âœ… ëª¨ë“  ìºì‹œ ì œê±° ì™„ë£Œ"

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev aapt

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.4.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜
    - name: Install APK modification tools
      run: |
        echo "=== ğŸ› ï¸ APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜ ==="
        
        # Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ì„¤ì¹˜
        echo "ğŸ“¥ Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
        mkdir -p ~/android-sdk
        cd ~/android-sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        export ANDROID_SDK_ROOT=~/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/build-tools/34.0.0
        echo "ANDROID_SDK_ROOT=~/android-sdk" >> $GITHUB_ENV
        echo "~/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "~/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH
        
        # SDK ë¼ì´ì„¼ìŠ¤ ìë™ ë™ì˜
        yes | sdkmanager --licenses || true
        
        # build-tools ìµœì‹  ë²„ì „ ì„¤ì¹˜
        echo "ğŸ”§ Android Build Tools ì„¤ì¹˜..."
        sdkmanager "build-tools;34.0.0" "platform-tools"
        
        # apktool ìµœì‹  ë²„ì „ ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
        echo "ğŸ“¥ apktool ë‹¤ìš´ë¡œë“œ..."
        cd ~
        wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
        wget -q https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.9.3.jar
        
        chmod +x apktool
        sudo mv apktool /usr/local/bin/
        sudo mv apktool_2.9.3.jar /usr/local/bin/apktool.jar
        
        # ë„êµ¬ ë²„ì „ í™•ì¸
        echo "âœ… ì„¤ì¹˜ëœ ë„êµ¬ ë²„ì „:"
        apktool --version || echo "apktool ë²„ì „ í™•ì¸ ì‹¤íŒ¨"
        ls -la ~/android-sdk/build-tools/34.0.0/
        
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    # âœ… ë¹Œë“œ ìˆ˜í–‰
    - name: Build APK with buildozer
      run: |
        echo "=== ğŸ”¨ Buildozer APK ë¹Œë“œ ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # âœ… APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦
    - name: Find and verify APK
      run: |
        echo "=== ğŸ” APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦ ==="
        
        # APK íŒŒì¼ ìë™ íƒì§€
        POSSIBLE_APKS=(
          "./bin/doublecheck-0.1-arm64-v8a-debug.apk"
          "./bin/*.apk"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/outputs/apk/debug/*.apk"
        )
        
        FOUND_APK=""
        for apk_pattern in "${POSSIBLE_APKS[@]}"; do
          for apk_file in $apk_pattern; do
            if [ -f "$apk_file" ]; then
              FOUND_APK="$apk_file"
              echo "âœ… APK ë°œê²¬: $FOUND_APK"
              break 2
            fi
          done
        done
        
        if [ -z "$FOUND_APK" ]; then
          FOUND_APK=$(find . -name "*debug*.apk" -type f | head -1)
          if [ -n "$FOUND_APK" ]; then
            echo "âœ… ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ APK ë°œê²¬: $FOUND_APK"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi
        fi
        
        echo "ORIGINAL_APK=$FOUND_APK" >> $GITHUB_ENV
        echo "ğŸ“Š APK í¬ê¸°: $(du -h "$FOUND_APK" | cut -f1)"
        
        # ì›ë³¸ APK ìœ íš¨ì„± ê²€ì‚¬
        if aapt dump badging "$FOUND_APK" >/dev/null 2>&1; then
          echo "âœ… ì›ë³¸ APK êµ¬ì¡° ìœ íš¨"
        else
          echo "âŒ ì›ë³¸ APK êµ¬ì¡° ì˜¤ë¥˜"
          exit 1
        fi

    # âœ… APK ìˆ˜ì • (AlarmReceiver ì¶”ê°€)
    - name: Modify APK to add AlarmReceiver
      run: |
        echo "=== ğŸ”§ APK ìˆ˜ì • (AlarmReceiver ì¶”ê°€) ==="
        
        if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
          echo "âŒ ì›ë³¸ APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ¯ ëŒ€ìƒ APK: $ORIGINAL_APK"
        
        # ë°±ì—… ìƒì„±
        cp "$ORIGINAL_APK" original_backup.apk
        echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
        
        # ì‘ì—… ê³µê°„ ì •ë¦¬
        rm -rf decoded_apk_clean
        
        # APK ë””ì»´íŒŒì¼
        echo "ğŸ“¦ APK ë””ì»´íŒŒì¼..."
        if apktool d "$ORIGINAL_APK" -o decoded_apk_clean --force --no-debug-info; then
          echo "âœ… APK ë””ì»´íŒŒì¼ ì„±ê³µ"
        else
          echo "âŒ APK ë””ì»´íŒŒì¼ ì‹¤íŒ¨"
          exit 1
        fi
        
        # AndroidManifest.xml ìˆ˜ì •
        MANIFEST="decoded_apk_clean/AndroidManifest.xml"
        cp "$MANIFEST" "${MANIFEST}.backup"
        
        echo "ğŸ” í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒíƒœ:"
        echo "- activity: $(grep -c '<activity' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        echo "- receiver: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        echo "- service: $(grep -c '<service' "$MANIFEST" 2>/dev/null || echo "0")ê°œ"
        
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âš ï¸ AlarmReceiver ì´ë¯¸ ì¡´ì¬í•¨ - ìˆ˜ì •í•˜ì§€ ì•ŠìŒ"
        else
          echo "â• AlarmReceiver ì¶”ê°€ ì¤‘..."
          
          if grep -q "</application>" "$MANIFEST"; then
            sed -i '/<\/application>/i\        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">\
            <intent-filter>\
                <action android:name="android.intent.action.BOOT_COMPLETED" />\
            </intent-filter>\
        </receiver>' "$MANIFEST"
            
            echo "âœ… AlarmReceiver ì¶”ê°€ ì™„ë£Œ"
          else
            echo "âŒ </application> íƒœê·¸ ì—†ìŒ"
            exit 1
          fi
        fi
        
        # ìˆ˜ì • ê²°ê³¼ ê²€ì¦
        if grep -q "AlarmReceiver" "$MANIFEST"; then
          echo "âœ… AlarmReceiver í™•ì¸ë¨"
          echo "ğŸ“Š ìˆ˜ì • í›„ receiver ê°œìˆ˜: $(grep -c '<receiver' "$MANIFEST" 2>/dev/null || echo "0")"
        else
          echo "âŒ AlarmReceiver ì¶”ê°€ ì‹¤íŒ¨"
          exit 1
        fi
        
        # XML ë¬¸ë²• ê²€ì¦
        if command -v xmllint >/dev/null 2>&1; then
          if xmllint --noout "$MANIFEST" 2>/dev/null; then
            echo "âœ… XML ë¬¸ë²• ìœ íš¨"
          else
            echo "âŒ XML ë¬¸ë²• ì˜¤ë¥˜ - ë°±ì—…ì—ì„œ ë³µì›"
            cp "${MANIFEST}.backup" "$MANIFEST"
            exit 1
          fi
        fi

    # âœ… ë°©ë²• 1: aapt2 ì‚¬ìš©í•œ ì •êµí•œ APK ìˆ˜ì •
    - name: Method 1 - Precise APK modification with aapt2
      run: |
        echo "=== ğŸ”§ ë°©ë²• 1: aapt2ë¥¼ ì‚¬ìš©í•œ ì •êµí•œ APK ìˆ˜ì • ==="
        
        if [ -f "${ORIGINAL_APK:-}" ]; then
          echo "ğŸ¯ aapt2ë¡œ ì •êµí•˜ê²Œ ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤..."
          
          # aapt2 ì„¤ì¹˜ í™•ì¸
          if command -v aapt2 >/dev/null 2>&1; then
            echo "âœ… aapt2 ì´ë¯¸ ì„¤ì¹˜ë¨"
          else
            echo "ğŸ“¥ aapt2 ì„¤ì¹˜ ì¤‘..."
            # Android SDKì˜ aapt2 ì‚¬ìš©
            AAPT2_PATH="$HOME/android-sdk/build-tools/34.0.0/aapt2"
            if [ -f "$AAPT2_PATH" ]; then
              echo "âœ… aapt2 ë°œê²¬: $AAPT2_PATH"
              sudo ln -sf "$AAPT2_PATH" /usr/local/bin/aapt2 || true
            else
              echo "âŒ aapt2 ì—†ìŒ - ì„¤ì¹˜ ì‹œë„"
              echo "aapt2 ì„¤ì¹˜ë¥¼ ìœ„í•´ build-tools ì¬ì„¤ì¹˜..."
            fi
          fi
          
          # 1ë‹¨ê³„: ì›ë³¸ APK ë¶„í•´ (aapt2 ë°©ì‹)
          echo "ğŸ“¦ 1ë‹¨ê³„: APK ë¦¬ì†ŒìŠ¤ ì¶”ì¶œ (aapt2)..."
          mkdir -p aapt2_work
          cd aapt2_work
          
          # APKë¥¼ ZIPìœ¼ë¡œ ì²˜ë¦¬í•´ì„œ íŒŒì¼ë“¤ ì¶”ì¶œ
          cp "../$ORIGINAL_APK" original.apk
          unzip -q original.apk
          
          echo "âœ… APK íŒŒì¼ ì¶”ì¶œ ì™„ë£Œ"
          ls -la | head -10
          
          # 2ë‹¨ê³„: ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ (aapt2 dump)
          echo "ğŸ“„ 2ë‹¨ê³„: ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…ìŠ¤íŠ¸ ë³€í™˜..."
          if aapt2 dump badging original.apk > package_info.txt 2>&1; then
            echo "âœ… aapt2 dump ì„±ê³µ"
            head -5 package_info.txt
          else
            echo "âŒ aapt2 dump ì‹¤íŒ¨"
            cat package_info.txt | head -5
          fi
          
          # aaptë¡œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML í˜•íƒœë¡œ ì¶”ì¶œ
          echo "ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML ì¶”ì¶œ..."
          if aapt dump xmltree original.apk AndroidManifest.xml > manifest_readable.xml 2>&1; then
            echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML ì¶”ì¶œ ì„±ê³µ"
            echo "í˜„ì¬ receiver ê°œìˆ˜: $(grep -c "receiver" manifest_readable.xml || echo "0")"
          else
            echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML ì¶”ì¶œ ì‹¤íŒ¨"
          fi
          
          # 3ë‹¨ê³„: ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì§ì ‘ ë¶„ì„
          echo "ğŸ” 3ë‹¨ê³„: ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¶„ì„..."
          echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì •ë³´:"
          ls -la AndroidManifest.xml
          echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í—¥ìŠ¤ ë¤í”„ (ì²˜ìŒ 64ë°”ì´íŠ¸):"
          hexdump -C AndroidManifest.xml | head -4
          
          cd ..
          echo "aapt2 ë°©ë²• 1ë‹¨ê³„ ì™„ë£Œ"
        fi

    # âœ… ë°©ë²• 2: ë°”ì´ë„ˆë¦¬ í—¥ìŠ¤ ì—ë””í„° ë°©ì‹
    - name: Method 2 - Binary hex editor approach
      run: |
        echo "=== ğŸ”¬ ë°©ë²• 2: ë°”ì´ë„ˆë¦¬ í—¥ìŠ¤ ì—ë””í„° ë°©ì‹ ==="
        
        if [ -f "${ORIGINAL_APK:-}" ]; then
          echo "ğŸ¯ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°”ì´ë„ˆë¦¬ë¥¼ ì§ì ‘ ë¶„ì„í•˜ê³  ìˆ˜ì •í•´ë³´ê² ìŠµë‹ˆë‹¤..."
          
          mkdir -p hex_work
          cd hex_work
          
          # APKì—ì„œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
          unzip -j "../$ORIGINAL_APK" AndroidManifest.xml
          
          if [ -f "AndroidManifest.xml" ]; then
            echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ"
            
            # ë°”ì´ë„ˆë¦¬ ë¶„ì„
            echo "ğŸ“Š ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°”ì´ë„ˆë¦¬ ì •ë³´:"
            echo "í¬ê¸°: $(wc -c < AndroidManifest.xml) bytes"
            echo "íŒŒì¼ íƒ€ì…: $(file AndroidManifest.xml)"
            
            # ë¬¸ìì—´ í…Œì´ë¸” ì°¾ê¸°
            echo "ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ ë¬¸ìì—´ ê²€ìƒ‰:"
            strings AndroidManifest.xml | grep -E "(receiver|activity|AlarmReceiver)" | head -10 || echo "ê´€ë ¨ ë¬¸ìì—´ ì—†ìŒ"
            
            # receiver íŒ¨í„´ ê²€ìƒ‰
            echo "ğŸ“¡ receiver ê´€ë ¨ ë°”ì´ë„ˆë¦¬ íŒ¨í„´ ê²€ìƒ‰:"
            xxd AndroidManifest.xml | grep -i "receiver" || echo "receiver ë°”ì´ë„ˆë¦¬ íŒ¨í„´ ì—†ìŒ"
            
            # application íƒœê·¸ ìœ„ì¹˜ ì°¾ê¸°
            echo "ğŸ“± application íƒœê·¸ ìœ„ì¹˜ ê²€ìƒ‰:"
            xxd AndroidManifest.xml | grep -i "application" | head -3 || echo "application íƒœê·¸ ì°¾ê¸° ì‹¤íŒ¨"
            
            # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì¡° ë¶„ì„ì„ ìœ„í•œ ë°”ì´ë„ˆë¦¬ ë¤í”„
            echo "ğŸ—‚ï¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ êµ¬ì¡° ë¶„ì„:"
            echo "ì²« 32ë°”ì´íŠ¸ (í—¤ë”):"
            xxd AndroidManifest.xml | head -2
            echo "ë§ˆì§€ë§‰ 32ë°”ì´íŠ¸:"
            xxd AndroidManifest.xml | tail -2
            
            # ë°±ì—… ìƒì„±
            cp AndroidManifest.xml AndroidManifest.xml.backup
            echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°±ì—… ì™„ë£Œ"
            
          else
            echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
          fi
          
          cd ..
        fi

    # âœ… ë°©ë²• 3: baksmali/smali (DEX ë ˆë²¨ ìˆ˜ì •)
    - name: Method 3 - baksmali/smali DEX level modification
      run: |
        echo "=== âš™ï¸ ë°©ë²• 3: baksmali/smali DEX ë ˆë²¨ ìˆ˜ì • ==="
        
        if [ -f "${ORIGINAL_APK:-}" ]; then
          echo "ğŸ¯ DEX íŒŒì¼ ë ˆë²¨ì—ì„œ ìˆ˜ì •ì„ ì‹œë„í•´ë³´ê² ìŠµë‹ˆë‹¤..."
          
          # baksmali/smali ë„êµ¬ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¥ baksmali/smali ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/baksmali-2.5.2.jar -O baksmali.jar
          wget -q https://bitbucket.org/JesusFreke/smali/downloads/smali-2.5.2.jar -O smali.jar
          
          if [ -f "baksmali.jar" ] && [ -f "smali.jar" ]; then
            echo "âœ… baksmali/smali ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
            
            mkdir -p dex_work
            cd dex_work
            
            # APKì—ì„œ classes.dex ì¶”ì¶œ
            unzip -j "../$ORIGINAL_APK" "classes*.dex"
            
            if [ -f "classes.dex" ]; then
              echo "âœ… classes.dex ì¶”ì¶œ ì™„ë£Œ"
              echo "DEX íŒŒì¼ í¬ê¸°: $(du -h classes.dex | cut -f1)"
              
              # DEXë¥¼ smali ì½”ë“œë¡œ ë””ì»´íŒŒì¼
              echo "ğŸ”§ DEX â†’ smali ë””ì»´íŒŒì¼..."
              java -jar ../baksmali.jar disassemble classes.dex -o smali_out
              
              if [ -d "smali_out" ]; then
                echo "âœ… smali ë””ì»´íŒŒì¼ ì„±ê³µ"
                echo "ìƒì„±ëœ smali íŒŒì¼ ê°œìˆ˜: $(find smali_out -name "*.smali" | wc -l)"
                
                # ë©”ì¸ ì•¡í‹°ë¹„í‹° ì°¾ê¸°
                echo "ğŸ” ë©”ì¸ ì•¡í‹°ë¹„í‹° íŒŒì¼ ì°¾ê¸°:"
                find smali_out -name "*Activity*.smali" | head -5
                
                # PythonActivity ì°¾ê¸°
                PYTHON_ACTIVITY=$(find smali_out -name "*PythonActivity*.smali" | head -1)
                if [ -n "$PYTHON_ACTIVITY" ]; then
                  echo "âœ… PythonActivity ë°œê²¬: $PYTHON_ACTIVITY"
                  echo "íŒŒì¼ í¬ê¸°: $(wc -l < "$PYTHON_ACTIVITY") ì¤„"
                  
                  # Activity ë‚´ìš© ì¼ë¶€ í™•ì¸
                  echo "ğŸ“„ PythonActivity ì¼ë¶€ ë‚´ìš©:"
                  head -20 "$PYTHON_ACTIVITY"
                  
                else
                  echo "âŒ PythonActivity ì—†ìŒ"
                fi
                
                # BroadcastReceiver í´ë˜ìŠ¤ ì¶”ê°€ ì¤€ë¹„
                echo "ğŸ“¡ BroadcastReceiver í´ë˜ìŠ¤ ìƒì„± ì¤€ë¹„..."
                mkdir -p smali_out/org/kivy/skkutimetable/doublecheck
                
                # ê°„ë‹¨í•œ AlarmReceiver smali ì½”ë“œ ìƒì„±
                cat > smali_out/org/kivy/skkutimetable/doublecheck/AlarmReceiver.smali << 'EOF'
.class public Lorg/kivy/skkutimetable/doublecheck/AlarmReceiver;
.super Landroid/content/BroadcastReceiver;

.method public constructor <init>()V
    .locals 0
    invoke-direct {p0}, Landroid/content/BroadcastReceiver;-><init>()V
    return-void
.end method

.method public onReceive(Landroid/content/Context;Landroid/content/Intent;)V
    .locals 2
    const-string v0, "AlarmReceiver"
    const-string v1, "Boot completed - alarm restore needed"
    invoke-static {v0, v1}, Landroid/util/Log;->d(Ljava/lang/String;Ljava/lang/String;)I
    return-void
.end method
EOF
                
                echo "âœ… AlarmReceiver.smali ìƒì„± ì™„ë£Œ"
                
                # smali â†’ DEX ì¬ì»´íŒŒì¼
                echo "ğŸ”¨ smali â†’ DEX ì¬ì»´íŒŒì¼..."
                java -jar ../smali.jar assemble smali_out -o classes_modified.dex
                
                if [ -f "classes_modified.dex" ]; then
                  echo "âœ… DEX ì¬ì»´íŒŒì¼ ì„±ê³µ"
                  echo "ìˆ˜ì •ëœ DEX í¬ê¸°: $(du -h classes_modified.dex | cut -f1)"
                else
                  echo "âŒ DEX ì¬ì»´íŒŒì¼ ì‹¤íŒ¨"
                fi
                
              else
                echo "âŒ smali ë””ì»´íŒŒì¼ ì‹¤íŒ¨"
              fi
              
            else
              echo "âŒ classes.dex ì¶”ì¶œ ì‹¤íŒ¨"
            fi
            
            cd ..
          else
            echo "âŒ baksmali/smali ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          fi
        fi

    # âœ… ë°©ë²• 4: APK í•©ì„± (íŒŒì¼ êµì²´)
    - name: Method 4 - APK synthesis (file replacement)
      run: |
        echo "=== ğŸ”„ ë°©ë²• 4: APK í•©ì„± (íŒŒì¼ êµì²´) ==="
        
        if [ -f "${ORIGINAL_APK:-}" ]; then
          echo "ğŸ¯ ZIP ë ˆë²¨ì—ì„œ íŒŒì¼ì„ êµì²´í•´ë³´ê² ìŠµë‹ˆë‹¤..."
          
          mkdir -p synthesis_work
          cd synthesis_work
          
          # 1. ì›ë³¸ APK ë³µì‚¬
          cp "../$ORIGINAL_APK" base.apk
          
          # 2. ê°„ë‹¨í•œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± (í…ìŠ¤íŠ¸)
          echo "ğŸ“ ìˆ˜ì •ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±..."
          cat > AndroidManifest_text.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="org.kivy.skkutimetable.doublecheck"
    android:versionCode="10211"
    android:versionName="0.1">
    
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.VIBRATE" />
    
    <application android:label="DoubleCheck" android:icon="@mipmap/icon">
        <activity android:name="org.kivy.android.PythonActivity"
                  android:label="DoubleCheck"
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        
        <service android:name="org.kivy.android.PythonService" android:process=":pythonservice" />
        
        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver"
                  android:enabled="true"
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
        
    </application>
</manifest>
EOF
          
          # 3. aaptë¥¼ ì‚¬ìš©í•´ì„œ í…ìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜
          echo "ğŸ”„ í…ìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ â†’ ë°”ì´ë„ˆë¦¬ ë³€í™˜..."
          
          # ì„ì‹œ ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p temp_resources/res/values
          echo '<?xml version="1.0" encoding="utf-8"?><resources></resources>' > temp_resources/res/values/strings.xml
          
          # aaptë¡œ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì‹œë„
          if aapt package -f -M AndroidManifest_text.xml -S temp_resources/res -I "$ANDROID_HOME/platforms/android-33/android.jar" -F temp.apk 2>/dev/null; then
            echo "âœ… ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì„±ê³µ"
            
            # ìƒì„±ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
            unzip -j temp.apk AndroidManifest.xml -d .
            if [ -f "AndroidManifest.xml" ]; then
              echo "âœ… ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ"
              echo "ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í¬ê¸°: $(wc -c < AndroidManifest.xml) bytes"
              
              # 4. ì›ë³¸ APKì— ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚½ì…
              echo "ğŸ”§ ì›ë³¸ APKì— ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚½ì…..."
              zip base.apk AndroidManifest.xml
              
              # 5. ê²°ê³¼ APK ê²€ì¦
              echo "âœ… í•©ì„± APK ìƒì„± ì™„ë£Œ"
              mv base.apk synthesis_fixed.apk
              
              # ê²€ì¦
              if aapt dump badging synthesis_fixed.apk >/dev/null 2>&1; then
                echo "âœ… í•©ì„± APK êµ¬ì¡° ìœ íš¨"
                echo "ğŸ“‹ í•©ì„± APK ì •ë³´:"
                aapt dump badging synthesis_fixed.apk | head -5
              else
                echo "âŒ í•©ì„± APK êµ¬ì¡° ì˜¤ë¥˜"
              fi
              
            else
              echo "âŒ ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì‹¤íŒ¨"
            fi
          else
            echo "âŒ ë°”ì´ë„ˆë¦¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„± ì‹¤íŒ¨"
          fi
          
          cd ..
        fi

    # âœ… ë°©ë²• 5: Android Studio í”„ë¡œì íŠ¸ ë³€í™˜
    - name: Method 5 - Convert to Android Studio project
      run: |
        echo "=== ğŸ—ï¸ ë°©ë²• 5: Android Studio í”„ë¡œì íŠ¸ ë³€í™˜ ==="
        
        if [ -f "${ORIGINAL_APK:-}" ]; then
          echo "ğŸ¯ APK â†’ Android Studio í”„ë¡œì íŠ¸ ë³€í™˜ ì‹œë„..."
          
          mkdir -p studio_work
          cd studio_work
          
          # jadx ë„êµ¬ ë‹¤ìš´ë¡œë“œ (APK â†’ Java ì†ŒìŠ¤ ë³€í™˜)
          echo "ğŸ“¥ jadx ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
          wget -q https://github.com/skylot/jadx/releases/download/v1.4.7/jadx-1.4.7.zip -O jadx.zip
          
          if [ -f "jadx.zip" ]; then
            unzip -q jadx.zip
            chmod +x jadx-1.4.7/bin/jadx
            
            echo "âœ… jadx ì„¤ì¹˜ ì™„ë£Œ"
            
            # APKë¥¼ Java í”„ë¡œì íŠ¸ë¡œ ë³€í™˜
            echo "ğŸ”„ APK â†’ Java ì†ŒìŠ¤ ë³€í™˜..."
            ./jadx-1.4.7/bin/jadx "../$ORIGINAL_APK" -d java_project
            
            if [ -d "java_project" ]; then
              echo "âœ… Java í”„ë¡œì íŠ¸ ë³€í™˜ ì„±ê³µ"
              
              # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
              if [ -f "java_project/resources/AndroidManifest.xml" ]; then
                echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°œê²¬"
                echo "ğŸ“„ í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë‚´ìš©:"
                head -20 java_project/resources/AndroidManifest.xml
                
                # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ì— receiver ì¶”ê°€
                echo "ğŸ“¡ receiver ì¶”ê°€ ì¤‘..."
                cp java_project/resources/AndroidManifest.xml java_project/resources/AndroidManifest.xml.backup
                
                # receiver íƒœê·¸ ì‚½ì…
                sed -i '/<\/application>/i\        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true">\
            <intent-filter>\
                <action android:name="android.intent.action.BOOT_COMPLETED" />\
            </intent-filter>\
        </receiver>' java_project/resources/AndroidManifest.xml
                
                echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì • ì™„ë£Œ"
                echo "ğŸ“‹ ìˆ˜ì •ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸:"
                grep -A 10 -B 5 "AlarmReceiver" java_project/resources/AndroidManifest.xml || echo "ì¶”ê°€ ì‹¤íŒ¨"
                
              else
                echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—†ìŒ"
              fi
              
              # í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸
              echo "ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
              find java_project -type f -name "*.xml" | head -10
              
            else
              echo "âŒ Java í”„ë¡œì íŠ¸ ë³€í™˜ ì‹¤íŒ¨"
            fi
          else
            echo "âŒ jadx ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
          fi
          
          cd ..
        fi

    # âœ… ëª¨ë“  ë°©ë²• ê²°ê³¼ ë¹„êµ
    - name: Compare all methods results
      run: |
        echo "=== ğŸ“Š ëª¨ë“  ë°©ë²• ê²°ê³¼ ë¹„êµ ==="
        
        echo "ğŸ¯ ìƒì„±ëœ APK íŒŒì¼ë“¤:"
        find . -name "*.apk" -exec echo "{}:" \; -exec du -h {} \; 2>/dev/null || echo "APK íŒŒì¼ ì—†ìŒ"
        
        echo ""
        echo "ğŸ“‹ ê° ë°©ë²•ë³„ ì„±ê³µ/ì‹¤íŒ¨ ìƒíƒœ:"
        
        # ë°©ë²• 1: aapt2
        if [ -d "aapt2_work" ]; then
          echo "âœ… ë°©ë²• 1 (aapt2): ì‹œë„ë¨"
        else
          echo "âŒ ë°©ë²• 1 (aapt2): ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 2: í—¥ìŠ¤ ì—ë””í„°
        if [ -f "hex_work/AndroidManifest.xml" ]; then
          echo "âœ… ë°©ë²• 2 (í—¥ìŠ¤): ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œë¨"
        else
          echo "âŒ ë°©ë²• 2 (í—¥ìŠ¤): ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 3: baksmali
        if [ -f "dex_work/classes_modified.dex" ]; then
          echo "âœ… ë°©ë²• 3 (baksmali): DEX ìˆ˜ì •ë¨"
        else
          echo "âŒ ë°©ë²• 3 (baksmali): ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 4: í•©ì„±
        if [ -f "synthesis_work/synthesis_fixed.apk" ]; then
          echo "âœ… ë°©ë²• 4 (í•©ì„±): APK ìƒì„±ë¨"
        else
          echo "âŒ ë°©ë²• 4 (í•©ì„±): ì‹¤íŒ¨"
        fi
        
        # ë°©ë²• 5: Studio
        if [ -f "studio_work/java_project/resources/AndroidManifest.xml" ]; then
          echo "âœ… ë°©ë²• 5 (Studio): í”„ë¡œì íŠ¸ ë³€í™˜ë¨"
        else
          echo "âŒ ë°©ë²• 5 (Studio): ì‹¤íŒ¨"
        fi
        
        echo ""
        echo "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„: ê°€ì¥ ì„±ê³µí•œ ë°©ë²•ìœ¼ë¡œ ìµœì¢… APK ìƒì„±"âœ… ê¶Œí•œ ì„¹ì…˜ ì¶”ê°€ ì™„ë£Œ"
          fi
          
          # ìˆ˜ì • ê²°ê³¼ í™•ì¸
          echo "ğŸ“‹ ìˆ˜ì •ëœ ê¶Œí•œ ì„¤ì •:"
          grep -A 2 -B 2 "android.permissions" buildozer.spec
          
          echo ""
          echo "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:"
          echo "1. ì´ buildozer.specì„ ì‚¬ìš©í•´ì„œ í´ë¦° ë¹Œë“œ"
          echo "2. Python ì½”ë“œì— ë™ì  receiver ë“±ë¡ ì¶”ê°€"
          echo "3. APK ìˆ˜ì •ì€ í¬ê¸°í•˜ê³  ì†ŒìŠ¤ ë ˆë²¨ì—ì„œ í•´ê²°"
          
        else
          echo "âŒ buildozer.spec íŒŒì¼ ì—†ìŒ"
          echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸:"
          ls -la | head -10
        fi

    # âœ… ì™œ apktoolì´ ì‹¤íŒ¨í•˜ëŠ”ì§€ ê·¼ë³¸ ì›ì¸ ë¶„ì„
    - name: Root cause analysis of apktool failure
      run: |
        echo "=== ğŸ”¬ apktool ì‹¤íŒ¨ ê·¼ë³¸ ì›ì¸ ë¶„ì„ ==="
        
        echo "ğŸ¯ apktoolì´ ì‹¤íŒ¨í•˜ëŠ” ì´ìœ ë“¤:"
        echo ""
        echo "1. ë°”ì´ë„ˆë¦¬ XML ì¸ì½”ë”© ë¬¸ì œ:"
        echo "   - AndroidëŠ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ë°”ì´ë„ˆë¦¬ XMLë¡œ ì••ì¶•í•¨"
        echo "   - apktoolì´ ì´ë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜ í›„ ë‹¤ì‹œ ë°”ì´ë„ˆë¦¬ë¡œ ë³€í™˜"
        echo "   - ì´ ê³¼ì •ì—ì„œ ë¯¸ë¬˜í•œ ì¸ì½”ë”© ì°¨ì´ ë°œìƒ"
        echo ""
        echo "2. ë¦¬ì†ŒìŠ¤ í…Œì´ë¸” ì†ìƒ:"
        echo "   - resources.arsc íŒŒì¼ì´ ë§ê°€ì§"
        echo "   - ì•„ì´ì½˜ ë“± ë¦¬ì†ŒìŠ¤ ë§¤í•‘ì´ ê¹¨ì§"
        echo ""
        echo "3. ì••ì¶• ë°©ì‹ ì°¨ì´:"
        echo "   - ì›ë³¸: deflate ì••ì¶•"
        echo "   - apktool ë¦¬ë¹Œë“œ: store (ë¬´ì••ì¶•) ë˜ëŠ” ë‹¤ë¥¸ ì••ì¶•"
        echo ""
        echo "4. ì„œëª… ì²´ì¸ ë¬¸ì œ:"
        echo "   - ì›ë³¸ê³¼ ë‹¤ë¥¸ ì„œëª… ë°©ì‹"
        echo "   - zipalign ìˆœì„œ ë¬¸ì œ"
        echo ""
        echo "ğŸ’¡ ê²°ë¡ :"
        echo "APK í›„ì²˜ë¦¬ ë°©ì‹ì€ ë³¸ì§ˆì ìœ¼ë¡œ ë¶ˆì•ˆì •í•¨"
        echo "ì†ŒìŠ¤ ë ˆë²¨(buildozer.spec + Python ì½”ë“œ)ì—ì„œ í•´ê²°í•˜ëŠ” ê²Œ ì •ë‹µ!"
        echo ""
        echo "ğŸ¯ ìµœì¢… ê¶Œì¥ì‚¬í•­:"
        echo "1. buildozer.specì— RECEIVE_BOOT_COMPLETED ê¶Œí•œ ì¶”ê°€"
        echo "2. Python main.pyì— ë™ì  BroadcastReceiver ë“±ë¡"
        echo "3. APK ì§ì ‘ ìˆ˜ì •ì€ í¬ê¸°"
        echo ""
        echo "ì´ê²Œ ê°€ì¥ ì•ˆì „í•˜ê³  í™•ì‹¤í•œ ë°©ë²•ì…ë‹ˆë‹¤! ğŸš€"

    # âœ… ìµœì¢… APK ê²€ì¦
    - name: Final APK validation
      run: |
        echo "=== ğŸ¯ ìµœì¢… APK ê²€ì¦ ==="
        
        APK_TO_TEST="final_doublecheck_fixed.apk"
        
        if [ ! -f "$APK_TO_TEST" ]; then
          echo "âŒ ìµœì¢… APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ“± ìµœì¢… APK ì •ë³´:"
        echo "íŒŒì¼ëª…: $APK_TO_TEST"
        echo "í¬ê¸°: $(du -h "$APK_TO_TEST" | cut -f1)"
        
        # APK êµ¬ì¡° ê²€ì¦
        echo "ğŸ” APK êµ¬ì¡° ê²€ì¦..."
        if aapt dump badging "$APK_TO_TEST" > apk_info.txt 2>&1; then
          echo "âœ… APK êµ¬ì¡° ìœ íš¨"
          
          # íŒ¨í‚¤ì§€ ì •ë³´ ì¶œë ¥
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì •ë³´:"
          grep "package:" apk_info.txt | head -3
          grep "application:" apk_info.txt | head -1
          grep "launchable-activity:" apk_info.txt | head -1
          
        else
          echo "âŒ APK êµ¬ì¡° ì˜¤ë¥˜"
          cat apk_info.txt
          exit 1
        fi
        
        # ì„œëª… ê²€ì¦
        echo "ğŸ” ì„œëª… ê²€ì¦..."
        if jarsigner -verify "$APK_TO_TEST" 2>/dev/null; then
          echo "âœ… ì„œëª… ìœ íš¨"
        else
          echo "âŒ ì„œëª… ë¬´íš¨"
          jarsigner -verify -verbose "$APK_TO_TEST" || true
        fi
        
        # zipalign ê²€ì¦
        ZIPALIGN_PATH="$HOME/android-sdk/build-tools/34.0.0/zipalign"
        if [ -f "$ZIPALIGN_PATH" ]; then
          if $ZIPALIGN_PATH -c 4 "$APK_TO_TEST" >/dev/null 2>&1; then
            echo "âœ… APK ì •ë ¬ ìœ íš¨"
          else
            echo "âš ï¸ APK ì •ë ¬ ë¬¸ì œ"
          fi
        fi
        
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦
        echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ê²€ì¦..."
        rm -rf final_verification
        apktool d "$APK_TO_TEST" -o final_verification --force >/dev/null 2>&1
        
        if [ -f "final_verification/AndroidManifest.xml" ]; then
          FINAL_MANIFEST="final_verification/AndroidManifest.xml"
          
          echo "ğŸ” ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì •ë³´:"
          PACKAGE_NAME=$(grep 'package=' "$FINAL_MANIFEST" | head -1 | sed 's/.*package="//;s/".*//')
          echo "- package: $PACKAGE_NAME"
          echo "- activity: $(grep -c '<activity' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          echo "- receiver: $(grep -c '<receiver' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          echo "- service: $(grep -c '<service' "$FINAL_MANIFEST" 2>/dev/null || echo "0")ê°œ"
          
          if grep -q "AlarmReceiver" "$FINAL_MANIFEST"; then
            echo "âœ… AlarmReceiver ì •ìƒ í¬í•¨!"
          else
            echo "âŒ AlarmReceiver ì—†ìŒ"
          fi
          
          # MAIN ì•¡í‹°ë¹„í‹° í™•ì¸
          if grep -A 10 'android.intent.action.MAIN' "$FINAL_MANIFEST" | grep -q 'android:name'; then
            echo "âœ… MAIN ì•¡í‹°ë¹„í‹° ì¡´ì¬"
            MAIN_ACTIVITY=$(grep -B 5 -A 5 'android.intent.action.MAIN' "$FINAL_MANIFEST" | grep 'android:name=' | head -1 | sed 's/.*android:name="//;s/".*//')
            echo "- MAIN ì•¡í‹°ë¹„í‹°: $MAIN_ACTIVITY"
          else
            echo "âŒ MAIN ì•¡í‹°ë¹„í‹° ì—†ìŒ - ì•± ì‹¤í–‰ ë¶ˆê°€"
          fi
        fi
        
        # íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦
        echo "ğŸ” íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦..."
        unzip -t "$APK_TO_TEST" >/dev/null 2>&1
        if [ $? -eq 0 ]; then
          echo "âœ… APK íŒŒì¼ ë¬´ê²°ì„± ì–‘í˜¸"
        else
          echo "âŒ APK íŒŒì¼ ì†ìƒ"
          exit 1
        fi
        
        echo "ğŸ‰ ìµœì¢… ìˆ˜ì •ëœ APK ì¤€ë¹„ ì™„ë£Œ: $APK_TO_TEST"
        echo "ğŸ“± ì„¤ì¹˜ ê°€ëŠ¥í•œ APK ìƒì„±ë¨!"

    # âœ… ì›ë³¸ê³¼ ìˆ˜ì •ë³¸ ë¹„êµ ë¶„ì„
    - name: Compare original and modified APK
      if: always()
      run: |
        echo "=== ğŸ” ì›ë³¸ê³¼ ìˆ˜ì •ë³¸ ë¹„êµ ë¶„ì„ ==="
        
        if [ -f "${ORIGINAL_APK:-}" ] && [ -f "final_doublecheck_fixed.apk" ]; then
          echo "ğŸ“Š í¬ê¸° ë¹„êµ:"
          echo "ì›ë³¸: $(du -h "$ORIGINAL_APK" | cut -f1)"
          echo "ìˆ˜ì •: $(du -h "final_doublecheck_fixed.apk" | cut -f1)"
          
          # ì›ë³¸ APK ë¶„ì„
          echo "ğŸ“¦ ì›ë³¸ APK ë¶„ì„..."
          rm -rf original_analysis
          apktool d "$ORIGINAL_APK" -o original_analysis --force >/dev/null 2>&1
          
          if [ -f "original_analysis/AndroidManifest.xml" ]; then
            ORIG_MANIFEST="original_analysis/AndroidManifest.xml"
            echo "ì›ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸:"
            echo "- activity: $(grep -c '<activity' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            echo "- receiver: $(grep -c '<receiver' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            echo "- service: $(grep -c '<service' "$ORIG_MANIFEST" 2>/dev/null || echo "0")ê°œ"
            
            if grep -q "AlarmReceiver" "$ORIG_MANIFEST"; then
              echo "âš ï¸ ì›ë³¸ì— ì´ë¯¸ AlarmReceiver ì¡´ì¬"
            else
              echo "âŒ ì›ë³¸ì— AlarmReceiver ì—†ìŒ"
            fi
          fi
          
          # ìˆ˜ì •ë³¸ê³¼ ì°¨ì´ì  ë¶„ì„
          if [ -f "final_verification/AndroidManifest.xml" ] && [ -f "original_analysis/AndroidManifest.xml" ]; then
            echo "ğŸ”„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì°¨ì´ì :"
            diff original_analysis/AndroidManifest.xml final_verification/AndroidManifest.xml | head -20 || echo "ì°¨ì´ì  ì—†ìŒ"
          fi
        fi

    # âœ… ì••ì¶• ë°©ì‹ ë° ì„¤ì¹˜ í˜¸í™˜ì„± ê²€ì¦
    - name: Compression and installation compatibility verification
      run: |
        echo "=== ğŸ” ì••ì¶• ë°©ì‹ ë° ì„¤ì¹˜ í˜¸í™˜ì„± ê²€ì¦ ==="
        
        APK_FILES=(
          "original_backup.apk:ì›ë³¸"
          "final_doublecheck_fixed.apk:ìˆ˜ì •ë³¸"
          "alternative_fixed.apk:ëŒ€ì•ˆ"
        )
        
        for APK_INFO in "${APK_FILES[@]}"; do
          APK_FILE="${APK_INFO%:*}"
          APK_DESC="${APK_INFO#*:}"
          
          if [ -f "$APK_FILE" ]; then
            echo ""
            echo "ğŸ”¬ === $APK_DESC APK ($APK_FILE) í˜¸í™˜ì„± ê²€ì¦ ==="
            
            # 1. ì••ì¶• ë°©ì‹ í™•ì¸
            echo "ğŸ—œï¸ ì••ì¶• ë°©ì‹ ë¶„ì„:"
            file "$APK_FILE" | grep -o "compression method=[^,]*"
            
            # 2. ZIP í—¤ë” ìƒì„¸ ë¶„ì„
            echo "ğŸ“¦ ZIP í—¤ë” ë¶„ì„:"
            hexdump -C "$APK_FILE" | head -1
            
            # 3. ì•ˆë“œë¡œì´ë“œ ì„¤ì¹˜ ì‹œë®¬ë ˆì´ì…˜
            echo "ğŸ“± ì„¤ì¹˜ í˜¸í™˜ì„± í…ŒìŠ¤íŠ¸:"
            
            # íŒ¨í‚¤ì§€ ê´€ë¦¬ì ì‹œë®¬ë ˆì´ì…˜
            if aapt dump badging "$APK_FILE" >/tmp/badging.txt 2>&1; then
              echo "âœ… íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € íŒŒì‹± ì„±ê³µ"
              
              # ì¤‘ìš”í•œ ì„¤ì¹˜ ê´€ë ¨ ì •ë³´ ì¶”ì¶œ
              echo "ğŸ“‹ ì„¤ì¹˜ ê´€ë ¨ ì •ë³´:"
              grep "package:" /tmp/badging.txt | head -1
              grep "sdkVersion:" /tmp/badging.txt
              grep "targetSdkVersion:" /tmp/badging.txt
              grep "launchable-activity:" /tmp/badging.txt | head -1
              
            else
              echo "âŒ íŒ¨í‚¤ì§€ ë§¤ë‹ˆì € íŒŒì‹± ì‹¤íŒ¨"
              head -5 /tmp/badging.txt
            fi
            
            # 4. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML íŒŒì‹± í…ŒìŠ¤íŠ¸
            echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì‹± í…ŒìŠ¤íŠ¸:"
            if aapt dump xmltree "$APK_FILE" AndroidManifest.xml >/tmp/xmltree.txt 2>&1; then
              echo "âœ… XML íŒŒì‹± ì„±ê³µ"
              echo "ì£¼ìš” ì»´í¬ë„ŒíŠ¸ ê°œìˆ˜:"
              grep -c "E: activity" /tmp/xmltree.txt || echo "activity: 0"
              grep -c "E: receiver" /tmp/xmltree.txt || echo "receiver: 0"
              grep -c "E: service" /tmp/xmltree.txt || echo "service: 0"
            else
              echo "âŒ XML íŒŒì‹± ì‹¤íŒ¨"
              head -5 /tmp/xmltree.txt
            fi
            
            # 5. ì„œëª… ë° ë³´ì•ˆ ê²€ì‚¬
            echo "ğŸ” ë³´ì•ˆ ê²€ì‚¬:"
            if jarsigner -verify "$APK_FILE" >/dev/null 2>&1; then
              echo "âœ… ì„œëª… ê²€ì¦ í†µê³¼"
            else
              echo "âŒ ì„œëª… ê²€ì¦ ì‹¤íŒ¨"
            fi
            
            # 6. ì„¤ì¹˜ ì˜ˆìƒ ê²°ê³¼
            echo "ğŸ¯ ì„¤ì¹˜ ì˜ˆìƒ ê²°ê³¼:"
            if aapt dump badging "$APK_FILE" >/dev/null 2>&1 && jarsigner -verify "$APK_FILE" >/dev/null 2>&1; then
              echo "âœ… ì„¤ì¹˜ ê°€ëŠ¥í•  ê²ƒìœ¼ë¡œ ì˜ˆìƒ"
            else
              echo "âŒ ì„¤ì¹˜ ì‹¤íŒ¨ ì˜ˆìƒ"
            fi
            
            echo "--- $APK_DESC APK ê²€ì¦ ì™„ë£Œ ---"
          else
            echo "âš ï¸ $APK_FILE íŒŒì¼ ì—†ìŒ"
          fi
        done
        
        # ìµœì¢… ê¶Œì¥ì‚¬í•­
        echo ""
        echo "ğŸ’¡ === ìµœì¢… ë¶„ì„ ë° ê¶Œì¥ì‚¬í•­ ==="
        echo "1. ì›ë³¸ APKëŠ” ì •ìƒ ì‘ë™í•˜ëŠ” ìƒíƒœ"
        echo "2. apktool ë¦¬ë¹Œë“œ ê³¼ì •ì—ì„œ ì••ì¶• ë°©ì‹ ë³€ê²½ë¨"
        echo "3. êµ¬ì¡°ì ìœ¼ë¡œëŠ” ë¬¸ì œì—†ìœ¼ë‚˜ ë¯¸ì„¸í•œ í˜¸í™˜ì„± ì´ìŠˆ ê°€ëŠ¥"
        echo ""
        echo "ğŸ› ï¸ í•´ê²° ë°©ì•ˆ:"
        echo "A. í˜„ì¬ ì›Œí¬í”Œë¡œìš°: ì••ì¶• ë°©ì‹ ìµœì í™” ì ìš©"
        echo "B. ëŒ€ì•ˆ ë°©ë²•: buildozer.specì—ì„œ ì§ì ‘ ê¶Œí•œ ì„¤ì •"
        echo "C. ì•± ì½”ë“œ ë°©ë²•: ëŸ°íƒ€ì„ì— ë™ì  receiver ë“±ë¡"
    - name: Advanced APK debugging and validation
      run: |
        echo "=== ğŸ”¬ ì‹¬í™” APK ë””ë²„ê¹… ë° ê²€ì¦ ==="
        
        APK_FILES=(
          "original_backup.apk"
          "rebuilt_doublecheck_unsigned.apk" 
          "rebuilt_doublecheck_signed.apk"
          "final_doublecheck_fixed.apk"
        )
        
        for APK_FILE in "${APK_FILES[@]}"; do
          if [ -f "$APK_FILE" ]; then
            echo ""
            echo "ğŸ” === $APK_FILE ë¶„ì„ ==="
            
            # 1. ê¸°ë³¸ ì •ë³´
            echo "ğŸ“Š íŒŒì¼ í¬ê¸°: $(du -h "$APK_FILE" | cut -f1)"
            echo "ğŸ“Š íŒŒì¼ íƒ€ì…: $(file "$APK_FILE")"
            
            # 2. ZIP êµ¬ì¡° ê²€ì¦
            echo "ğŸ“¦ ZIP êµ¬ì¡° ê²€ì¦:"
            if unzip -t "$APK_FILE" >/dev/null 2>&1; then
              echo "âœ… ZIP êµ¬ì¡° ìœ íš¨"
            else
              echo "âŒ ZIP êµ¬ì¡° ì†ìƒ"
              continue
            fi
            
            # 3. APK ë‚´ë¶€ íŒŒì¼ ëª©ë¡
            echo "ğŸ“‚ APK ë‚´ë¶€ ì£¼ìš” íŒŒì¼:"
            unzip -l "$APK_FILE" | grep -E "(AndroidManifest.xml|classes.dex|META-INF/|resources.arsc)" | head -10
            
            # 4. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì‹± í…ŒìŠ¤íŠ¸
            echo "ğŸ“„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì‹± í…ŒìŠ¤íŠ¸:"
            if aapt dump xmltree "$APK_FILE" AndroidManifest.xml >/dev/null 2>&1; then
              echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì‹± ê°€ëŠ¥"
            else
              echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì‹± ì‹¤íŒ¨"
              aapt dump xmltree "$APK_FILE" AndroidManifest.xml 2>&1 | head -5
            fi
            
            # 5. ì„œëª… ì •ë³´ ìƒì„¸ ë¶„ì„
            echo "ğŸ” ì„œëª… ì •ë³´ ë¶„ì„:"
            if jarsigner -verify -verbose "$APK_FILE" >/dev/null 2>&1; then
              echo "âœ… ì„œëª… ìœ íš¨"
              echo "ì„œëª… ì„¸ë¶€ì •ë³´:"
              jarsigner -verify -verbose "$APK_FILE" 2>&1 | grep -E "(certificate|algorithm)" | head -3
            else
              echo "âŒ ì„œëª… ë¬´íš¨ ë˜ëŠ” ì—†ìŒ"
              jarsigner -verify -verbose "$APK_FILE" 2>&1 | head -3
            fi
            
            # 6. zipalign ìƒíƒœ í™•ì¸
            ZIPALIGN_PATH="$HOME/android-sdk/build-tools/34.0.0/zipalign"
            if [ -f "$ZIPALIGN_PATH" ]; then
              echo "ğŸ”§ zipalign ìƒíƒœ:"
              if $ZIPALIGN_PATH -c 4 "$APK_FILE" >/dev/null 2>&1; then
                echo "âœ… ì˜¬ë°”ë¥´ê²Œ ì •ë ¬ë¨"
              else
                echo "âŒ ì •ë ¬ë˜ì§€ ì•ŠìŒ"
              fi
            fi
            
            # 7. íŒ¨í‚¤ì§€ ì •ë³´ í™•ì¸
            echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì •ë³´:"
            aapt dump badging "$APK_FILE" 2>/dev/null | grep -E "(package:|application:|launchable-activity:)" | head -3
            
            # 8. ê¶Œí•œ í™•ì¸
            echo "ğŸ”‘ ê¶Œí•œ ê°œìˆ˜: $(aapt dump permissions "$APK_FILE" 2>/dev/null | grep -c "uses-permission" || echo "0")"
            
            # 9. dex íŒŒì¼ í™•ì¸
            echo "âš™ï¸ DEX íŒŒì¼:"
            unzip -l "$APK_FILE" | grep "\.dex" | wc -l | xargs echo "DEX íŒŒì¼ ê°œìˆ˜:"
            
            # 10. ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸
            echo "ğŸ“š ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬:"
            NATIVE_COUNT=$(unzip -l "$APK_FILE" | grep "lib/" | wc -l)
            echo "ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ ê°œìˆ˜: $NATIVE_COUNT"
            if [ "$NATIVE_COUNT" -gt 0 ]; then
              unzip -l "$APK_FILE" | grep "lib/" | head -5
            fi
            
            echo "--- $APK_FILE ë¶„ì„ ì™„ë£Œ ---"
          else
            echo "âš ï¸ $APK_FILE íŒŒì¼ ì—†ìŒ"
          fi
        done

    # âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„¸ ë¹„êµ
    - name: Detailed manifest comparison
      run: |
        echo "=== ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„¸ ë¹„êµ ==="
        
        # ê° APKì—ì„œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
        APK_FILES=(
          "original_backup.apk:original"
          "final_doublecheck_fixed.apk:final"
        )
        
        for APK_INFO in "${APK_FILES[@]}"; do
          APK_FILE="${APK_INFO%:*}"
          PREFIX="${APK_INFO#*:}"
          
          if [ -f "$APK_FILE" ]; then
            echo "ğŸ“„ $APK_FILE ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ..."
            
            # aaptë¡œ ì½ê¸° ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì¶”ì¶œ
            aapt dump xmltree "$APK_FILE" AndroidManifest.xml > "${PREFIX}_manifest_readable.xml" 2>/dev/null || echo "âŒ ì¶”ì¶œ ì‹¤íŒ¨"
            
            # apktoolë¡œ ì†ŒìŠ¤ í˜•íƒœë¡œ ì¶”ì¶œ
            rm -rf "${PREFIX}_decode"
            apktool d "$APK_FILE" -o "${PREFIX}_decode" --force >/dev/null 2>&1
            if [ -f "${PREFIX}_decode/AndroidManifest.xml" ]; then
              cp "${PREFIX}_decode/AndroidManifest.xml" "${PREFIX}_manifest_source.xml"
              echo "âœ… ${PREFIX} ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ ì™„ë£Œ"
            fi
          fi
        done
        
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¹„êµ
        if [ -f "original_manifest_source.xml" ] && [ -f "final_manifest_source.xml" ]; then
          echo "ğŸ”„ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì°¨ì´ì  ë¶„ì„:"
          diff original_manifest_source.xml final_manifest_source.xml > manifest_diff.txt || true
          
          if [ -s manifest_diff.txt ]; then
            echo "ë°œê²¬ëœ ì°¨ì´ì :"
            head -30 manifest_diff.txt
          else
            echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì°¨ì´ì  ì—†ìŒ"
          fi
        fi
        
        # receiver ë¶€ë¶„ë§Œ ì¶”ì¶œí•´ì„œ ë¹„êµ
        for PREFIX in original final; do
          if [ -f "${PREFIX}_manifest_source.xml" ]; then
            echo "ğŸ“¡ ${PREFIX} APKì˜ receiver ëª©ë¡:"
            grep -A 10 -B 2 '<receiver' "${PREFIX}_manifest_source.xml" || echo "receiver ì—†ìŒ"
          fi
        done

    # âœ… APK ë°”ì´ë„ˆë¦¬ ë ˆë²¨ ë¶„ì„
    - name: APK binary level analysis
      run: |
        echo "=== ğŸ”¬ APK ë°”ì´ë„ˆë¦¬ ë ˆë²¨ ë¶„ì„ ==="
        
        # originalê³¼ final APK ë¹„êµ
        if [ -f "original_backup.apk" ] && [ -f "final_doublecheck_fixed.apk" ]; then
          echo "ğŸ“Š íŒŒì¼ í¬ê¸° ë¹„êµ:"
          echo "Original: $(stat -c%s original_backup.apk) bytes"
          echo "Final:    $(stat -c%s final_doublecheck_fixed.apk) bytes"
          
          # ZIP ì—”íŠ¸ë¦¬ ê°œìˆ˜ ë¹„êµ
          echo "ğŸ“¦ ZIP ì—”íŠ¸ë¦¬ ê°œìˆ˜:"
          echo "Original: $(unzip -l original_backup.apk | grep -c "^[ ]*[0-9]")"
          echo "Final:    $(unzip -l final_doublecheck_fixed.apk | grep -c "^[ ]*[0-9]")"
          
          # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë°”ì´ë„ˆë¦¬ í¬ê¸° ë¹„êµ
          echo "ğŸ“„ AndroidManifest.xml í¬ê¸°:"
          unzip -l original_backup.apk | grep "AndroidManifest.xml"
          unzip -l final_doublecheck_fixed.apk | grep "AndroidManifest.xml"
          
          # META-INF ë¹„êµ
          echo "ğŸ” META-INF ë””ë ‰í† ë¦¬ ë‚´ìš©:"
          echo "Original META-INF:"
          unzip -l original_backup.apk | grep "META-INF" || echo "META-INF ì—†ìŒ"
          echo "Final META-INF:"
          unzip -l final_doublecheck_fixed.apk | grep "META-INF" || echo "META-INF ì—†ìŒ"
          
          # ì²« 32ë°”ì´íŠ¸ ë¹„êµ (ZIP í—¤ë”)
          echo "ğŸ” ZIP í—¤ë” ë¹„êµ:"
          echo "Original ì²« 32ë°”ì´íŠ¸:"
          hexdump -C original_backup.apk | head -2
          echo "Final ì²« 32ë°”ì´íŠ¸:"
          hexdump -C final_doublecheck_fixed.apk | head -2
        fi

    # âœ… í˜¸í™˜ì„± ê²€ì‚¬
    - name: Compatibility check
      run: |
        echo "=== ğŸ”§ í˜¸í™˜ì„± ê²€ì‚¬ ==="
        
        APK_FILE="final_doublecheck_fixed.apk"
        
        if [ -f "$APK_FILE" ]; then
          echo "ğŸ“± Android í˜¸í™˜ì„± ê²€ì‚¬..."
          
          # 1. ìµœì†Œ SDK ë²„ì „ í™•ì¸
          echo "ğŸ¯ SDK ë²„ì „ ì •ë³´:"
          aapt dump badging "$APK_FILE" 2>/dev/null | grep -E "(sdkVersion|targetSdkVersion)" || echo "SDK ë²„ì „ ì •ë³´ ì—†ìŒ"
          
          # 2. ì•„í‚¤í…ì²˜ ì§€ì› í™•ì¸
          echo "ğŸ—ï¸ ì•„í‚¤í…ì²˜ ì§€ì›:"
          aapt dump configurations "$APK_FILE" 2>/dev/null | head -10 || echo "êµ¬ì„± ì •ë³´ ì—†ìŒ"
          
          # 3. í•„ìˆ˜ ê¸°ëŠ¥ í™•ì¸
          echo "âš™ï¸ í•„ìˆ˜ ê¸°ëŠ¥:"
          aapt dump badging "$APK_FILE" 2>/dev/null | grep "uses-feature" | head -5 || echo "í•„ìˆ˜ ê¸°ëŠ¥ ì—†ìŒ"
          
          # 4. í™”ë©´ ì§€ì› í™•ì¸
          echo "ğŸ“º í™”ë©´ ì§€ì›:"
          aapt dump badging "$APK_FILE" 2>/dev/null | grep "supports-screens" || echo "í™”ë©´ ì§€ì› ì •ë³´ ì—†ìŒ"
          
          # 5. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í•„ìˆ˜ ìš”ì†Œ í™•ì¸
          echo "âœ… í•„ìˆ˜ ìš”ì†Œ ì²´í¬ë¦¬ìŠ¤íŠ¸:"
          
          # íŒ¨í‚¤ì§€ëª… í™•ì¸
          if aapt dump badging "$APK_FILE" 2>/dev/null | grep -q "package:"; then
            echo "âœ… íŒ¨í‚¤ì§€ëª… ì¡´ì¬"
          else
            echo "âŒ íŒ¨í‚¤ì§€ëª… ì—†ìŒ"
          fi
          
          # ë©”ì¸ ì•¡í‹°ë¹„í‹° í™•ì¸
          if aapt dump badging "$APK_FILE" 2>/dev/null | grep -q "launchable-activity:"; then
            echo "âœ… ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡í‹°ë¹„í‹° ì¡´ì¬"
          else
            echo "âŒ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡í‹°ë¹„í‹° ì—†ìŒ"
          fi
          
          # ì• í”Œë¦¬ì¼€ì´ì…˜ íƒœê·¸ í™•ì¸
          if aapt dump badging "$APK_FILE" 2>/dev/null | grep -q "application:"; then
            echo "âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ íƒœê·¸ ì¡´ì¬"
          else
            echo "âŒ ì• í”Œë¦¬ì¼€ì´ì…˜ íƒœê·¸ ì—†ìŒ"
          fi
          
          # 6. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML ìœ íš¨ì„± ì¬ê²€ì¦
          echo "ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ XML êµ¬ì¡° ì¬ê²€ì¦:"
          if aapt dump xmltree "$APK_FILE" AndroidManifest.xml >/tmp/manifest_dump.txt 2>&1; then
            echo "âœ… XML êµ¬ì¡° ìœ íš¨"
            echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì£¼ìš” íƒœê·¸ ê°œìˆ˜:"
            grep -c "E: application" /tmp/manifest_dump.txt || echo "application: 0"
            grep -c "E: activity" /tmp/manifest_dump.txt || echo "activity: 0"
            grep -c "E: receiver" /tmp/manifest_dump.txt || echo "receiver: 0"
            grep -c "E: uses-permission" /tmp/manifest_dump.txt || echo "uses-permission: 0"
          else
            echo "âŒ XML êµ¬ì¡° ì˜¤ë¥˜"
            head -10 /tmp/manifest_dump.txt
          fi
        fi
        
        echo "ğŸ‰ í˜¸í™˜ì„± ê²€ì‚¬ ì™„ë£Œ!"

    # âœ… ë¹Œë“œ ë¡œê·¸ ì—…ë¡œë“œ
    - name: Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs-${{ github.run_number }}
        path: |
          build_full.log
          apk_info.txt
          manifest_diff.txt
          original_manifest_*.xml
          final_manifest_*.xml
          .buildozer/**/*.log
          original_analysis/AndroidManifest.xml
          final_verification/AndroidManifest.xml
          decoded_apk_clean/AndroidManifest.xml.backup
        retention-days: 30
        if-no-files-found: warn

    # âœ… ìµœì¢… APK ì—…ë¡œë“œ
    - name: Upload final APKs
      uses: actions/upload-artifact@v4
      with:
        name: doublecheck-apks-${{ github.run_number }}
        path: |
          final_doublecheck_fixed.apk
          original_backup.apk
          rebuilt_doublecheck_unsigned.apk
          rebuilt_doublecheck_signed.apk
        retention-days: 7
        if-no-files-found: error

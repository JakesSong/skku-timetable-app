# ✅ APK 수정 (ZIP 방식으로 직접 교체 - aapt 포기!)
- name: Modify APK with direct ZIP method (bypass aapt)
  run: |
    echo "=== 🔧 APK 수정 (ZIP 직접 방식으로 AlarmReceiver 추가) ==="
    
    if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
      echo "❌ 원본 APK 없음"
      exit 1
    fi
    
    echo "🎯 대상 APK: $ORIGINAL_APK"
    
    # 백업 생성
    cp "$ORIGINAL_APK" original_backup.apk
    echo "✅ 원본 백업 완료"
    
    # 작업 디렉토리 생성
    mkdir -p zip_work
    cd zip_work
    
    # APK를 ZIP으로 처리
    cp "../$ORIGINAL_APK" work.apk
    
    # 1. 현재 매니페스트 추출
    unzip -j work.apk AndroidManifest.xml
    echo "📄 원본 매니페스트 추출 완료"
    
    # 2. aapt dump를 사용해서 XML 텍스트로 변환
    aapt dump xmltree work.apk AndroidManifest.xml > manifest_text.txt
    echo "📄 매니페스트 텍스트 변환 완료"
    
    # 3. 템플릿이 있다면 사용, 없다면 원본 기반으로 텍스트 매니페스트 생성
    if [ -f "../AndroidManifest.tmpl.xml" ]; then
      echo "✅ 템플릿 파일 사용"
      cp "../AndroidManifest.tmpl.xml" new_manifest_text.xml
    else
      echo "❌ 템플릿 없음 - 원본 기반으로 처리"
      
      # 간단한 텍스트 매니페스트 생성 (최소한만)
      cat > new_manifest_text.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="org.kivy.skkutimetable.doublecheck"
    android:versionCode="1"
    android:versionName="0.1">
    
    <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
    <uses-permission android:name="android.permission.WAKE_LOCK" />
    <uses-permission android:name="android.permission.VIBRATE" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
    
    <application android:label="DoubleCheck">
        <activity android:name="org.kivy.android.PythonActivity"
                  android:label="DoubleCheck"
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
        
        <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" 
                  android:enabled="true" 
                  android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.BOOT_COMPLETED" />
            </intent-filter>
        </receiver>
    </application>
</manifest>
EOF
      echo "📄 기본 매니페스트 생성 완료"
    fi
    
    # 4. receiver 추가 (템플릿에 없는 경우만)
    if ! grep -q "AlarmReceiver" new_manifest_text.xml; then
      echo "📝 AlarmReceiver 추가 중..."
      sed -i 's|</application>|    <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true"><intent-filter><action android:name="android.intent.action.BOOT_COMPLETED" /></intent-filter></receiver></application>|' new_manifest_text.xml
    else
      echo "✅ AlarmReceiver 이미 존재"
    fi
    
    # 5. 텍스트 매니페스트를 바이너리로 변환
    echo "🔄 바이너리 매니페스트 생성 중..."
    
    # 임시 APK 생성 (매니페스트만)
    mkdir -p temp_res/values
    echo '<?xml version="1.0" encoding="utf-8"?><resources><string name="app_name">DoubleCheck</string></resources>' > temp_res/values/strings.xml
    
    aapt package -f \
      -M new_manifest_text.xml \
      -S temp_res \
      -I "/home/runner/android-sdk/platforms/android-33/android.jar" \
      -F temp_with_manifest.apk
    
    if [ -f "temp_with_manifest.apk" ]; then
      echo "✅ 임시 APK 생성 성공"
      
      # 새 바이너리 매니페스트 추출
      unzip -j temp_with_manifest.apk AndroidManifest.xml -d new_manifest
      
      if [ -f "new_manifest/AndroidManifest.xml" ]; then
        echo "✅ 새 바이너리 매니페스트 추출 성공"
        
        # 원본 APK에 새 매니페스트 삽입
        cp work.apk final.apk
        cd new_manifest
        zip -u ../final.apk AndroidManifest.xml
        cd ..
        
        echo "📦 매니페스트 교체 완료"
        
        # 검증
        if aapt dump badging final.apk >/dev/null 2>&1; then
          echo "✅ 수정된 APK 유효성 검사 통과"
          
          # receiver 개수 확인
          RECEIVER_COUNT=$(aapt dump xmltree final.apk AndroidManifest.xml | grep -c "receiver" || echo "0")
          echo "📱 Receiver 개수: $RECEIVER_COUNT"
          
          # 최종 APK 복사
          cp final.apk ../final_doublecheck_fixed.apk
          echo "🎉 최종 APK 생성 성공: final_doublecheck_fixed.apk"
          
        else
          echo "❌ 수정된 APK 유효성 검사 실패"
          aapt dump badging final.apk 2>&1 | head -5
          exit 1
        fi
      else
        echo "❌ 새 매니페스트 추출 실패"
        exit 1
      fi
    else
      echo "❌ 임시 APK 생성 실패"
      exit 1
    fi
    
    cd ..

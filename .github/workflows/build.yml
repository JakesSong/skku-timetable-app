name: Build Android APK with Direct p4a
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          openjdk-17-jdk-headless \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        # p4a ì§ì ‘ ì„¤ì¹˜ (ìµœì‹  ë²„ì „ ì‚¬ìš©)
        pip install python-for-android==2024.1.21
        pip install kivy==2.1.0
        pip install kivymd==1.1.1
    
    - name: Setup Android SDK and NDK
      run: |
        # Android SDK ì„¤ì¹˜
        mkdir -p ~/.android
        cd ~/.android
        wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip commandlinetools-linux-9477386_latest.zip
        mkdir -p sdk/cmdline-tools
        mv cmdline-tools sdk/cmdline-tools/latest
        
        export ANDROID_SDK_ROOT=~/.android/sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
        
        # SDK ì»´í¬ë„ŒíŠ¸ ì„¤ì¹˜
        yes | sdkmanager --licenses
        sdkmanager "platforms;android-33" "build-tools;32.0.0" "ndk;25.2.9519653"
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        echo "ANDROID_SDK_ROOT=~/.android/sdk" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=~/.android/sdk/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "PATH=$PATH:~/.android/sdk/cmdline-tools/latest/bin:~/.android/sdk/platform-tools" >> $GITHUB_ENV
    
    - name: Create p4a build script
      run: |
        cat > build_with_p4a.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import sys
        import subprocess
        import shutil
        
        # í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        os.environ['ANDROID_SDK_ROOT'] = os.path.expanduser('~/.android/sdk')
        os.environ['ANDROID_NDK_ROOT'] = os.path.expanduser('~/.android/sdk/ndk/25.2.9519653')
        os.environ['JAVA_HOME'] = '/opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.15-6/x64'
        
        # p4a ëª…ë ¹ì–´ êµ¬ì„±
        cmd = [
            'p4a', 'apk',
            '--private', '.',
            '--package', 'org.kivy.skkutimetable.doublecheck',
            '--name', 'DoubleCheck',
            '--version', '0.1',
            '--bootstrap', 'sdl2',
            '--requirements', 'python3,kivy==2.1.0,kivymd==1.1.1,requests,pillow,certifi,urllib3,charset-normalizer,plyer,sqlite3',
            '--permissions', 'INTERNET,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,SCHEDULE_EXACT_ALARM,USE_EXACT_ALARM,VIBRATE,WAKE_LOCK,RECEIVE_BOOT_COMPLETED,FOREGROUND_SERVICE,POST_NOTIFICATIONS,ACCESS_NOTIFICATION_POLICY',
            '--arch', 'arm64-v8a',
            '--release',
            # ðŸ”¥ í•µì‹¬: ì»¤ìŠ¤í…€ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ë° Java ì†ŒìŠ¤ ì¶”ê°€
            '--add-source', 'android/src/main/java',
            '--add-jar', 'android/libs/alarmreceiver.jar',
        ]
        
        # AndroidManifest.tmpl.xmlì´ ìžˆìœ¼ë©´ ì¶”ê°€
        if os.path.exists('AndroidManifest.tmpl.xml'):
            cmd.extend(['--manifest-template', 'AndroidManifest.tmpl.xml'])
            print("âœ… AndroidManifest.tmpl.xml ì‚¬ìš©")
        else:
            print("âŒ AndroidManifest.tmpl.xml ì—†ìŒ")
        
        print("ðŸš€ p4a ëª…ë ¹ì–´:")
        print(' '.join(cmd))
        
        # p4a ì‹¤í–‰
        try:
            result = subprocess.run(cmd, capture_output=True, text=True)
            print("ðŸ“‹ p4a stdout:")
            print(result.stdout)
            if result.stderr:
                print("âš ï¸ p4a stderr:")
                print(result.stderr)
            
            if result.returncode != 0:
                print(f"âŒ p4a ì‹¤íŒ¨, ì¢…ë£Œ ì½”ë“œ: {result.returncode}")
                sys.exit(1)
            else:
                print("âœ… p4a ë¹Œë“œ ì„±ê³µ!")
                
        except Exception as e:
            print(f"âŒ p4a ì‹¤í–‰ ì˜¤ë¥˜: {e}")
            sys.exit(1)
        
        EOF
        
        chmod +x build_with_p4a.py
    
    - name: Check required files
      run: |
        echo "=== ðŸ” í•„ìˆ˜ íŒŒì¼ í™•ì¸ ==="
        echo "AndroidManifest.tmpl.xml: $([ -f "AndroidManifest.tmpl.xml" ] && echo "âœ…" || echo "âŒ")"
        echo "android/libs/alarmreceiver.jar: $([ -f "android/libs/alarmreceiver.jar" ] && echo "âœ…" || echo "âŒ")"
        echo "Java ì†ŒìŠ¤:"
        find android/src -name "*.java" || echo "âŒ Java íŒŒì¼ ì—†ìŒ"
    
    - name: Build APK with p4a
      run: |
        python build_with_p4a.py
    
    - name: Check generated APK and manifest
      run: |
        echo "=== ðŸ” ìƒì„±ëœ APK í™•ì¸ ==="
        find . -name "*.apk" -type f
        
        echo ""
        echo "=== ðŸ” p4a ìƒì„± ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ í™•ì¸ ==="
        P4A_DIST=$(find ~/.local/share/python-for-android/dists -name "*doublecheck*" -type d | head -1)
        if [ -n "$P4A_DIST" ]; then
          echo "p4a dist ë””ë ‰í† ë¦¬: $P4A_DIST"
          MANIFEST="$P4A_DIST/AndroidManifest.xml"
          if [ -f "$MANIFEST" ]; then
            echo "âœ… p4a ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ë°œê²¬: $MANIFEST"
            echo "AlarmReceiver í¬í•¨: $(grep -c "AlarmReceiver" "$MANIFEST" || echo "0")"
            if grep -q "AlarmReceiver" "$MANIFEST"; then
              echo "ðŸŽ‰ AlarmReceiver ë“±ë¡ë¨!"
              grep -A 5 -B 2 "AlarmReceiver" "$MANIFEST"
            else
              echo "âŒ AlarmReceiver ì—¬ì „ížˆ ì—†ìŒ"
            fi
          else
            echo "âŒ p4a ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ ì—†ìŒ"
          fi
        else
          echo "âŒ p4a dist ë””ë ‰í† ë¦¬ ì—†ìŒ"
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: p4a-direct-build-apk
        path: "*.apk"
        retention-days: 7
        if-no-files-found: warn

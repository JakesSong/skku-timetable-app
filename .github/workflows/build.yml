name: Build Android APK
on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'

    # âœ… ì™„ì „í•œ í´ë¦° ë¹Œë“œ
    - name: Complete clean build
      run: |
        echo "=== ğŸ§¹ Completely cleaning build environment ==="
        rm -rf .buildozer bin build android/build android/.gradle
        rm -rf ~/.buildozer ~/.gradle ~/.android
        echo "âœ… ëª¨ë“  ìºì‹œ ì œê±° ì™„ë£Œ"

    # âœ… Java 17 ì„¸íŒ…
    - name: Set up Java 17 for buildozer
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # âœ… ì‹œìŠ¤í…œ ì¢…ì† íŒ¨í‚¤ì§€ ì„¤ì¹˜
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev aapt

    # âœ… íŒŒì´ì¬ ì˜ì¡´ì„± ì„¤ì¹˜
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install Cython==0.29.33
        pip install buildozer==1.4.0

    # âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
    - name: Set environment variables
      run: |
        echo "P4A_NUM_PROCS=1" >> $GITHUB_ENV
        echo "GRADLE_OPTS=-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs='-Xmx3072m -XX:MaxMetaspaceSize=768m' -Dorg.gradle.parallel=false" >> $GITHUB_ENV
        echo "P4A_GRADLE_OPTS=--stacktrace --info" >> $GITHUB_ENV

    # âœ… APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜
    - name: Install APK modification tools
      run: |
        echo "=== ğŸ› ï¸ APK ìˆ˜ì • ë„êµ¬ ì„¤ì¹˜ ==="
        
        # Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ì„¤ì¹˜
        echo "ğŸ“¥ Android SDK ëª…ë ¹ì¤„ ë„êµ¬ ë‹¤ìš´ë¡œë“œ..."
        mkdir -p ~/android-sdk
        cd ~/android-sdk
        
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
        unzip -q commandlinetools-linux-11076708_latest.zip
        mkdir -p cmdline-tools/latest
        mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
        
        # í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ANDROID_HOME ì¶”ê°€!)
        export ANDROID_SDK_ROOT=~/android-sdk
        export ANDROID_HOME=~/android-sdk
        export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/build-tools/34.0.0
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/build-tools/34.0.0" >> $GITHUB_PATH
        
        # SDK ë¼ì´ì„¼ìŠ¤ ìë™ ë™ì˜
        yes | sdkmanager --licenses || true
        
        # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (platforms ì¶”ê°€!)
        echo "ğŸ”§ Android SDK íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
        sdkmanager "build-tools;34.0.0" "platform-tools" "platforms;android-33"
        
        # ì„¤ì¹˜ í™•ì¸
        echo "ğŸ“‹ ì„¤ì¹˜ í™•ì¸:"
        ls -la ~/android-sdk/platforms/ || echo "platforms ë””ë ‰í† ë¦¬ ì—†ìŒ"
        if [ -f "~/android-sdk/platforms/android-33/android.jar" ]; then
          echo "âœ… android.jar ë°œê²¬"
        else
          echo "âŒ android.jar ì—†ìŒ"
        fi
        
        echo "âœ… ëª¨ë“  ë„êµ¬ ì„¤ì¹˜ ì™„ë£Œ"

    # âœ… ë¹Œë“œ ìˆ˜í–‰
    - name: Build APK with buildozer
      run: |
        echo "=== ğŸ”¨ Buildozer APK ë¹Œë“œ ==="
        buildozer android debug --verbose > build_full.log 2>&1 || BUILD_FAILED=true
        if [ "$BUILD_FAILED" = "true" ]; then
          echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
          echo "=== ë¹Œë“œ ë¡œê·¸ ë§ˆì§€ë§‰ 100ì¤„ ==="
          tail -100 build_full.log
          exit 1
        else
          echo "âœ… ë¹Œë“œ ì„±ê³µ!"
        fi

    # âœ… APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦
    - name: Find and verify APK
      run: |
        echo "=== ğŸ” APK íŒŒì¼ ì°¾ê¸° ë° ê²€ì¦ ==="
        
        # APK íŒŒì¼ ìë™ íƒì§€
        POSSIBLE_APKS=(
          "./bin/doublecheck-0.1-arm64-v8a-debug.apk"
          "./bin/*.apk"
          ".buildozer/android/platform/build-arm64-v8a/dists/doublecheck/build/outputs/apk/debug/*.apk"
        )
        
        FOUND_APK=""
        for apk_pattern in "${POSSIBLE_APKS[@]}"; do
          for apk_file in $apk_pattern; do
            if [ -f "$apk_file" ]; then
              FOUND_APK="$apk_file"
              echo "âœ… APK ë°œê²¬: $FOUND_APK"
              break 2
            fi
          done
        done
        
        if [ -z "$FOUND_APK" ]; then
          FOUND_APK=$(find . -name "*debug*.apk" -type f | head -1)
          if [ -n "$FOUND_APK" ]; then
            echo "âœ… ì „ì²´ ê²€ìƒ‰ìœ¼ë¡œ APK ë°œê²¬: $FOUND_APK"
          else
            echo "âŒ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
            exit 1
          fi
        fi
        
        echo "ORIGINAL_APK=$FOUND_APK" >> $GITHUB_ENV
        echo "ğŸ“Š APK í¬ê¸°: $(du -h "$FOUND_APK" | cut -f1)"
        
        # ì›ë³¸ APK ìœ íš¨ì„± ê²€ì‚¬
        if aapt dump badging "$FOUND_APK" >/dev/null 2>&1; then
          echo "âœ… ì›ë³¸ APK êµ¬ì¡° ìœ íš¨"
        else
          echo "âŒ ì›ë³¸ APK êµ¬ì¡° ì˜¤ë¥˜"
          exit 1
        fi

    # âœ… APK ìˆ˜ì • (aapt2 ë°©ì‹ìœ¼ë¡œ AlarmReceiver ì¶”ê°€)
    - name: Modify APK with aapt2 method (replacing apktool)
      run: |
        echo "=== ğŸ”§ APK ìˆ˜ì • (aapt2 ë°©ì‹ìœ¼ë¡œ AlarmReceiver ì¶”ê°€) ==="
        
        if [ -z "${ORIGINAL_APK:-}" ] || [ ! -f "$ORIGINAL_APK" ]; then
          echo "âŒ ì›ë³¸ APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ¯ ëŒ€ìƒ APK: $ORIGINAL_APK"
        
        # ë°±ì—… ìƒì„±
        cp "$ORIGINAL_APK" original_backup.apk
        echo "âœ… ì›ë³¸ ë°±ì—… ì™„ë£Œ"
        
        # aapt2 ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •
        mkdir -p aapt2_work
        cd aapt2_work
        
        # APK ì••ì¶• í•´ì œ
        cp "../$ORIGINAL_APK" original.apk
        unzip -q original.apk
        
        echo "ğŸ“„ í˜„ì¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë¶„ì„..."
        if aapt dump xmltree original.apk AndroidManifest.xml > current_manifest.txt 2>&1; then
          echo "í˜„ì¬ receiver ê°œìˆ˜: $(grep -c "receiver" current_manifest.txt || echo "0")"
          grep -c "receiver" current_manifest.txt || echo "0"
        fi
        
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ìƒì„± ë° ë””ë²„ê¹…
        echo "Creating new manifest..."
        
        # 1. í˜„ì¬ ìƒí™© ì ê²€
        echo "ğŸ” í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo "ğŸ“ í˜„ì¬ íŒŒì¼ë“¤:"
        ls -la
        
        # 2. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ìƒì„±
        if [ -f "../AndroidManifest.tmpl.xml" ]; then
          echo "âœ… í…œí”Œë¦¿ íŒŒì¼ ë°œê²¬"
          cp "../AndroidManifest.tmpl.xml" new_manifest.xml
        elif [ -f "AndroidManifest.xml" ]; then
          echo "âœ… ì›ë³¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚¬ìš©"
          cp AndroidManifest.xml new_manifest.xml
        else
          echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          echo "ğŸ“ ê°€ëŠ¥í•œ íŒŒì¼ë“¤:"
          find . -name "*manifest*" -o -name "*Manifest*" 2>/dev/null
          exit 1
        fi
        
        # 3. íŒŒì¼ ìƒì„± í™•ì¸
        if [ ! -f "new_manifest.xml" ]; then
          echo "âŒ new_manifest.xml ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
        echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì¤€ë¹„ë¨: $(wc -l < new_manifest.xml) ì¤„"
        
        # 4. receiver ì¶”ê°€
        echo "Adding receiver..."
        sed -i 's|</application>|    <receiver android:name="org.kivy.skkutimetable.doublecheck.AlarmReceiver" android:enabled="true" android:exported="true"><intent-filter><action android:name="android.intent.action.BOOT_COMPLETED" /></intent-filter></receiver></application>|' new_manifest.xml
        
        # 5. ìˆ˜ì • ê²°ê³¼ í™•ì¸
        echo "ğŸ“„ ìˆ˜ì •ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸:"
        echo "íŒŒì¼ í¬ê¸°: $(wc -l < new_manifest.xml) ì¤„"
        echo "receiver ê°œìˆ˜: $(grep -c "receiver" new_manifest.xml || echo "0")"
        
        # 6. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬ ì¬í™•ì¸
        if [ ! -f "new_manifest.xml" ]; then
          echo "âŒ ìˆ˜ì • í›„ new_manifest.xmlì´ ì‚¬ë¼ì§"
          exit 1
        fi
        
        echo "New manifest created"
        
        # ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¤€ë¹„
        mkdir -p temp_res/values
        echo '<?xml version="1.0" encoding="utf-8"?><resources></resources>' > temp_res/values/strings.xml
        
        # ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ ë³µì‚¬
        if [ -d "res" ]; then
          cp -r res/* temp_res/ 2>/dev/null || true
        fi
        
        # 7. aapt ëª…ë ¹ì–´ì—ì„œ ì ˆëŒ€ ê²½ë¡œ ì‚¬ìš©
        echo "Creating new APK with aapt..."
        MANIFEST_PATH="$(pwd)/new_manifest.xml"
        RESOURCES_PATH="$(pwd)/temp_res"
        OUTPUT_PATH="$(pwd)/new.apk"
        
        echo "ğŸ“ ì‚¬ìš©í•  ê²½ë¡œë“¤:"
        echo "  ë§¤ë‹ˆí˜ìŠ¤íŠ¸: $MANIFEST_PATH"
        echo "  ë¦¬ì†ŒìŠ¤: $RESOURCES_PATH"  
        echo "  ì¶œë ¥: $OUTPUT_PATH"
        
        # 8. íŒŒì¼ ì¡´ì¬ í™•ì¸
        if [ ! -f "$MANIFEST_PATH" ]; then
          echo "âŒ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ì—†ìŒ: $MANIFEST_PATH"
          exit 1
        fi
        
        if [ ! -d "$RESOURCES_PATH" ]; then
          echo "âŒ ë¦¬ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì—†ìŒ: $RESOURCES_PATH"
          exit 1
        fi
        
        # 9. aapt ì‹¤í–‰ (android.jar ê²½ë¡œ í™•ì¸ ì¶”ê°€)
        echo "ğŸ” Android SDK í™˜ê²½ í™•ì¸:"
        echo "ANDROID_HOME: ${ANDROID_HOME:-ì—†ìŒ}"
        echo "ANDROID_SDK_ROOT: ${ANDROID_SDK_ROOT:-ì—†ìŒ}"
        
        # android.jar ê²½ë¡œ ì°¾ê¸°
        ANDROID_JAR=""
        if [ -f "$ANDROID_HOME/platforms/android-33/android.jar" ]; then
          ANDROID_JAR="$ANDROID_HOME/platforms/android-33/android.jar"
          echo "âœ… android-33.jar ë°œê²¬: $ANDROID_JAR"
        elif [ -f "$ANDROID_HOME/platforms/android-34/android.jar" ]; then
          ANDROID_JAR="$ANDROID_HOME/platforms/android-34/android.jar"
          echo "âœ… android-34.jar ë°œê²¬: $ANDROID_JAR"
        else
          echo "âŒ android.jarë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ"
          echo "ì‚¬ìš© ê°€ëŠ¥í•œ platforms:"
          ls -la "$ANDROID_HOME/platforms/" 2>/dev/null || echo "platforms ë””ë ‰í† ë¦¬ ì—†ìŒ"
          exit 1
        fi
        
        aapt package -f \
          -M "$MANIFEST_PATH" \
          -S "$RESOURCES_PATH" \
          -I "$ANDROID_JAR" \
          -F "$OUTPUT_PATH"
        
        if [ -f "new.apk" ]; then
          echo "New APK created successfully"
          
          # ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì¶”ì¶œ
          unzip -j new.apk AndroidManifest.xml -d .
          
          # ì›ë³¸ APKì— ìƒˆ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‚½ì…
          cp original.apk modified.apk
          zip -u modified.apk AndroidManifest.xml
          
          echo "Modified APK created"
          
          # ê²€ì¦
          if aapt dump badging modified.apk >/dev/null 2>&1; then
            echo "SUCCESS: Modified APK is valid"
            aapt dump badging modified.apk | head -3
            echo "Receiver count:"
            aapt dump xmltree modified.apk AndroidManifest.xml | grep -c "receiver" || echo "0"
            
            # ìˆ˜ì •ëœ APKë¥¼ ìµœì¢… ìœ„ì¹˜ë¡œ ë³µì‚¬
            cp modified.apk ../final_doublecheck_fixed.apk
            echo "âœ… ìµœì¢… APK ìƒì„±: final_doublecheck_fixed.apk"
          else
            echo "FAILED: Modified APK is invalid"
            aapt dump badging modified.apk 2>&1 | head -5
          fi
        else
          echo "Failed to create new APK"
        fi
        
        cd ..

    # âœ… ìµœì¢… APK ê²€ì¦
    - name: Final APK validation
      run: |
        echo "=== ğŸ¯ ìµœì¢… APK ê²€ì¦ ==="
        
        APK_TO_TEST="final_doublecheck_fixed.apk"
        
        if [ ! -f "$APK_TO_TEST" ]; then
          echo "âŒ ìµœì¢… APK ì—†ìŒ"
          exit 1
        fi
        
        echo "ğŸ“± ìµœì¢… APK ì •ë³´:"
        echo "íŒŒì¼ëª…: $APK_TO_TEST"
        echo "í¬ê¸°: $(du -h "$APK_TO_TEST" | cut -f1)"
        
        # APK êµ¬ì¡° ê²€ì¦
        echo "ğŸ” APK êµ¬ì¡° ê²€ì¦..."
        if aapt dump badging "$APK_TO_TEST" > apk_info.txt 2>&1; then
          echo "âœ… APK êµ¬ì¡° ìœ íš¨"
          
          # íŒ¨í‚¤ì§€ ì •ë³´ ì¶œë ¥
          echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì •ë³´:"
          grep "package:" apk_info.txt | head -3
          grep "application:" apk_info.txt | head -1
          grep "launchable-activity:" apk_info.txt | head -1
          
        else
          echo "âŒ APK êµ¬ì¡° ì˜¤ë¥˜"
          cat apk_info.txt
          exit 1
        fi
        
        echo "ğŸ‰ ìµœì¢… ìˆ˜ì •ëœ APK ì¤€ë¹„ ì™„ë£Œ: $APK_TO_TEST"
        echo "ğŸ“± ì„¤ì¹˜ ê°€ëŠ¥í•œ APK ìƒì„±ë¨!"

    # âœ… ìµœì¢… APK ì—…ë¡œë“œ
    - name: Upload final APKs
      uses: actions/upload-artifact@v4
      with:
        name: doublecheck-apks-${{ github.run_number }}
        path: |
          final_doublecheck_fixed.apk
          original_backup.apk
        retention-days: 7

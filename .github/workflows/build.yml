name: Build Kivy Android APK (Fixed NDK 25)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.10
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Set up Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y \
          git zip unzip autoconf libtool pkg-config \
          zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake \
          libffi-dev libssl-dev build-essential libsqlite3-dev sqlite3 \
          bzip2 libbz2-dev libreadline-dev llvm \
          xz-utils tk-dev libxml2-dev libxmlsec1-dev liblzma-dev \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev \
          libfreetype6-dev libpng-dev libjpeg-dev
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install specific NDK version and cleanup
      run: |
        echo "=== ğŸ”§ NDK 25.2.9519653 ì„¤ì¹˜ ë° NDK 27 ì œê±° ==="
        
        # NDK 25.2.9519653 ì„¤ì¹˜
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        
        # NDK 27 ì œê±° (ëª¨ë“  ê°€ëŠ¥í•œ ë²„ì „)
        echo "=== ğŸ§¹ NDK 27 ë²„ì „ë“¤ ì œê±° ==="
        find $ANDROID_HOME/ndk -name "*27.*" -type d -exec rm -rf {} + 2>/dev/null || true
        
        # NDK 25ë¡œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/25.2.9519653
        export NDK_ROOT=$ANDROID_NDK_ROOT
        
        echo "=== âœ… NDK ì„¤ì • í™•ì¸ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
        echo "ì‚¬ìš© ê°€ëŠ¥í•œ NDK ë²„ì „ë“¤:"
        ls -la $ANDROID_HOME/ndk/
        echo "NDK 25 ë‚´ìš© í™•ì¸:"
        ls -la $ANDROID_NDK_ROOT/ | head -10
        
        # GitHub ENVì— ì €ì¥
        echo "ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
        echo "NDK_ROOT=$ANDROID_NDK_ROOT" >> $GITHUB_ENV
    
    - name: Install Python dependencies
      run: |
        echo "=== ğŸ Python ì˜ì¡´ì„± ì„¤ì¹˜ ==="
        python -m pip install --upgrade pip setuptools wheel
        
        # ê²€ì¦ëœ ë²„ì „ìœ¼ë¡œ ê³ ì • ì„¤ì¹˜
        pip install Cython==0.29.33
        pip install python-for-android==2024.1.21
        pip install kivy==2.1.0
        pip install kivymd==1.1.1
        pip install requests pillow plyer
        # sqlite3ëŠ” ë‚´ì¥ ëª¨ë“ˆì´ë¯€ë¡œ ì œì™¸
        
        echo "=== âœ… ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€ í™•ì¸ ==="
        pip list | grep -E "(kivy|p4a|python-for-android|cython)"
    
    - name: Clear p4a cache (Fresh Build)
      run: |
        echo "=== ğŸ§¹ p4a ìºì‹œ í´ë¦¬ì–´ ==="
        rm -rf ~/.local/share/python-for-android || true
        rm -rf ~/.buildozer || true
        echo "âœ… ìºì‹œ í´ë¦¬ì–´ ì™„ë£Œ"
    
    - name: Create p4a build script
      run: |
        cat > build_apk.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import sys
        import subprocess
        import shutil
        from pathlib import Path
        
        def main():
            print("=== ğŸš€ Kivy Android APK ë¹Œë“œ ì‹œì‘ ===")
            
            # í™˜ê²½ë³€ìˆ˜ ì¬í™•ì¸ ë° ì„¤ì •
            android_sdk = os.environ.get('ANDROID_SDK_ROOT')
            android_ndk = os.environ.get('ANDROID_NDK_ROOT')
            java_home = os.environ.get('JAVA_HOME')
            
            print(f"ANDROID_SDK_ROOT: {android_sdk}")
            print(f"ANDROID_NDK_ROOT: {android_ndk}")
            print(f"JAVA_HOME: {java_home}")
            
            # NDK 27 ê²½ë¡œ ì²´í¬ (ë³´í—˜)
            if android_ndk and '27.2.12479018' in android_ndk:
                print("âŒ ì—¬ì „íˆ NDK 27ì„ ì‚¬ìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤!")
                # NDK 25ë¡œ ê°•ì œ ë³€ê²½
                android_ndk = android_sdk + '/ndk/25.2.9519653'
                os.environ['ANDROID_NDK_ROOT'] = android_ndk
                os.environ['NDK_ROOT'] = android_ndk
                print(f"ğŸ”§ NDK 25ë¡œ ê°•ì œ ë³€ê²½: {android_ndk}")
            
            # p4a ëª…ë ¹ì–´ êµ¬ì„± (ìˆ˜ì •ëœ ë²„ì „)
            cmd = [
                'p4a', 'apk',
                '--private', '.',
                '--package', 'com.skku.timetable.doublecheck',
                '--name', 'DoubleCheck',
                '--version', '1.0',
                '--bootstrap', 'sdl2',
                '--requirements', 'python3,kivy==2.1.0,kivymd==1.1.1,requests,pillow,certifi,urllib3,charset-normalizer,plyer',
                '--arch', 'arm64-v8a',
                '--ndk-api', '21',
                '--sdk-dir', android_sdk,
                '--ndk-dir', android_ndk,
                '--release'
            ]
            
            # ê¶Œí•œë“¤ì„ ê°œë³„ì ìœ¼ë¡œ ì¶”ê°€ (ìˆ˜ì •ë¨ ğŸ”§)
            permissions = [
                'INTERNET',
                'WRITE_EXTERNAL_STORAGE', 
                'READ_EXTERNAL_STORAGE',
                'SCHEDULE_EXACT_ALARM',
                'USE_EXACT_ALARM',
                'VIBRATE',
                'WAKE_LOCK',
                'RECEIVE_BOOT_COMPLETED',
                'FOREGROUND_SERVICE',
                'POST_NOTIFICATIONS',
                'ACCESS_NOTIFICATION_POLICY',
                'SYSTEM_ALERT_WINDOW'
            ]
            
            for permission in permissions:
                cmd.extend(['--permission', permission])
            
            print(f"âœ… {len(permissions)}ê°œ ê¶Œí•œ ì¶”ê°€ë¨")
            
            # ì„ íƒì  íŒŒì¼ë“¤ ì¶”ê°€ (ìˆ˜ì •ë¨ ğŸ”§)
            # AndroidManifest.tmpl.xml ëŒ€ì‹  ê¶Œí•œì€ --permissionìœ¼ë¡œ ì´ë¯¸ ì²˜ë¦¬ë¨
            # if Path('AndroidManifest.tmpl.xml').exists():
            #     cmd.extend(['--extra-manifest-xml', 'AndroidManifest.tmpl.xml'])
            #     print("âœ… AndroidManifest.tmpl.xml ì¶”ê°€ë¨ (extra-manifest-xml)")
            print("ğŸ“‹ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í…œí”Œë¦¿ ìƒëµ (ê¶Œí•œì€ --permissionìœ¼ë¡œ ì²˜ë¦¬ë¨)")
            
            if Path('android/src/main/java').exists():
                cmd.extend(['--add-source', 'android/src/main/java'])
                print("âœ… Java ì†ŒìŠ¤ ë””ë ‰í† ë¦¬ ì¶”ê°€ë¨")
            
            if Path('android/libs').exists():
                jar_count = 0
                for jar_file in Path('android/libs').glob('*.jar'):
                    cmd.extend(['--add-jar', str(jar_file)])
                    jar_count += 1
                    print(f"âœ… JAR íŒŒì¼ ì¶”ê°€ë¨: {jar_file}")
                print(f"âœ… ì´ {jar_count}ê°œ JAR íŒŒì¼ ì¶”ê°€ë¨")
            
            print("\n=== ğŸ”¨ p4a ëª…ë ¹ì–´ ===")
            print(' '.join(cmd))
            print()
            
            # p4a ì‹¤í–‰
            try:
                print("=== ğŸ“‹ p4a ë¹Œë“œ ì‹¤í–‰ ì¤‘... ===")
                result = subprocess.run(cmd, text=True, capture_output=False)
                
                if result.returncode == 0:
                    print("\nâœ… APK ë¹Œë“œ ì„±ê³µ!")
                    
                    # APK íŒŒì¼ ì°¾ê¸°
                    apk_files = list(Path('.').glob('*.apk'))
                    if not apk_files:
                        # dist í´ë”ì—ì„œë„ ì°¾ì•„ë³´ê¸°
                        dist_apks = list(Path('.').glob('dist/*.apk'))
                        apk_files.extend(dist_apks)
                    
                    if apk_files:
                        for apk in apk_files:
                            print(f"ğŸ“± ìƒì„±ëœ APK: {apk}")
                            print(f"ğŸ“Š íŒŒì¼ í¬ê¸°: {apk.stat().st_size // (1024*1024)} MB")
                    else:
                        print("âš ï¸ APK íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
                        # p4a ì¶œë ¥ ë””ë ‰í† ë¦¬ì—ì„œ ì°¾ê¸°
                        print("ğŸ“‚ p4a ì¶œë ¥ ë””ë ‰í† ë¦¬ í™•ì¸ ì¤‘...")
                        p4a_dirs = list(Path.home().glob('.local/share/python-for-android/dists/*/bin/*.apk'))
                        for apk in p4a_dirs:
                            print(f"ğŸ“± p4a ë””ë ‰í† ë¦¬ì—ì„œ ë°œê²¬: {apk}")
                            # í˜„ì¬ ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
                            shutil.copy2(apk, f"./{apk.name}")
                            print(f"ğŸ“‹ ë³µì‚¬ ì™„ë£Œ: {apk.name}")
                    
                    return True
                else:
                    print(f"\nâŒ APK ë¹Œë“œ ì‹¤íŒ¨ (ì¢…ë£Œ ì½”ë“œ: {result.returncode})")
                    return False
                    
            except Exception as e:
                print(f"\nâŒ ë¹Œë“œ ì‹¤í–‰ ì˜¤ë¥˜: {e}")
                return False
        
        if __name__ == '__main__':
            success = main()
            sys.exit(0 if success else 1)
        EOF
        
        chmod +x build_apk.py
    
    - name: Check project structure
      run: |
        echo "=== ğŸ“‹ í”„ë¡œì íŠ¸ êµ¬ì¡° í™•ì¸ ==="
        echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
        echo ""
        echo "ì£¼ìš” íŒŒì¼ë“¤:"
        echo "  main.py: $([ -f "main.py" ] && echo "âœ…" || echo "âŒ")"
        echo "  AndroidManifest.tmpl.xml: $([ -f "AndroidManifest.tmpl.xml" ] && echo "âœ…" || echo "âŒ")"
        echo ""
        echo "Android ê´€ë ¨ íŒŒì¼ë“¤:"
        if [ -d "android" ]; then
          echo "  android/: âœ…"
          find android -type f -name "*.java" | head -5
          find android -type f -name "*.jar" | head -5
        else
          echo "  android/: âŒ"
        fi
        echo ""
        echo "ì „ì²´ íŒŒì¼ ëª©ë¡ (ìƒìœ„ 20ê°œ):"
        find . -type f | head -20
    
    - name: Build APK
      run: |
        echo "=== ğŸ—ï¸ APK ë¹Œë“œ ì‹œì‘ ==="
        python build_apk.py
    
    - name: Verify build results
      run: |
        echo "=== ğŸ” ë¹Œë“œ ê²°ê³¼ í™•ì¸ ==="
        
        # APK íŒŒì¼ í™•ì¸
        echo "ìƒì„±ëœ APK íŒŒì¼ë“¤:"
        find . -name "*.apk" -type f -exec ls -lh {} \;
        
        # p4a ë¹Œë“œ ë””ë ‰í† ë¦¬ í™•ì¸
        echo ""
        echo "p4a ë¹Œë“œ ë””ë ‰í† ë¦¬:"
        P4A_BUILD_DIR=$(find ~/.local/share/python-for-android -name "dists" -type d 2>/dev/null | head -1)
        if [ -n "$P4A_BUILD_DIR" ]; then
          echo "ë¹Œë“œ ë””ë ‰í† ë¦¬: $P4A_BUILD_DIR"
          ls -la "$P4A_BUILD_DIR/" || true
          
          # APK íŒŒì¼ ì°¾ê¸° ë° ë³µì‚¬
          echo "p4a ë””ë ‰í† ë¦¬ì—ì„œ APK íŒŒì¼ ì°¾ëŠ” ì¤‘..."
          find "$P4A_BUILD_DIR" -name "*.apk" -type f -exec cp {} . \; -exec echo "ğŸ“± ë³µì‚¬ë¨: {}" \;
        fi
        
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ í™•ì¸
        echo ""
        echo "AndroidManifest.xml í™•ì¸:"
        MANIFEST_FILE=$(find ~/.local/share/python-for-android -name "AndroidManifest.xml" -type f 2>/dev/null | head -1)
        if [ -n "$MANIFEST_FILE" ]; then
          echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼: $MANIFEST_FILE"
          echo "ê¶Œí•œ ê°œìˆ˜: $(grep -c 'uses-permission' "$MANIFEST_FILE" 2>/dev/null || echo "0")"
          echo "ì„œë¹„ìŠ¤ ê°œìˆ˜: $(grep -c 'service' "$MANIFEST_FILE" 2>/dev/null || echo "0")"
          echo "ë¦¬ì‹œë²„ ê°œìˆ˜: $(grep -c 'receiver' "$MANIFEST_FILE" 2>/dev/null || echo "0")"
        fi
        
        # ìµœì¢… APK íŒŒì¼ ëª©ë¡
        echo ""
        echo "=== ğŸ“± ìµœì¢… APK íŒŒì¼ ëª©ë¡ ==="
        ls -lh *.apk 2>/dev/null || echo "âŒ APK íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
    
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: kivy-android-apk
        path: "*.apk"
        retention-days: 30
        if-no-files-found: warn
    
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/.local/share/python-for-android/build.log
          ~/.local/share/python-for-android/*/build.log
        retention-days: 7
        if-no-files-found: ignore
